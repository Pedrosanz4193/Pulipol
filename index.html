<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PULIPOL - Sistema de Capacitación Policial</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&amp;family=Share+Tech+Mono&amp;display=swap" rel="stylesheet">
<style>
  /* Variables CSS para una paleta policial oscura y tecnológica */
  :root {
    --color-bg-dark: #0A0A0E; /* Fondo muy oscuro, casi negro */
    --color-bg-medium: #1A1A22; /* Fondo de contenedores principales */
    --color-bg-light: #2A2A38; /* Fondo de elementos secundarios, inputs */
    --color-primary-blue: #007BFF; /* Azul distintivo para interacción/resaltado */
    --color-accent-red: #DC3545; /* Rojo para alertas/errores */
    --color-accent-green: #28A745; /* Verde para éxito */
    --color-text-light: #E0E6EB; /* Texto claro general */
    --color-text-muted: #8F9BB3; /* Texto secundario, descripciones */
    --color-border: #3A3A48; /* Bordes sutiles */
    --color-border-active: #007BFF; /* Borde activo/foco */
    --color-glow: rgba(0, 123, 255, 0.4); /* Resplandor azul */
    --color-shadow: rgba(0, 0, 0, 0.6); /* Sombra de elementos */
    --color-overlay: rgba(0, 0, 0, 0.8); /* Overlay oscuro */
  }

  /* Reset y estilos base */
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  html, body {
    height: 100%;
    overflow: hidden; /* Controlar el desbordamiento principal */
  }

  body {
    font-family: 'Share Tech Mono', monospace; /* Fuente monospace para un toque tech */
    background: radial-gradient(circle at top left, var(--color-bg-medium) 0%, var(--color-bg-dark) 70%);
    color: var(--color-text-light);
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 1rem;
    position: relative;
    overflow-y: auto; /* Permitir scroll solo si el contenido excede la altura */
  }

  /* Efecto de ruido de fondo sutil */
  body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: url('data:image/svg+xml;base64,PHN2ZyB2aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZmlsdGVyIGlkPSJuIj48ZmVUdXJibHVuY2UgdHlwZT0iZnJhY3RhbE5vaXNlIiBiYXNlRnJlcXVlbmN5PSIuNSIgbnVtT2N0YXZlcz0iMyIgc2VhbT0idHJ1ZSIgbGltaXRpbmc9IjEiLz48d2VzRGlmZnVzZSB4PSIxMDAiIHk9IjEwMCIgcmVzdWx0PSJpIi8+PHBhdGggZD0iTTAgMGgyMDB2LTIwMGgyMDB2LTIwMCIvPjwvZmlsdGVyPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9IiMwMDAiIGZpbHRlcj0idXJsKCNuKSIgb3BhY2l0eT0iLjEiLz48L3N2Zz4=') repeat;
    opacity: 0.1;
    pointer-events: none;
    z-index: -1;
  }

  /* Contenedor principal de pantallas */
  .screen {
    background: var(--color-bg-medium);
    border: 2px solid var(--color-border);
    border-radius: 8px;
    box-shadow: 0 0 20px var(--color-shadow), inset 0 0 15px rgba(0, 123, 255, 0.05);
    padding: 2.5rem;
    width: clamp(320px, 95vw, 700px); /* Ancho adaptable */
    max-height: 95vh;
    overflow-y: auto; /* Scrollable if content overflows */
    text-align: center;
    position: relative;
    transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
    transform-origin: center center;
  }

  .hidden {
    opacity: 0;
    transform: scale(0.9) translateY(20px);
    pointer-events: none;
    position: absolute; /* Para que no ocupe espacio cuando está oculto */
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%) scale(0.9);
  }

  /* Título de la aplicación */
  h1 {
    font-family: 'Orbitron', sans-serif;
    font-size: clamp(2.5rem, 8vw, 4.5rem); /* Título responsive */
    color: var(--color-primary-blue);
    text-shadow: 0 0 15px var(--color-glow);
    margin-bottom: 2.5rem;
    letter-spacing: 3px;
    line-height: 1.1;
  }

  /* Estilos de botones generales */
  button {
    background: var(--color-primary-blue);
    color: var(--color-text-light);
    border: none;
    padding: 0.8rem 1.8rem;
    border-radius: 6px;
    font-family: 'Orbitron', sans-serif;
    font-size: 1.1rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 1px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
  }

  button:hover:not(:disabled) {
    background: #0056B3;
    box-shadow: 0 6px 15px var(--color-glow);
    transform: translateY(-2px);
  }

  button:active:not(:disabled) {
    transform: translateY(0);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
  }

  button:disabled {
    background: var(--color-bg-light);
    color: var(--color-text-muted);
    cursor: not-allowed;
    box-shadow: none;
    transform: none;
    opacity: 0.7;
  }

  /* Input fields */
  input[type="text"],
  input[type="password"],
  input[type="number"],
  #chatMessageInput {
    width: 100%;
    padding: 0.9rem 1.2rem;
    margin-bottom: 1.2rem;
    border-radius: 6px;
    border: 1px solid var(--color-border);
    background: var(--color-bg-light);
    color: var(--color-text-light);
    font-family: 'Share Tech Mono', monospace;
    font-size: 1rem;
    outline: none;
    transition: border-color 0.3s, box-shadow 0.3s;
    box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.4);
  }

  input[type="text"]:focus,
  input[type="password"]:focus,
  input[type="number"]:focus,
  #chatMessageInput:focus {
    border-color: var(--color-border-active);
    box-shadow: 0 0 0 3px var(--color-glow), inset 0 2px 5px rgba(0, 0, 0, 0.6);
  }

  /* Mensajes de error */
  .error-message {
    color: var(--color-accent-red);
    font-weight: bold;
    margin-top: -0.8rem;
    margin-bottom: 1.2rem;
    min-height: 1.5em; /* Previene saltos de diseño */
  }

  /* --- Topbar de Pantallas Secundarias (Menú, Juego, Estadísticas, etc.) --- */
  .topbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(90deg, #004D99, var(--color-primary-blue));
    padding: 1rem 1.5rem;
    border-bottom: 2px solid #003366;
    border-radius: 6px 6px 0 0;
    margin: -2.5rem -2.5rem 2rem -2.5rem; /* Ajuste para que se extienda a los bordes del .screen */
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
    flex-wrap: wrap;
    gap: 0.8rem;
  }

  .topbar .welcome-text,
  .topbar h2 {
    font-family: 'Orbitron', sans-serif;
    font-size: clamp(1.2rem, 4vw, 1.8rem);
    color: var(--color-text-light);
    text-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
    margin: 0;
  }
  .topbar h2 {
      flex-grow: 1; /* Permite que el título crezca */
      text-align: left;
  }


  .topbar button {
    background: var(--color-accent-red);
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
  }
  .topbar button:hover {
    background: #A0202E;
  }

  /* --- Pantalla de Menú --- */
  #menuScreen .game-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Columnas responsivas */
    gap: 1.5rem;
    padding-top: 1rem; /* Espacio debajo del topbar */
  }

  .game-card {
    background: var(--color-bg-light);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    padding: 1.5rem;
    text-align: left;
    display: flex;
    align-items: center;
    gap: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
    position: relative;
    overflow: hidden;
  }

  .game-card::before { /* Efecto de borde animado */
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border-radius: 8px;
    border: 2px solid transparent;
    transition: border-color 0.3s ease;
    pointer-events: none;
  }

  .game-card:hover::before {
    border-color: var(--color-primary-blue);
  }

  .game-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px var(--color-shadow), 0 0 15px var(--color-glow);
  }

  .game-card .icon {
    font-size: 2.5rem;
    line-height: 1;
    color: var(--color-primary-blue);
    text-shadow: 0 0 8px var(--color-glow);
  }

  .game-card .content .title {
    font-family: 'Orbitron', sans-serif;
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: 0.3rem;
    color: var(--color-text-light);
  }

  .game-card .content p {
    font-size: 0.9rem;
    color: var(--color-text-muted);
  }

  /* --- Pantalla de Juego/Test --- */
  #gameScreen .topbar {
    justify-content: space-between;
  }
  #gameScreen .timer {
    font-family: 'Orbitron', sans-serif;
    font-size: 1.8rem;
    color: var(--color-accent-red);
    text-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
    margin-left: 1rem;
  }

  #gameContent {
    padding-top: 1rem;
  }

  #questionText {
    background: var(--color-bg-light);
    border: 1px solid var(--color-border);
    border-left: 5px solid var(--color-primary-blue); /* Barra de énfasis */
    border-radius: 6px;
    padding: 1.5rem 1rem;
    margin-bottom: 2rem;
    font-size: 1.15rem;
    line-height: 1.6;
    text-align: left;
    min-height: 120px;
    display: flex;
    align-items: center;
  }

  #choicesContainer {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 0.8rem;
    margin-bottom: 1.5rem;
  }

  #choicesContainer button {
    background: var(--color-bg-light);
    color: var(--color-text-light);
    border: 1px solid var(--color-border);
    padding: 1rem 1.2rem;
    font-size: 1rem;
    font-family: 'Share Tech Mono', monospace;
    text-transform: none; /* No UPPERCASE para las opciones */
    transition: background 0.2s, border-color 0.2s, box-shadow 0.2s;
  }

  #choicesContainer button:hover:not(:disabled) {
    background: #3A3A48;
    border-color: var(--color-primary-blue);
    box-shadow: 0 0 8px var(--color-glow);
    transform: none; /* No lift up */
  }

  #choicesContainer button.correct {
    background: var(--color-accent-green);
    border-color: var(--color-accent-green);
    box-shadow: 0 0 10px rgba(40, 167, 69, 0.6);
  }
  #choicesContainer button.incorrect {
    background: var(--color-accent-red);
    border-color: var(--color-accent-red);
    box-shadow: 0 0 10px rgba(220, 53, 69, 0.6);
  }
  #choicesContainer button.correct::before,
  #choicesContainer button.incorrect::before {
    font-family: 'Share Tech Mono', monospace; /* Para los iconos del check/cross */
    margin-right: 0.5em;
  }

  #resultMessage {
    font-size: 1.1rem;
    font-weight: bold;
    color: var(--color-accent-green); /* Por defecto verde, se cambia a rojo para incorrecto */
    margin-top: 1rem;
    min-height: 1.5em;
    text-shadow: 0 0 8px rgba(40, 167, 69, 0.4);
  }
  #resultMessage.incorrect {
      color: var(--color-accent-red);
      text-shadow: 0 0 8px rgba(220, 53, 69, 0.4);
  }

  #finalScore {
    font-family: 'Orbitron', sans-serif;
    font-size: 2rem;
    color: var(--color-primary-blue);
    text-shadow: 0 0 15px var(--color-glow);
    margin-top: 1.5rem;
    font-weight: 700;
  }

  #navButtons {
    display: flex;
    justify-content: space-between;
    gap: 1rem;
    margin-top: 2rem;
  }

  #navButtons button {
    flex: 1;
    background: var(--color-bg-light);
    border: 1px solid var(--color-border);
    color: var(--color-primary-blue);
    font-size: 1rem;
    padding: 0.8rem 1.5rem;
  }

  #navButtons button:hover:not(:disabled) {
    background: var(--color-primary-blue);
    color: var(--color-text-light);
    border-color: var(--color-primary-blue);
    box-shadow: 0 0 10px var(--color-glow);
  }
  #navButtons button:disabled {
      background: var(--color-bg-light);
      color: var(--color-text-muted);
      border-color: var(--color-border);
  }


  /* --- Pantalla de Estadísticas --- */
  #statsContent {
    text-align: left;
  }
  #statsContent h3 {
    font-family: 'Orbitron', sans-serif;
    font-size: 1.4rem;
    color: var(--color-primary-blue);
    border-bottom: 1px solid var(--color-border);
    padding-bottom: 0.5rem;
    margin-top: 1.5rem;
    margin-bottom: 1rem;
    text-shadow: 0 0 5px var(--color-glow);
  }
  #statsContent ul {
    list-style: none;
    padding: 0;
  }
  #statsContent li {
    background: var(--color-bg-light);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    padding: 0.8rem 1rem;
    margin-bottom: 0.6rem;
    font-size: 0.95rem;
    line-height: 1.4;
    position: relative;
    overflow: hidden;
  }
  #statsContent li::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 4px;
    background-color: var(--color-accent-red); /* Barra roja para fallos */
  }
  #statsContent .no-data {
    color: var(--color-text-muted);
    font-style: italic;
    text-align: center;
    padding: 2rem 0;
  }

  /* --- Pantalla de Generar Test --- */
  #generateTestScreen .form-container {
    text-align: left;
  }
  #generateTestScreen label {
    display: block;
    margin-bottom: 0.6rem;
    font-size: 1rem;
    color: var(--color-text-light);
  }
  #generateTestScreen .checkbox-group {
    margin-bottom: 1.5rem;
  }
  #generateTestScreen .checkbox-group label {
    display: inline-flex;
    align-items: center;
    margin-right: 1.5rem;
    margin-bottom: 0.5rem;
    cursor: pointer;
    font-size: 0.95rem;
  }
  #generateTestScreen .checkbox-group input[type="checkbox"] {
    appearance: none; /* Ocultar checkbox nativo */
    width: 18px;
    height: 18px;
    border: 1px solid var(--color-border);
    border-radius: 3px;
    background-color: var(--color-bg-light);
    margin-right: 0.6rem;
    cursor: pointer;
    position: relative;
    transition: all 0.2s ease;
    flex-shrink: 0;
  }
  #generateTestScreen .checkbox-group input[type="checkbox"]:checked {
    background-color: var(--color-primary-blue);
    border-color: var(--color-primary-blue);
    box-shadow: 0 0 5px var(--color-glow);
  }
  #generateTestScreen .checkbox-group input[type="checkbox"]:checked::after {
    content: '✔';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 14px;
    line-height: 1;
  }
  #generateTestBtn {
    background: var(--color-accent-green);
    width: 100%;
    margin-top: 2rem;
    padding: 1rem;
    font-size: 1.2rem;
  }
  #generateTestBtn:hover {
    background: #1D7A39;
    box-shadow: 0 6px 15px rgba(40, 167, 69, 0.6);
  }

  /* --- Pantalla de Chat Login & Chat Grupal --- */
  #chatLoginScreen .form-group {
    text-align: left;
  }
  #connectChatBtn {
    background: var(--color-accent-green);
    width: 100%;
    margin-top: 2rem;
    padding: 1rem;
    font-size: 1.2rem;
  }
  #connectChatBtn:hover {
    background: #1D7A39;
    box-shadow: 0 6px 15px rgba(40, 167, 69, 0.6);
  }

  #groupChatScreen {
    width: clamp(320px, 95vw, 800px); /* Chat más ancho */
  }

  #chatMessages {
    background: #101015; /* Fondo del área de chat */
    border: 1px solid var(--color-border);
    border-radius: 6px;
    height: 400px;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.7rem;
    margin-bottom: 1rem;
    box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
  }

  .chat-message {
    background: var(--color-bg-light);
    padding: 0.8rem 1.2rem;
    border-radius: 12px;
    max-width: 85%;
    word-wrap: break-word;
    font-size: 0.95rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    border: 1px solid var(--color-border);
  }
  .chat-message.own-message {
    align-self: flex-end;
    background: var(--color-primary-blue);
    color: white;
    border-top-right-radius: 4px; /* Un poco menos redondeado */
  }
  .chat-message.other-message {
    align-self: flex-start;
    background: #3A3A48; /* Otro tono de fondo */
    color: var(--color-text-light);
    border-top-left-radius: 4px; /* Un poco menos redondeado */
  }
  .message-sender {
    font-weight: bold;
    color: var(--color-primary-blue);
    margin-bottom: 0.3rem;
    display: block;
    font-size: 0.8em;
    text-shadow: 0 0 5px var(--color-glow);
  }
  .chat-message.own-message .message-sender {
      color: var(--color-text-light); /* En mensajes propios, el sender es blanco */
      text-shadow: none;
  }
  .chat-input-area {
    display: flex;
    gap: 0.8rem;
    padding-top: 0.5rem;
  }

  #sendChatMessageBtn {
    background: var(--color-primary-blue);
    padding: 0.8rem 1.5rem;
    font-size: 1rem;
    border-radius: 6px;
    text-transform: uppercase;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    body {
      padding: 0.8rem;
      align-items: flex-start; /* Alinea arriba en móviles si hay scroll */
    }
    .screen {
      padding: 1.5rem;
      border-width: 1px;
      margin-top: 1rem;
      margin-bottom: 1rem;
      max-height: calc(100vh - 2rem); /* Ajusta altura máxima */
    }
    h1 {
      font-size: clamp(2rem, 10vw, 3.5rem);
      margin-bottom: 2rem;
    }
    .topbar {
      margin: -1.5rem -1.5rem 1.5rem -1.5rem;
      padding: 0.8rem 1rem;
    }
    .topbar .welcome-text,
    .topbar h2 {
      font-size: clamp(1rem, 5vw, 1.4rem);
    }
    .topbar button {
      padding: 0.4rem 0.8rem;
      font-size: 0.8rem;
    }
    button {
      padding: 0.7rem 1.5rem;
      font-size: 1rem;
    }
    input {
      padding: 0.8rem 1rem;
      font-size: 0.95rem;
    }
    .game-card {
      flex-direction: column;
      align-items: flex-start;
      text-align: center; /* Alinea el texto en el centro si el icono está arriba */
      padding: 1rem;
      gap: 0.8rem;
    }
    .game-card .icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    .game-card .content {
        width: 100%; /* El contenido ocupa todo el ancho restante */
        text-align: left; /* Asegura que el texto esté alineado a la izquierda */
    }
    .game-card .content .title {
      font-size: 1.1rem;
    }
    .game-card .content p {
      font-size: 0.85rem;
    }

    #questionText {
      font-size: 1.05rem;
      padding: 1rem;
      min-height: 90px;
    }
    #choicesContainer button {
      font-size: 0.9rem;
      padding: 0.8rem;
    }
    #finalScore {
      font-size: 1.6rem;
    }
    #navButtons {
      flex-direction: column;
      gap: 0.6rem;
      margin-top: 1.5rem;
    }
    #navButtons button {
      font-size: 0.9rem;
      padding: 0.7rem;
    }
    #statsContent h3 {
      font-size: 1.2rem;
    }
    #statsContent li {
      font-size: 0.85rem;
      padding: 0.6rem 0.8rem;
    }
    #generateTestBtn, #connectChatBtn {
      font-size: 1.1rem;
      padding: 0.9rem;
    }
    #chatMessages {
      height: 300px;
      padding: 0.8rem;
    }
    .chat-input-area {
      flex-direction: column;
      gap: 0.5rem;
    }
    #chatMessageInput {
      margin-bottom: 0;
    }
    #sendChatMessageBtn {
      width: 100%;
      padding: 0.7rem;
      font-size: 0.9rem;
    }
  }

  /* Keyframe animations */
  @keyframes fadeInScale {
    from {
      opacity: 0;
      transform: scale(0.9) translateY(20px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }
  .screen:not(.hidden) {
    animation: fadeInScale 0.5s cubic-bezier(0.25, 0.8, 0.25, 1) forwards;
  }

</style>
</head>
<body>
  <div id="loginScreen" class="screen">
    <h1>PULIPOL</h1>
    <input type="text" id="usernameInput" placeholder="Usuario">
    <input type="password" id="passwordInput" placeholder="Contraseña">
    <p id="loginError" class="error-message"></p>
    <button id="loginBtn">ACCEDER AL SISTEMA</button>
  </div>

  <div id="menuScreen" class="screen hidden">
    <div class="topbar">
      <span class="welcome-text">Bienvenido a Pulipol</span>
      <button id="logoutBtn">Cerrar Sesión</button>
    </div>
    <div class="game-list">
      <div class="game-card" id="gameJefeDirector" tabindex="0">
        <span class="icon">👮‍♂️</span>
        <div class="content">
          <span class="title">Jefe y Director de Seguridad Privada</span>
          <p>Pon a prueba tus conocimientos sobre roles de seguridad.</p>
        </div>
      </div>
      <div class="game-card" id="gameLOEX" tabindex="0">
        <span class="icon">⚖️</span>
        <div class="content">
          <span class="title">Infracciones LOEX</span>
          <p>Identifica el tipo de infracción según la LOEX.</p>
        </div>
      </div>
      <div class="game-card" id="gameLO42010" tabindex="0">
        <span class="icon">📜</span>
        <div class="content">
          <span class="title">Infracciones L.O 4/2010</span>
          <p>Identifica las infracciones según la Ley Orgánica 4/2010.</p>
        </div>
      </div>
      <div class="game-card" id="gameStats" tabindex="0">
        <span class="icon">📈</span>
        <div class="content">
          <span class="title">Estadísticas de Fallos</span>
          <p>Revisa las preguntas que has fallado para mejorar.</p>
        </div>
      </div>
      <div class="game-card" id="gameGenerateTest" tabindex="0">
        <span class="icon">📝</span>
        <div class="content">
          <span class="title">Generar Test Personalizado</span>
          <p>Crea exámenes a medida con tus propios ajustes.</p>
        </div>
      </div>
      <div class="game-card" id="gameChat" tabindex="0">
        <span class="icon">💬</span>
        <div class="content">
          <span class="title">Chat de Operaciones (Simulado)</span>
          <p>Conéctate a una sala de chat segura para coordinar.</p>
        </div>
      </div>
    </div>
  </div>

  <div id="gameScreen" class="screen hidden">
    <div class="topbar">
      <h2 id="gameTitle"></h2>
      <span id="timerDisplay" class="timer hidden">00:00</span>
      <button id="backToMenuBtn">Menú</button>
    </div>
    <div id="gameContent">
      <p id="questionText"></p>
      <div id="choicesContainer">
        </div>
      <p id="resultMessage"></p>
      <p id="finalScore" class="hidden"></p>
      <div id="navButtons">
        <button id="prevBtn">← ANTERIOR</button>
        <button id="nextBtn">SIGUIENTE →</button>
      </div>
    </div>
  </div>

  <div id="statsScreen" class="screen hidden">
    <div class="topbar">
      <h2>Registro de Errores</h2>
      <button id="backToMenuFromStatsBtn">Menú</button>
    </div>
    <div id="statsContent">
      </div>
  </div>

  <div id="generateTestScreen" class="screen hidden">
    <div class="topbar">
      <h2>Configuración de Prueba</h2>
      <button id="backToMenuFromGenerateTestBtn">Menú</button>
    </div>
    <div class="form-container">
      <div class="form-group">
        <label>Selecciona módulos de evaluación:</label>
        <div class="checkbox-group">
          <label><input type="checkbox" id="jefeDirectorCheckbox"> Jefe y Director de Seguridad</label>
          <label><input type="checkbox" id="loexCheckbox"> Infracciones LOEX</label>
          <label><input type="checkbox" id="lo42010Checkbox"> Infracciones L.O 4/2010</label>
        </div>
      </div>
      <div class="form-group">
        <label for="numQuestions">Número de preguntas:</label>
        <input type="number" id="numQuestions" value="10" min="1">
      </div>
      <div class="form-group">
        <label for="testTime">Tiempo límite (minutos):</label>
        <input type="number" id="testTime" value="10" min="1">
      </div>
      <p id="generateTestError" class="error-message"></p>
      <div class="button-container">
        <button id="generateTestBtn">INICIAR EVALUACIÓN</button>
      </div>
    </div>
  </div>

  <div id="chatLoginScreen" class="screen hidden">
    <div class="topbar">
      <h2>Acceso al Chat de Operaciones</h2>
      <button id="backToMenuFromChatLoginBtn">Menú</button>
    </div>
    <div class="form-group">
      <label for="chatUsernameInput">Identificador de Agente:</label>
      <input type="text" id="chatUsernameInput" placeholder="Ej: Agente_007">
    </div>
    <p id="chatLoginError" class="error-message"></p>
    <button id="connectChatBtn">CONECTAR</button>
  </div>

  <div id="groupChatScreen" class="screen hidden">
    <div class="topbar">
      <h2>Comunicación Segura <span class="badge">ACTIVO</span></h2>
      <button id="backToMenuFromGroupChatBtn">Menú</button>
    </div>
    <div id="chatMessages">
      </div>
    <div class="chat-input-area">
      <input type="text" id="chatMessageInput" placeholder="Escriba aquí su informe...">
      <button id="sendChatMessageBtn">ENVIAR</button>
    </div>
  </div>

<script>
  (() => {
  'use strict';

  // --- Elementos del DOM ---
  const loginScreen = document.getElementById('loginScreen');
  const usernameInput = document.getElementById('usernameInput');
  const passwordInput = document.getElementById('passwordInput');
  const loginBtn = document.getElementById('loginBtn');
  const loginError = document.getElementById('loginError');

  // Logs para depuración inicial de elementos
  console.log('DEBUG: loginScreen:', loginScreen);
  console.log('DEBUG: usernameInput:', usernameInput);
  console.log('DEBUG: passwordInput:', passwordInput);
  console.log('DEBUG: loginBtn:', loginBtn);
  console.log('DEBUG: loginError:', loginError);

  const menuScreen = document.getElementById('menuScreen');
  const logoutBtn = document.getElementById('logoutBtn');
  const gameJefeDirectorCard = document.getElementById('gameJefeDirector');
  const gameLOEXCard = document.getElementById('gameLOEX'); // CORREGIDO: Eliminado el 'document =' extra
  const gameLO42010Card = document.getElementById('gameLO42010');
  const gameStatsCard = document.getElementById('gameStats');
  const gameGenerateTestCard = document.getElementById('gameGenerateTest');
  const gameChatCard = document.getElementById('gameChat');

  const gameScreen = document.getElementById('gameScreen');
  const gameTitleDisplay = document.getElementById('gameTitle');
  const backToMenuBtn = document.getElementById('backToMenuBtn');
  const timerDisplay = document.getElementById('timerDisplay');
  const questionText = document.getElementById('questionText');
  const choicesContainer = document.getElementById('choicesContainer');
  const resultMessage = document.getElementById('resultMessage');
  const finalScoreDisplay = document.getElementById('finalScore');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');

  const statsScreen = document.getElementById('statsScreen');
  const backToMenuFromStatsBtn = document.getElementById('backToMenuFromStatsBtn');
  const statsContent = document.getElementById('statsContent');

  const generateTestScreen = document.getElementById('generateTestScreen');
  const backToMenuFromGenerateTestBtn = document.getElementById('backToMenuFromGenerateTestBtn');
  const jefeDirectorCheckbox = document.getElementById('jefeDirectorCheckbox');
  const loexCheckbox = document.getElementById('loexCheckbox');
  const lo42010Checkbox = document.getElementById('lo42010Checkbox');
  const numQuestionsInput = document.getElementById('numQuestions');
  const testTimeInput = document.getElementById('testTime');
  const generateTestBtn = document.getElementById('generateTestBtn');
  const generateTestError = document.getElementById('generateTestError');

  const chatLoginScreen = document.getElementById('chatLoginScreen');
  const backToMenuFromChatLoginBtn = document.getElementById('backToMenuFromChatLoginBtn');
  const chatUsernameInput = document.getElementById('chatUsernameInput');
  const connectChatBtn = document.getElementById('connectChatBtn');
  const chatLoginError = document.getElementById('chatLoginError');

  const groupChatScreen = document.getElementById('groupChatScreen');
  const backToMenuFromGroupChatBtn = document.getElementById('backToMenuFromGroupChatBtn');
  const chatMessagesContainer = document.getElementById('chatMessages');
  const chatMessageInput = document.getElementById('chatMessageInput');
  const sendChatMessageBtn = document.getElementById('sendChatMessageBtn');

  // --- Variables de Estado del Juego ---
  let loggedInUser = null;
  let currentScreen = null; // Se inicializará en showLogin
  let currentGameType = null;
  let currentQuestions = [];
  let currentQuestionIndex = 0;
  let userAnswers = {}; // {questionIndex: selectedChoiceIndex}
  let correctAnswersCount = 0;
  let quizStartTime = 0;
  let quizInterval = null;
  let incorrectQuestionsStats = JSON.parse(localStorage.getItem('incorrectQuestionsStats')) || {};
  let chatUsername = null;
  let chatMessages = []; // For simulated chat

  // --- Datos de los Juegos ---
  const gameData = {
    jefeDirector: {
      title: "Jefe y Director de Seguridad Privada",
      questions: [
        ["Supervisar la seguridad de las instalaciones y personal", "Jefe"],
        ["Tomar decisiones estratégicas a nivel organizativo", "Director"],
        ["Coordinar equipos de seguridad en situaciones de riesgo", "Jefe"],
        ["Definir políticas y normativas internas", "Director"],
        ["Gestionar conflictos internos y externos relacionados con la seguridad", "Jefe"],
        ["Representar a la empresa en reuniones de alto nivel", "Director"],
        ["Elaborar informes de seguridad y auditorías", "Jefe"],
        ["Desarrollar planes de contingencia y emergencia", "Director"],
        ["Implementar medidas de seguridad física", "Jefe"],
        ["Establecer alianzas estratégicas con otras organizaciones", "Director"],
        ["Investigar incidentes de seguridad y proponer soluciones", "Jefe"],
        ["Gestionar el presupuesto del área de seguridad", "Director"],
        ["Formar y capacitar al personal de seguridad", "Jefe"],
        ["Evaluar riesgos y vulnerabilidades de la organización", "Director"],
        ["Mantener la disciplina y el orden del personal a su cargo", "Jefe"],
        ["Diseñar la estructura del departamento de seguridad", "Director"]
      ],
      choices: ["Jefe", "Director"]
    },
    loex: {
      title: "Infracciones LOEX",
      questions: [
        // INFRACCIONES LEVES
        ["La omisión o el retraso en la comunicación a las autoridades españolas de los cambios de nacionalidad, estado civil o de domicilio, así como de otras circunstancias determinantes de su situación laboral cuando les sean exigibles por la normativa aplicable.", "Leve"],
        ["El retraso, hasta tres meses, en la solicitud de renovación de las autorizaciones una vez hayan caducado.", "Leve"],
        ["Encontrarse trabajando en España sin haber solicitado autorización administrativa para trabajar por cuenta propia, cuando se cuente con autorización de residencia temporal.", "Leve"],
        ["Encontrarse trabajando en una ocupación, sector de actividad, o ámbito geográfico no contemplado por la autorización de residencia y trabajo de la que se es titular.", "Leve"],
        ["La contratación de personas trabajadoras cuya autorización no les habilita para trabajar en esa ocupación o ámbito geográfico, incurriéndose en una infracción por cada una de las personas trabajadoras extranjeras ocupadas.", "Leve"],
        ["La ausencia de comunicación a la autoridad pública por parte de las entidades cuyo objeto se refiera total o parcialmente a la atención de personas menores de edad extranjeras no acompañadas, así como de las personas que actúen en su representación o encuadradas en su actividad de manera habitual, de la localización de personas menores de edad extranjeras no acompañadas a fin de que pueda procederse en consecuencia.", "Leve"],
        ["La no presentación injustificada, sin causa o razón válida, a los requerimientos de la Delegación o Subdelegación del Gobierno por parte de la persona extranjera interesada, y que se realice de forma reiterada, tras dos notificaciones debidamente practicadas en las que no se haya obtenido respuesta. Se entenderá que existe una razón válida para la no comparecencia cuando la persona interesada acredite de forma fehaciente una circunstancia que imposibilite su presencia o justifique que la misma no es obligatoria. En todo caso, la carga de la prueba corresponderá a la persona interesada.", "Leve"],
        ["La inobservancia de la obligación de poner en conocimiento de la autoridad competente el extravío, la destrucción, la sustracción o la inutilización del pasaporte o documento de viaje, del visado, de la Tarjeta de Identidad de Extranjero o de cualquier otro documento análogo, siempre que de ello no se derive perjuicio grave para el servicio público o para la acreditación de la identidad de la persona interesada.", "Leve"],
        ["La inobservancia de la obligación de comunicar a la autoridad competente la pérdida, extravío o inutilización del pasaporte o documento de viaje, del visado, de la Tarjeta de Identidad de Extranjero o de cualquier otro documento análogo, así como no denunciar la sustracción de los mismos. El incumplimiento de esta obligación cuando dé lugar a un perjuicio grave para la seguridad pública, podrá dar lugar a la calificación de la infracción como grave o muy grave, en función de la gravedad de los hechos.", "Leve"],
        ["La omisión o el retraso en la comunicación a la autoridad pública de los cambios de nacionalidad, estado civil o de domicilio, así como de otras circunstancias determinantes de su situación laboral cuando les sean exigibles por la normativa aplicable.", "Leve"],
        // INFRACCIONES GRAVES
        ["Encontrarse irregularmente en territorio español, por no haber obtenido la prórroga de estancia, carecer de autorización de residencia o tener caducada más de tres meses la mencionada autorización, y siempre que la persona interesada no hubiere solicitado la renovación de la misma en el plazo previsto reglamentariamente.", "Grave"],
        ["Encontrarse trabajando en España sin haber obtenido autorización de trabajo o autorización administrativa previa para trabajar, cuando no cuente con autorización de residencia válida.", "Grave"],
        ["Incurrir en ocultación dolosa o falsedad grave en el cumplimiento de la obligación de poner en conocimiento de las autoridades competentes los cambios que afecten a nacionalidad, estado civil o domicilio, así como incurrir en falsedad en la declaración de los datos obligatorios para cumplimentar el alta en el padrón municipal, siempre que tales hechos no constituyan delito. Cuando cualquier autoridad tuviera conocimiento de una posible infracción por esta causa, lo pondrá en conocimiento de las autoridades competentes con el fin de que pueda instruirse el oportuno expediente sancionador.", "Grave"],
        ["El incumplimiento de las medidas impuestas por razón de seguridad pública, de presentación periódica o de alejamiento de fronteras o núcleos de población concretados singularmente.", "Grave"],
        ["La comisión de una tercera infracción leve, siempre que la persona extranjera hubiera sido sancionada por dos infracciones leves anteriores, en el plazo de un año. Se entenderá que existe reincidencia cuando la persona extranjera hubiera sido sancionada por dos infracciones leves anteriores, siempre que no hayan transcurrido más de seis meses desde la última sanción y que la nueva infracción no hubiera prescrito.", "Grave"],
        ["El ocultamiento de información o la falsedad en la declaración de los datos relativos a la situación laboral de las personas trabajadoras extranjeras, a fin de obtener los beneficios previstos en esta ley para las personas empleadoras.", "Grave"],
        ["Simular la relación laboral para obtener una autorización de residencia o la prórroga de la misma, o para obtener una autorización de trabajo, ya sea por cuenta propia o ajena.", "Grave"],
        ["La falsedad en el padrón municipal de las personas extranjeras, con el fin de obtener algún beneficio de la Ley, o de dificultar su aplicación. Cuando cualquier autoridad tuviera conocimiento de una posible infracción por esta causa, lo pondrá en conocimiento de las autoridades competentes con el fin de que pueda instruirse el oportuno expediente sancionador.", "Grave"],
        ["No dar de alta a la persona trabajadora extranjera en el régimen correspondiente de la Seguridad Social, cuando así se establezca en la normativa de aplicación.", "Grave"],
        ["La contratación de personas trabajadoras extranjeras sin haberles solicitado la correspondiente autorización de trabajo, o cuando la autorización no les habilite para trabajar en esa ocupación o ámbito geográfico, incurriéndose en una infracción por cada una de las personas trabajadoras extranjeras ocupadas.", "Grave"],
        // INFRACCIONES MUY GRAVES
        ["Participar en actividades contrarias a la seguridad nacional o que puedan perjudicar las relaciones de España con otros países.", "Muy Grave"],
        ["Inducir, promover, favorecer o facilitar con ánimo de lucro, individualmente o formando parte de una organización, la inmigración clandestina de personas extranjeras en tránsito o con destino a España o su permanencia irregular en territorio español. No se entenderá que existe ánimo de lucro cuando el objetivo sea prestar asistencia humanitaria, para lo que se tendrá en cuenta la relación entre la persona facilitadora y la persona facilitada, el contexto en el que se desarrolla la acción, la finalidad perseguida y la situación de vulnerabilidad en la que se encuentre la persona facilitada.", "Muy Grave"],
        ["La comisión de una tercera infracción grave, siempre que la persona extranjera hubiera sido sancionada por dos infracciones graves anteriores, en el plazo de un año.", "Muy Grave"],
        ["Emplear a personas trabajadoras extranjeras sin haber obtenido la preceptiva autorización de trabajo, o sin haber dado de alta en la Seguridad Social cuando así se establezca en la normativa de aplicación, incurriéndose en una infracción por cada una de las personas trabajadoras extranjeras ocupadas.", "Muy Grave"],
        ["La simulación de la relación laboral o la presentación de contratos de trabajo o de ofertas de empleo fraudulentos, con la finalidad de obtener una autorización de residencia o la prórroga de la misma, o para obtener una autorización de trabajo, ya sea por cuenta propia o ajena.", "Muy Grave"],
        ["Alteración o falsificación de documentos utilizados para obtener visados o autorizaciones, ya sea por la persona extranjera o por su representante.", "Muy Grave"],
        ["La participación en actividades que atenten contra la seguridad pública, el orden público, la salud pública o la integridad de las personas.", "Muy Grave"],
        ["La estancia en España en condiciones que contravengan lo dispuesto en la presente Ley.", "Muy Grave"]
      ],
      choices: ["Leve", "Grave", "Muy Grave"]
    },
    // NUEVO: Objeto para el juego "Infracciones L.O 4/2010"
    lo42010: {
      title: "Infracciones L.O 4/2010",
      questions: [
        // Faltas Muy Graves
        ["El incumplimiento del deber de fidelidad a la Constitución en el ejercicio de las funciones.", "Muy Grave"],
        ["Haber sido condenado en virtud de sentencia firme por un delito doloso relacionado con el servicio o que cause grave daño a la Administración o a las personas.", "Muy Grave"],
        ["El abuso de atribuciones que cause grave daño a los ciudadanos, a los subordinados, a la Administración o a las entidades con personalidad jurídica.", "Muy Grave"],
        ["La práctica de tratos inhumanos, degradantes, discriminatorios o vejatorios a los ciudadanos que se encuentren bajo custodia policial.", "Muy Grave"],
        ["La insubordinación individual o colectiva, respecto a las Autoridades o mandos de que dependan.", "Muy Grave"],
        ["El abandono de servicio, salvo que exista causa de fuerza mayor que impida comunicar a un superior dicho abandono.", "Muy Grave"],
        ["La publicación o la utilización indebida de secretos oficiales, declarados así con arreglo a la legislación específica en la materia.", "Muy Grave"],
        ["La violación del secreto profesional cuando perjudique el desarrollo de la labor policial, a cualquier ciudadano o a las entidades con personalidad jurídica.", "Muy Grave"],
        ["El incumplimiento de las normas sobre incompatibilidades cuando ello dé lugar a una situación de incompatibilidad.", "Muy Grave"],
        ["La participación en huelgas, en acciones sustitutivas de estas o en actuaciones concertadas con el fin de alterar el normal funcionamiento de los servicios.", "Muy Grave"],
        ["La falta de colaboración manifiesta con otros miembros de las Fuerzas y Cuerpos de Seguridad, cuando resulte perjudicado gravemente el servicio o se deriven consecuencias graves para la seguridad ciudadana.", "Muy Grave"],
        ["Embriagarse o consumir drogas tóxicas, estupefacientes o sustancias psicotrópicas durante el servicio o realizarlo en estado de embriaguez o bajo los efectos manifiestos de los productos citados.", "Muy Grave"],
        ["La negativa injustificada a someterse a reconocimiento médico, prueba de alcoholemia o de detección de drogas tóxicas, estupefacientes o sustancias psicotrópicas, legítimamente ordenadas, a fin de constatar la capacidad psicofísica para prestar servicio.", "Muy Grave"],
        ["Toda actuación que suponga discriminación por razón de origen racial o étnico, religión o convicciones, discapacidad, edad u orientación sexual, sexo, lengua, opinión, lugar de nacimiento o vecindad, o cualquier otra condición o circunstancia personal o social.", "Muy Grave"],
        ["El acoso sexual y el acoso laboral, consistente este último en la realización reiterada, en el marco de una relación de servicio, de actos de acoso psicológico u hostilidad.", "Muy Grave"],
        ["La obstaculización grave al ejercicio de las libertades públicas y derechos sindicales.", "Muy Grave"],
        ["Las infracciones tipificadas como muy graves en la legislación sobre utilización de videocámaras por las Fuerzas y Cuerpos de Seguridad en lugares públicos.", "Muy Grave"],

        // Faltas Graves
        ["La grave desconsideración con los superiores, compañeros, subordinados o ciudadanos, en el ejercicio de sus funciones o cuando cause descrédito notorio a la Institución Policial.", "Grave"],
        ["La desobediencia a los superiores jerárquicos o los responsables del servicio con motivo de las órdenes o instrucciones legítimas dadas por aquéllos, salvo que constituyan infracción manifiesta del ordenamiento jurídico.", "Grave"],
        ["La omisión de la obligación de dar cuenta a la superioridad con la debida diligencia de todo asunto que por su entidad requiera su conocimiento o decisión urgente.", "Grave"],
        ["La falta de presentación o puesta a disposición inmediata de la dependencia donde estuviera destinado, o en la más próxima, en los casos de declaración de los estados de excepción o sitio o, cuando así se disponga, en caso de alteración grave de la seguridad ciudadana; o, en los casos de declaración del estado de alarma, la no presentación cuando sean emplazados para ello, de acuerdo con lo dispuesto por la autoridad competente.", "Grave"],
        ["La tercera falta injustificada de asistencia al servicio en un período de tres meses cuando las dos anteriores hubieran sido objeto de sanción firme por falta leve.", "Grave"],
        ["No prestar servicio, alegando supuesta enfermedad.", "Grave"],
        ["La falta de rendimiento reiterada que ocasione un perjuicio a los ciudadanos, a las entidades con personalidad jurídica o a la eficacia de los servicios.", "Grave"],
        ["El abuso de atribuciones cuando no constituya infracción muy grave.", "Grave"],
        ["La emisión de informes sobre asuntos de servicio que, sin faltar abiertamente a la verdad, la desnaturalicen, valiéndose de términos ambiguos, confusos o tendenciosos, o la alteren mediante inexactitudes, cuando se cause perjuicio a la Administración o a los ciudadanos, siempre que el hecho no constituya delito o falta muy grave.", "Grave"],
        ["La intervención en un procedimiento administrativo cuando concurra alguna de las causas legales de abstención.", "Grave"],
        ["No ir provisto en los actos de servicio del uniforme reglamentario, cuando su uso sea preceptivo, de los distintivos de la categoría o cargo, del arma reglamentaria o de los medios de protección o acción que se determinen, siempre que no medie autorización en contrario.", "Grave"],
        ["Exhibir armas sin causa justificada, así como utilizarlas en acto de servicio o fuera de él infringiendo las normas que regulan su empleo.", "Grave"],
        ["Dar lugar al extravío, pérdida o sustracción por negligencia inexcusable de los distintivos de identificación o del arma reglamentaria.", "Grave"],
        ["Asistir de uniforme a cualquier manifestación o reunión pública, salvo que se trate de actos de servicio, o actos oficiales en los que la asistencia de uniforme esté indicada o haya sido autorizada.", "Grave"],
        ["Causar, por negligencia inexcusable, daños graves en la conservación de los locales, del material o de los demás elementos relacionados con el servicio o dar lugar al extravío, la pérdida o la sustracción de estos.", "Grave"],
        ["Impedir, limitar u obstaculizar a los subordinados el ejercicio de los derechos que tengan reconocidos, siempre que no constituya falta muy grave.", "Grave"],
        ["Embriagarse o consumir drogas tóxicas, estupefacientes o sustancias psicotrópicas fuera del servicio, cuando tales circunstancias tengan carácter habitual o afecten a la imagen del Cuerpo Nacional de Policía. Se entenderá que existe habitualidad cuando estuvieren acreditados tres o más episodios de embriaguez o consumo de las sustancias referidas en un periodo de un año.", "Grave"],
        ["La tenencia de drogas tóxicas, estupefacientes o sustancias psicotrópicas, excepto que esa tenencia se derive de actuaciones propias del servicio.", "Grave"],
        ["Solicitar y obtener cambios de destino mediando cualquier recompensa, ánimo de lucro o falseando las condiciones que los regulan.", "Grave"],
        ["Emplear, o autorizar la utilización para usos no relacionados con el servicio o con ocasión de este, o sin que medie causa justificada, de medios o recursos inherentes a la función policial.", "Grave"],
        ["Las infracciones a lo dispuesto en la legislación sobre utilización de videocámaras por las Fuerzas y Cuerpos de Seguridad en lugares públicos, no constitutivas de falta muy grave.", "Grave"],
        ["El incumplimiento de los plazos u otras disposiciones de procedimiento en materia de incompatibilidades, cuando no supongan mantenimiento de una situación de incompatibilidad.", "Grave"],
        ["La violación del secreto profesional cuando no perjudique el desarrollo de la labor policial, a las entidades con personalidad jurídica o a cualquier ciudadano.", "Grave"],
        ["La falta de colaboración manifiesta con otros miembros de los Cuerpos y Fuerzas de Seguridad, siempre que no merezca la calificación de falta muy grave.", "Grave"],
        ["La infracción de deberes u obligaciones legales inherentes al cargo o a la función policial, cuando se produzcan de forma grave y manifiesta.", "Grave"],
        ["Haber sido condenado en virtud de sentencia firme por un delito doloso, siempre que no constituya infracción muy grave, o por una falta dolosa cuando la infracción penal cometida esté relacionada con el servicio.", "Grave"],
        ["La no prestación de auxilio con urgencia en aquellos hechos o circunstancias graves en que sea obligada su actuación, salvo que constituya delito.", "Grave"],
        ["La infracción de las normas de prevención de riesgos laborales que pongan en grave riesgo la vida, salud, o integridad física, propia o de sus compañeros o subordinados.", "Grave"],
        ["La negativa reiterada a tramitar cualquier solicitud, reclamación o queja relacionada con el servicio, siempre que no constituya falta leve.", "Grave"],
        ["Aquellas acciones u omisiones tipificadas como faltas muy graves que, de acuerdo con los criterios que se establecen en el artículo 12, merezcan la calificación de graves, y sin que estas a su vez puedan ser calificadas como faltas leves.", "Grave"],

        // Faltas Leves (retomadas de la versión anterior)
        ["El retraso o la negligencia en el cumplimiento de las funciones y órdenes recibidas.", "Leve"],
        ["La incorrección con los ciudadanos, o con otros miembros de los Cuerpos y Fuerzas de Seguridad, siempre que no merezcan una calificación más grave.", "Leve"],
        ["La inasistencia al servicio que no constituya falta de mayor gravedad y el incumplimiento de la jornada de trabajo, así como las faltas repetidas de puntualidad, en los 30 días precedentes.", "Leve"],
        ["El mal uso o el descuido en la conservación de los locales, del material o de los demás elementos de los servicios, así como el incumplimiento de las normas dadas en esta materia, cuando no constituya falta más grave.", "Leve"],
        ["Dar lugar al extravío, pérdida o sustracción por simple negligencia, de los distintivos de identificación, del arma reglamentaria u otros medios o recursos destinados a la función policial.", "Leve"],
        ["La exhibición de los distintivos de identificación sin causa justificada.", "Leve"],
        ["Prescindir del conducto reglamentario para formular cualquier solicitud, reclamación o queja relacionada con el servicio, así como no tramitar las mismas. Quedan exceptuadas del conducto reglamentario aquellas que se formulen por los representantes de las organizaciones sindicales en el ejercicio de la actividad sindical.", "Leve"],
        ["El descuido en el aseo personal y el incumplimiento de las normas sobre la uniformidad, siempre que no constituya falta grave.", "Leve"],
        ["La ausencia injustificada de cualquier servicio, cuando no merezca calificación más grave.", "Leve"],
        ["La omisión intencionada de saludo a un superior, que éste no lo devuelva o infringir de otro modo las normas que lo regulan.", "Leve"],
        ["Cualquier clase de juego que se lleve a cabo en las dependencias policiales, siempre que perjudique la prestación del servicio o menoscabe la imagen policial.", "Leve"],
        ["Ostentar insignias, condecoraciones u otros distintivos, sin estar autorizado para ello, siempre que no merezca una calificación más grave.", "Leve"],
        ["Haber sido condenado en virtud de sentencia firme por una falta dolosa cuando la infracción penal cometida cause daño a la Administración o a los Administrados.", "Leve"],
        ["Aquellas acciones u omisiones tipificadas como faltas graves que, de acuerdo con los criterios que se establecen en el artículo 12, merezcan la calificación de leves.", "Leve"]
      ],
      choices: ["Leve", "Grave", "Muy Grave"]
    }
  };

  // --- Funciones de Utilidad ---
  function showScreen(screenId) {
    console.log('DEBUG: showScreen called for:', screenId);
    const screens = document.querySelectorAll('.screen');
    screens.forEach(screen => {
      if (screen) {
        screen.classList.add('hidden');
      }
    });
    const targetScreen = document.getElementById(screenId);
    if (targetScreen) {
      targetScreen.classList.remove('hidden');
      currentScreen = targetScreen; // Actualizar la pantalla actual
      console.log('DEBUG: Screen shown:', screenId);
    } else {
      console.error('ERROR: Target screen not found:', screenId);
    }
    // Asegurarse de que el scroll esté arriba al cambiar de pantalla
    if (targetScreen && targetScreen.id !== 'gameScreen') {
        targetScreen.scrollTop = 0;
    }
  }

  function showMessage(element, message, type = 'error') {
    if (element) {
      element.textContent = message;
      element.className = 'error-message ' + type;
      console.log(`DEBUG: Message displayed on ${element.id}: ${message} (Type: ${type})`);
    } else {
      console.error('ERROR: Element for showMessage not found.');
    }
  }

  function clearMessage(element) {
    if (element) {
      element.textContent = '';
      element.className = 'error-message'; // Restablece la clase base
      console.log(`DEBUG: Message cleared on ${element.id}.`);
    } else {
      console.error('ERROR: Element for clearMessage not found.');
    }
  }

  // --- Funciones de Navegación y Lógica Principal ---
  function login() {
    console.log('DEBUG: Login function called.');
    clearMessage(loginError);
    const username = usernameInput ? usernameInput.value.trim() : '';
    const password = passwordInput ? passwordInput.value.trim() : '';

    console.log('DEBUG: Username entered:', username);
    console.log('DEBUG: Password entered:', password ? '********' : ''); // No logear la contraseña real

    if (username === 'admin' && password === 'admin') {
      console.log('DEBUG: Admin login successful.');
      loggedInUser = username;
      showMenu('Bienvenido, ' + loggedInUser);
      // Mostrar tarjetas de admin si es necesario
      if (gameStatsCard) gameStatsCard.style.display = 'flex';
      if (gameGenerateTestCard) gameGenerateTestCard.style.display = 'flex';
      if (gameChatCard) gameChatCard.style.display = 'flex';
    } else if (username === 'user' && password === 'user') {
      console.log('DEBUG: User login successful.');
      loggedInUser = username;
      showMenu('Bienvenido, ' + loggedInUser);
      // Ocultar tarjetas de admin para usuarios normales
      if (gameStatsCard) gameStatsCard.style.display = 'none';
      if (gameGenerateTestCard) gameGenerateTestCard.style.display = 'none';
      if (gameChatCard) gameChatCard.style.display = 'none';
    } else {
      console.log('DEBUG: Login failed: Incorrect credentials.');
      showMessage(loginError, 'Usuario o contraseña incorrectos. Intenta con "admin/admin" o "user/user".');
      if (passwordInput) passwordInput.value = ''; // Limpiar contraseña al fallar
    }
  }

  function showMenu(welcomeText) {
    console.log('DEBUG: showMenu called with:', welcomeText);
    showScreen('menuScreen');
    const welcomeDisplay = document.querySelector('#menuScreen .topbar .welcome-text');
    if (welcomeDisplay) {
      welcomeDisplay.textContent = welcomeText;
    } else {
      console.error('ERROR: Welcome text element not found in menu screen.');
    }
  }

  function startGame(gameType) {
    console.log('DEBUG: startGame called for type:', gameType);
    currentGameType = gameType;
    currentQuestions = generateQuestions(gameType, numQuestionsInput ? parseInt(numQuestionsInput.value) : 10);
    if (currentQuestions.length === 0) {
      showMessage(generateTestError, 'No se pudieron generar preguntas con los criterios seleccionados.');
      console.error('ERROR: No questions generated for game type:', gameType);
      return;
    }
    currentQuestionIndex = 0;
    userAnswers = {};
    correctAnswersCount = 0;
    showScreen('gameScreen');
    if (gameTitleDisplay) {
        gameTitleDisplay.textContent = gameData[gameType].title;
    } else {
        console.error('ERROR: gameTitleDisplay element not found.');
    }
    startQuizTimer(testTimeInput ? parseInt(testTimeInput.value) : 10);
    displayQuestion();
  }

  function displayQuestion() {
    console.log('DEBUG: displayQuestion called. Current index:', currentQuestionIndex);
    clearMessage(resultMessage);
    if (currentQuestions.length === 0) {
      if (questionText) questionText.textContent = 'No hay preguntas disponibles.';
      if (choicesContainer) choicesContainer.innerHTML = '';
      return;
    }

    const question = currentQuestions[currentQuestionIndex];
    if (questionText) {
        questionText.textContent = `${currentQuestionIndex + 1}. ${question[0]}`;
    } else {
        console.error('ERROR: questionText element not found.');
    }

    if (choicesContainer) {
        choicesContainer.innerHTML = '';
        // Mezclar las opciones para cada pregunta
        const shuffledChoices = shuffleArray([...gameData[currentGameType].choices]);
        
        shuffledChoices.forEach((choice, index) => {
            const button = document.createElement('button');
            button.textContent = choice;
            button.dataset.choice = choice; // Guardar la opción en un dataset
            button.onclick = () => selectAnswer(choice); // Pasar la opción seleccionada
            choicesContainer.appendChild(button);
        });
    } else {
        console.error('ERROR: choicesContainer element not found.');
    }

    // Resaltar respuesta seleccionada previamente y deshabilitar botones si ya se respondió
    if (userAnswers[currentQuestionIndex] !== undefined) {
      const buttons = choicesContainer ? choicesContainer.querySelectorAll('button') : [];
      const selectedChoice = userAnswers[currentQuestionIndex];
      const correctAnswer = currentQuestions[currentQuestionIndex][1];

      buttons.forEach(button => {
        button.disabled = true;
        if (button.dataset.choice === correctAnswer) {
          button.classList.add('correct');
        } else if (button.dataset.choice === selectedChoice) {
          button.classList.add('incorrect');
        }
      });
    }

    updateNavButtons();
  }

  function selectAnswer(selectedChoice) { // Recibe la opción directamente
    console.log('DEBUG: selectAnswer called with:', selectedChoice);
    const question = currentQuestions[currentQuestionIndex];
    const correctAnswer = question[1];
    
    userAnswers[currentQuestionIndex] = selectedChoice;

    const buttons = choicesContainer ? choicesContainer.querySelectorAll('button') : [];
    buttons.forEach(button => {
      button.disabled = true; // Deshabilita todos los botones una vez que se selecciona una respuesta
      if (button.dataset.choice === correctAnswer) {
        button.classList.add('correct');
      } else if (button.dataset.choice === selectedChoice) {
        button.classList.add('incorrect');
      }
    });

    if (selectedChoice === correctAnswer) {
      showMessage(resultMessage, '¡Respuesta Correcta! ✅', 'success');
    } else {
      showMessage(resultMessage, `Incorrecto. La respuesta correcta era: "${correctAnswer}" ❌`, 'error');
      // Registrar pregunta incorrecta
      const qKey = `${currentGameType}-${question[0]}`;
      // Almacenar la pregunta, la respuesta correcta y la respuesta del usuario
      if (!incorrectQuestionsStats[qKey]) {
          incorrectQuestionsStats[qKey] = {
              questionText: question[0],
              correctAnswer: correctAnswer,
              timesFailed: 0
          };
      }
      incorrectQuestionsStats[qKey].timesFailed++;
      localStorage.setItem('incorrectQuestionsStats', JSON.stringify(incorrectQuestionsStats));
    }
    updateNavButtons(); // Permite navegación inmediata si se selecciona respuesta
  }

  function updateNavButtons() {
    console.log('DEBUG: updateNavButtons called.');
    if (prevBtn) {
      prevBtn.disabled = currentQuestionIndex === 0;
    } else { console.error('ERROR: prevBtn not found.'); }

    if (nextBtn) {
      if (currentQuestionIndex === currentQuestions.length - 1) {
        nextBtn.textContent = 'Finalizar Test';
        nextBtn.onclick = finishQuiz;
        nextBtn.disabled = userAnswers[currentQuestionIndex] === undefined; // Deshabilitar si no ha respondido la última
      } else {
        nextBtn.textContent = 'Siguiente →';
        nextBtn.onclick = showNextQuestion;
        nextBtn.disabled = userAnswers[currentQuestionIndex] === undefined; // Deshabilitar si no ha respondido la actual
      }
    } else { console.error('ERROR: nextBtn not found.'); }
  }

  function showNextQuestion() {
    console.log('DEBUG: showNextQuestion called.');
    if (currentQuestionIndex < currentQuestions.length - 1) {
      currentQuestionIndex++;
      displayQuestion();
    } else {
        finishQuiz(); // Si es la última pregunta, finalizar
    }
  }

  function showPreviousQuestion() {
    console.log('DEBUG: showPreviousQuestion called.');
    if (currentQuestionIndex > 0) {
      currentQuestionIndex--;
      displayQuestion();
    }
  }

  function finishQuiz() {
    console.log('DEBUG: finishQuiz called.');
    stopTimer(); // Asegurarse de detener el temporizador
    correctAnswersCount = 0;
    for (let i = 0; i < currentQuestions.length; i++) {
      const selectedAnswer = userAnswers[i];
      if (selectedAnswer !== undefined && selectedAnswer === currentQuestions[i][1]) {
        correctAnswersCount++;
      }
    }

    if (finalScoreDisplay) {
        finalScoreDisplay.textContent = `Test Finalizado. Puntuación: ${correctAnswersCount} / ${currentQuestions.length}`;
        finalScoreDisplay.classList.remove('hidden');
    } else { console.error('ERROR: finalScoreDisplay not found.'); }
    
    if (prevBtn) prevBtn.disabled = true;
    if (nextBtn) {
        nextBtn.disabled = true;
        nextBtn.textContent = 'Finalizado';
    }
  }

  function stopTimer() {
    console.log('DEBUG: stopTimer called.');
    if (quizInterval) {
      clearInterval(quizInterval);
      quizInterval = null;
    }
    if (timerDisplay) {
        timerDisplay.classList.add('hidden');
    } else { console.error('ERROR: timerDisplay not found.'); }
  }

  function startQuizTimer(durationInMinutes) {
    console.log('DEBUG: startQuizTimer called with duration:', durationInMinutes);
    stopTimer(); // Asegurarse de que no haya un temporador anterior
    quizStartTime = Date.now();
    const endTime = quizStartTime + durationInMinutes * 60 * 1000;

    if (timerDisplay) {
        timerDisplay.classList.remove('hidden');
    } else { console.error('ERROR: timerDisplay not found for starting timer.'); }

    quizInterval = setInterval(() => {
      const timeLeft = endTime - Date.now();
      if (timeLeft <= 0) {
        clearInterval(quizInterval);
        if (timerDisplay) {
            timerDisplay.textContent = '00:00';
        }
        finishQuiz();
        return;
      }
      const totalSeconds = Math.floor(timeLeft / 1000);
      const minutesLeft = Math.floor(totalSeconds / 60);
      const secondsLeft = totalSeconds % 60;
      const formattedTime = `${String(minutesLeft).padStart(2, '0')}:${String(secondsLeft).padStart(2, '0')}`;
      if (timerDisplay) {
          timerDisplay.textContent = formattedTime;
      }
    }, 1000);
  }

  function showStats() {
    console.log('DEBUG: showStats called.');
    showScreen('statsScreen');
    if (statsContent) {
        statsContent.innerHTML = ''; // Limpiar contenido anterior
        let hasData = false;
        for (const qKey in incorrectQuestionsStats) {
            if (incorrectQuestionsStats.hasOwnProperty(qKey)) {
                hasData = true;
                const data = incorrectQuestionsStats[qKey];
                const gameType = qKey.split('-')[0]; // Extraer el tipo de juego
                const questionText = data.questionText;
                const correctAnswer = data.correctAnswer;
                const timesFailed = data.timesFailed;

                const gameTitle = gameData[gameType] ? gameData[gameType].title : 'Desconocido';

                let gameSection = document.getElementById(`stats-section-${gameType}`);
                if (!gameSection) {
                    gameSection = document.createElement('div');
                    gameSection.id = `stats-section-${gameType}`;
                    gameSection.innerHTML = `<h3>${gameTitle}</h3><ul></ul>`;
                    statsContent.appendChild(gameSection);
                }
                const ul = gameSection.querySelector('ul');
                const li = document.createElement('li');
                li.innerHTML = `<strong>Pregunta:</strong> ${questionText}<br>
                                <strong>Respuesta Correcta:</strong> ${correctAnswer}<br>
                                <strong>Veces Fallada:</strong> ${timesFailed} veces`;
                ul.appendChild(li);
            }
        }

        if (!hasData) {
            statsContent.innerHTML = '<p class="no-data">Aún no hay preguntas falladas registradas.</p>';
        }
    } else { console.error('ERROR: statsContent not found.'); }
  }

  function showGenerateTest() {
    console.log('DEBUG: showGenerateTest called.');
    showScreen('generateTestScreen');
    clearMessage(generateTestError);
    // Reiniciar checkboxes a un estado por defecto si es necesario
    if (jefeDirectorCheckbox) jefeDirectorCheckbox.checked = false;
    if (loexCheckbox) loexCheckbox.checked = false;
    if (lo42010Checkbox) lo42010Checkbox.checked = false;
    if (numQuestionsInput) numQuestionsInput.value = 10;
    if (testTimeInput) testTimeInput.value = 10;
  }

  function generateCustomTest() {
    console.log('DEBUG: generateCustomTest called.');
    clearMessage(generateTestError);
    const selectedTypes = [];
    if (jefeDirectorCheckbox && jefeDirectorCheckbox.checked) selectedTypes.push('jefeDirector');
    if (loexCheckbox && loexCheckbox.checked) selectedTypes.push('loex');
    if (lo42010Checkbox && lo42010Checkbox.checked) selectedTypes.push('lo42010');

    if (selectedTypes.length === 0) {
      showMessage(generateTestError, 'Selecciona al menos un tipo de juego.', 'error');
      console.error('ERROR: No game types selected for custom test.');
      return;
    }

    const numQuestions = numQuestionsInput ? parseInt(numQuestionsInput.value) : 0;
    const testTime = testTimeInput ? parseInt(testTimeInput.value) : 0;

    if (isNaN(numQuestions) || numQuestions <= 0) {
      showMessage(generateTestError, 'Número de preguntas inválido.', 'error');
      console.error('ERROR: Invalid number of questions:', numQuestions);
      return;
    }
    if (isNaN(testTime) || testTime <= 0) {
      showMessage(generateTestError, 'Tiempo límite inválido.', 'error');
      console.error('ERROR: Invalid test time:', testTime);
      return;
    }

    // Generar preguntas de los tipos seleccionados
    let allPossibleQuestions = [];
    selectedTypes.forEach(type => {
      if (gameData[type] && gameData[type].questions) {
        allPossibleQuestions = allPossibleQuestions.concat(gameData[type].questions);
      } else {
          console.warn('WARNING: Game data not found for type:', type);
      }
    });

    if (allPossibleQuestions.length < numQuestions) {
      showMessage(generateTestError, `No hay suficientes preguntas (${allPossibleQuestions.length}) para generar un test de ${numQuestions} preguntas.`, 'error');
      console.error('ERROR: Not enough questions available for custom test.');
      return;
    }

    // Mezclar y seleccionar un subconjunto de preguntas
    const shuffledQuestions = shuffleArray(allPossibleQuestions);
    const finalQuestions = shuffledQuestions.slice(0, numQuestions);

    // Iniciar el juego con las preguntas generadas
    currentGameType = 'test'; // Usar 'test' para el modo de prueba personalizada
    gameData.test = { // Definir un tipo de juego 'test' temporalmente
        title: "Evaluación Personalizada",
        questions: finalQuestions,
        // Las opciones deben ser una combinación de todas las opciones posibles de los juegos seleccionados
        choices: Array.from(new Set(selectedTypes.flatMap(type => gameData[type].choices)))
    };

    startGame('test');
  }

  function generateQuestions(type, count) {
    if (!gameData[type] || !gameData[type].questions) {
      console.error('ERROR: Tipo de juego no encontrado en generateQuestions:', type);
      return [];
    }
    const allQuestions = gameData[type].questions;
    const shuffled = allQuestions.sort(() => 0.5 - Math.random());
    return shuffled.slice(0, count);
  }

  function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  // --- Funciones de Chat ---
  function showChatLogin() {
    console.log('DEBUG: showChatLogin called.');
    showScreen('chatLoginScreen');
    clearMessage(chatLoginError);
    if (chatUsernameInput) {
        chatUsernameInput.value = '';
    }
  }

  function connectChat() {
    console.log('DEBUG: connectChat called.');
    clearMessage(chatLoginError);
    const username = chatUsernameInput ? chatUsernameInput.value.trim() : '';
    if (username.length < 3) {
      showMessage(chatLoginError, 'El identificador de agente debe tener al menos 3 caracteres.', 'error');
      console.error('ERROR: Chat username too short.');
      return;
    }
    chatUsername = username;
    showScreen('groupChatScreen');
    if (chatMessagesContainer) {
        chatMessagesContainer.innerHTML = ''; // Limpiar mensajes anteriores
    }
    chatMessages = []; // Resetear el historial de chat
    appendChatMessage('Sistema', `Bienvenido al chat de operaciones, ${chatUsername}.`, 'system-message');
  }

  function appendChatMessage(sender, message, type = 'other-message') {
    if (!chatMessagesContainer) {
        console.error('ERROR: chatMessagesContainer not found for appending message.');
        return;
    }

    const messageElement = document.createElement('div');
    messageElement.classList.add('chat-message');
    if (type === 'own-message') {
        messageElement.classList.add('own-message');
    } else if (type === 'system-message') {
        messageElement.classList.add('system-message');
        messageElement.style.cssText = `
            background: #202028;
            color: var(--color-text-muted);
            font-size: 0.85em;
            text-align: center;
            border: 1px dashed var(--color-border);
            border-radius: 4px;
            padding: 0.5rem;
            margin: 0.5rem auto;
            max-width: 90%;
        `;
        messageElement.innerHTML = `<em>${message}</em>`;
    } else {
        messageElement.classList.add('other-message');
    }

    if (type !== 'system-message') {
        const senderElement = document.createElement('span');
        senderElement.classList.add('message-sender');
        senderElement.textContent = sender;
        
        const textElement = document.createElement('span');
        textElement.textContent = message;

        messageElement.appendChild(senderElement);
        messageElement.appendChild(textElement);
    }

    chatMessagesContainer.appendChild(messageElement);
    chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight; // Scroll automático
    chatMessages.push({ sender, message, type }); // Guardar para historial simulado
    console.log('DEBUG: Chat message appended:', {sender, message, type});
  }

  function sendChatMessage() {
    console.log('DEBUG: sendChatMessage called.');
    const message = chatMessageInput ? chatMessageInput.value.trim() : '';
    if (message.length === 0) {
        console.warn('WARNING: Attempted to send empty chat message.');
        return;
    }

    appendChatMessage(chatUsername, message, 'own-message');
    if (chatMessageInput) {
        chatMessageInput.value = '';
    }

    // Simular respuesta del sistema o de otro agente
    setTimeout(() => {
      const responses = [
        "Mensaje recibido. Procesando solicitud...",
        "Entendido, Agente. Reconfigurando parámetros.",
        "Confirmado. El equipo está en ello.",
        "Negativo, Agente. Se requiere más información.",
        "Afirmativo. Operación en curso."
      ];
      const randomResponse = responses[Math.floor(Math.random() * responses.length)];
      appendChatMessage('Sistema', randomResponse, 'other-message');
    }, 1500);
  }


  // --- Inicialización y Event Listeners ---
  document.addEventListener('DOMContentLoaded', () => {
    console.log('DEBUG: DOM Content Loaded. Initializing app.');
    // Inicializar el sistema mostrando la pantalla de login
    showScreen('loginScreen'); // Usar showScreen para la primera visualización

    if (loginBtn) {
      console.log('DEBUG: Attaching click listener to loginBtn.');
      loginBtn.addEventListener('click', login);
    } else {
      console.error('ERROR: Login button (loginBtn) not found!');
    }
    if (usernameInput) {
      usernameInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
              console.log('DEBUG: Enter pressed on username input. Calling login().');
              login();
          }
      });
    }
    if (passwordInput) {
      passwordInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
              console.log('DEBUG: Enter pressed on password input. Calling login().');
              login();
          }
      });
    }

    // Adjuntar listeners a los botones de navegación y tarjetas de juego
    if (logoutBtn) { logoutBtn.addEventListener('click', () => { loggedInUser = null; localStorage.removeItem('incorrectQuestionsStats'); incorrectQuestionsStats = {}; showScreen('loginScreen'); console.log('DEBUG: Logged out.'); }); }
    if (backToMenuBtn) { backToMenuBtn.addEventListener('click', () => showMenu('Bienvenido, ' + (loggedInUser || 'Agente'))); }
    if (backToMenuFromStatsBtn) { backToMenuFromStatsBtn.addEventListener('click', () => showMenu('Bienvenido, ' + (loggedInUser || 'Agente'))); }
    if (backToMenuFromGenerateTestBtn) { backToMenuFromGenerateTestBtn.addEventListener('click', () => showMenu('Bienvenido, ' + (loggedInUser || 'Agente'))); }
    if (backToMenuFromChatLoginBtn) { backToMenuFromChatLoginBtn.addEventListener('click', () => showMenu('Bienvenido, ' + (loggedInUser || 'Agente'))); }
    if (backToMenuFromGroupChatBtn) { backToMenuFromGroupChatBtn.addEventListener('click', () => showMenu('Bienvenido, ' + (loggedInUser || 'Agente'))); }

    if (gameJefeDirectorCard) { gameJefeDirectorCard.addEventListener('click', () => startGame('jefeDirector')); } else { console.error('ERROR: gameJefeDirectorCard not found.'); }
    if (gameLOEXCard) { gameLOEXCard.addEventListener('click', () => startGame('loex')); } else { console.error('ERROR: gameLOEXCard not found.'); }
    if (gameLO42010Card) { gameLO42010Card.addEventListener('click', () => startGame('lo42010')); } else { console.error('ERROR: gameLO42010Card not found.'); }
    if (gameStatsCard) { gameStatsCard.addEventListener('click', showStats); } else { console.error('ERROR: gameStatsCard not found.'); }
    if (gameGenerateTestCard) { gameGenerateTestCard.addEventListener('click', showGenerateTest); } else { console.error('ERROR: gameGenerateTestCard not found.'); }
    if (gameChatCard) { gameChatCard.addEventListener('click', showChatLogin); } else { console.error('ERROR: gameChatCard not found.'); }

    if (prevBtn) { prevBtn.addEventListener('click', showPreviousQuestion); } else { console.error('ERROR: prevBtn not found.'); }
    if (nextBtn) { nextBtn.addEventListener('click', showNextQuestion); } else { console.error('ERROR: nextBtn not found.'); } // La lógica de click se actualiza dinámicamente en updateNavButtons
    if (generateTestBtn) { generateTestBtn.addEventListener('click', generateCustomTest); } else { console.error('ERROR: generateTestBtn not found.'); }
    if (connectChatBtn) { connectChatBtn.addEventListener('click', connectChat); } else { console.error('ERROR: connectChatBtn not found.'); }
    if (sendChatMessageBtn) { sendChatMessageBtn.addEventListener('click', sendChatMessage); } else { console.error('ERROR: sendChatMessageBtn not found.'); }
    if (chatMessageInput) {
      chatMessageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendChatMessage();
        }
      });
    } else { console.error('ERROR: chatMessageInput not found.'); }
  });

})(); // Fin de la IIFE (Immediately Invoked Function Expression)
</script>
</body>
</html>
