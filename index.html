<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PULIPOL - Sistema de Capacitación Policial</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&amp;family=Share+Tech+Mono&amp;display=swap" rel="stylesheet">
<style>
  /* Variables CSS para una paleta policial oscura y tecnológica */
  :root {
    --color-bg-dark: #0A0A0E; /* Fondo muy oscuro, casi negro */
    --color-bg-medium: #1A1A22; /* Fondo de contenedores principales */
    --color-bg-light: #2A2A38; /* Fondo de elementos secundarios, inputs */
    --color-primary-blue: #007BFF; /* Azul distintivo para interacción/resaltado */
    --color-accent-red: #DC3545; /* Rojo para alertas/errores */
    --color-accent-green: #28A745; /* Verde para éxito */
    --color-text-light: #E0E6EB; /* Texto claro general */
    --color-text-muted: #8F9BB3; /* Texto secundario, descripciones */
    --color-border: #3A3A48; /* Bordes sutiles */
    --color-border-active: #007BFF; /* Borde activo/foco */
    --color-glow: rgba(0, 123, 255, 0.4); /* Resplandor azul */
    --color-shadow: rgba(0, 0, 0, 0.6); /* Sombra de elementos */
    --color-overlay: rgba(0, 0, 0, 0.8); /* Overlay oscuro */
  }

  /* Reset y estilos base */
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  html, body {
    height: 100%;
    overflow: hidden; /* Controlar el desbordamiento principal */
  }

  body {
    font-family: 'Share Tech Mono', monospace; /* Fuente monospace para un toque tech */
    background: radial-gradient(circle at top left, var(--color-bg-medium) 0%, var(--color-bg-dark) 70%);
    color: var(--color-text-light);
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 1rem;
    position: relative;
    overflow-y: auto; /* Permitir scroll solo si el contenido excede la altura */
  }

  /* Efecto de ruido de fondo sutil */
  body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: url('data:image/svg+xml;base64,PHN2ZyB2aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZmlsdGVyIGlkPSJuIj48ZmVUdXJidWxlbmNlIHR5cGU9ImZyYWN0YWxOb2lzZSIgYmFzZUZyZXF1ZW5jeT0iLjUiIG51bU9jdGF2ZXM9IjMiIHNlYW09InRydWUiIGxpbWl0aW5nPSIxIi8+PHdlc0RpZXJlY3QgeD0iMTAwIiB5PSIxMDAiIHJlc3VsdD0iaSIvPjxwYXRoIGQ9Ik0wIDBoMjAwdi0yMDBoMjAwdi0yMDAiLz48L2ZpbHRlcj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMDAwIiBmaWx0ZXI9InVybCgjbikiIG9wYWNpdHk9Ii4xIi8+PC9zdmc+') repeat;
    opacity: 0.1;
    pointer-events: none;
    z-index: -1;
  }

  /* Contenedor principal de pantallas */
  .screen {
    background: var(--color-bg-medium);
    border: 2px solid var(--color-border);
    border-radius: 8px;
    box-shadow: 0 0 20px var(--color-shadow), inset 0 0 15px rgba(0, 123, 255, 0.05);
    padding: 2.5rem;
    width: clamp(320px, 95vw, 700px); /* Ancho adaptable */
    max-height: 95vh;
    overflow-y: auto; /* Scrollable if content overflows */
    text-align: center;
    position: relative;
    transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
    transform-origin: center center;
  }

  .hidden {
    opacity: 0;
    transform: scale(0.9) translateY(20px);
    pointer-events: none;
    position: absolute; /* Para que no ocupe espacio cuando está oculto */
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%) scale(0.9);
  }

  /* Título de la aplicación */
  h1 {
    font-family: 'Orbitron', sans-serif;
    font-size: clamp(2.5rem, 8vw, 4.5rem); /* Título responsive */
    color: var(--color-primary-blue);
    text-shadow: 0 0 15px var(--color-glow);
    margin-bottom: 2.5rem;
    letter-spacing: 3px;
    line-height: 1.1;
  }

  /* Estilos de botones generales */
  button {
    background: var(--color-primary-blue);
    color: var(--color-text-light);
    border: none;
    padding: 0.8rem 1.8rem;
    border-radius: 6px;
    font-family: 'Orbitron', sans-serif;
    font-size: 1.1rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 1px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
  }

  button:hover:not(:disabled) {
    background: #0056B3;
    box-shadow: 0 6px 15px var(--color-glow);
    transform: translateY(-2px);
  }

  button:active:not(:disabled) {
    transform: translateY(0);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
  }

  button:disabled {
    background: var(--color-bg-light);
    color: var(--color-text-muted);
    cursor: not-allowed;
    box-shadow: none;
    transform: none;
    opacity: 0.7;
  }

  /* Input fields */
  input[type="text"],
  input[type="password"],
  input[type="number"],
  #chatMessageInput {
    width: 100%;
    padding: 0.9rem 1.2rem;
    margin-bottom: 1.2rem;
    border-radius: 6px;
    border: 1px solid var(--color-border);
    background: var(--color-bg-light);
    color: var(--color-text-light);
    font-family: 'Share Tech Mono', monospace;
    font-size: 1rem;
    outline: none;
    transition: border-color 0.3s, box-shadow 0.3s;
    box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.4);
  }

  input[type="text"]:focus,
  input[type="password"]:focus,
  input[type="number"]:focus,
  #chatMessageInput:focus {
    border-color: var(--color-border-active);
    box-shadow: 0 0 0 3px var(--color-glow), inset 0 2px 5px rgba(0, 0, 0, 0.6);
  }

  /* Mensajes de error */
  .error-message {
    color: var(--color-accent-red);
    font-weight: bold;
    margin-top: -0.8rem;
    margin-bottom: 1.2rem;
    min-height: 1.5em; /* Previene saltos de diseño */
  }

  /* --- Topbar de Pantallas Secundarias (Menú, Juego, Estadísticas, etc.) --- */
  .topbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(90deg, #004D99, var(--color-primary-blue));
    padding: 1rem 1.5rem;
    border-bottom: 2px solid #003366;
    border-radius: 6px 6px 0 0;
    margin: -2.5rem -2.5rem 2rem -2.5rem; /* Ajuste para que se extienda a los bordes del .screen */
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
    flex-wrap: wrap;
    gap: 0.8rem;
  }

  .topbar .welcome-text,
  .topbar h2 {
    font-family: 'Orbitron', sans-serif;
    font-size: clamp(1.2rem, 4vw, 1.8rem);
    color: var(--color-text-light);
    text-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
    margin: 0;
  }
  .topbar h2 {
      flex-grow: 1; /* Permite que el título crezca */
      text-align: left;
  }


  .topbar button {
    background: var(--color-accent-red);
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
  }
  .topbar button:hover {
    background: #A0202E;
  }

  /* --- Pantalla de Menú --- */
  #menuScreen .game-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Columnas responsivas */
    gap: 1.5rem;
    padding-top: 1rem; /* Espacio debajo del topbar */
  }

  .game-card {
    background: var(--color-bg-light);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    padding: 1.5rem;
    text-align: left;
    display: flex;
    align-items: center;
    gap: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
    position: relative;
    overflow: hidden;
  }

  .game-card::before { /* Efecto de borde animado */
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border-radius: 8px;
    border: 2px solid transparent;
    transition: border-color 0.3s ease;
    pointer-events: none;
  }

  .game-card:hover::before {
    border-color: var(--color-primary-blue);
  }

  .game-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px var(--color-shadow), 0 0 15px var(--color-glow);
  }

  .game-card .icon {
    font-size: 2.5rem;
    line-height: 1;
    color: var(--color-primary-blue);
    text-shadow: 0 0 8px var(--color-glow);
  }

  .game-card .content .title {
    font-family: 'Orbitron', sans-serif;
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: 0.3rem;
    color: var(--color-text-light);
  }

  .game-card .content p {
    font-size: 0.9rem;
    color: var(--color-text-muted);
  }

  /* --- Pantalla de Juego/Test --- */
  #gameScreen .topbar {
    justify-content: space-between;
  }
  #gameScreen .timer {
    font-family: 'Orbitron', sans-serif;
    font-size: 1.8rem;
    color: var(--color-accent-red);
    text-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
    margin-left: 1rem;
  }

  #gameContent {
    padding-top: 1rem;
  }

  #questionText {
    background: var(--color-bg-light);
    border: 1px solid var(--color-border);
    border-left: 5px solid var(--color-primary-blue); /* Barra de énfasis */
    border-radius: 6px;
    padding: 1.5rem 1rem;
    margin-bottom: 2rem;
    font-size: 1.15rem;
    line-height: 1.6;
    text-align: left;
    min-height: 120px;
    display: flex;
    align-items: center;
  }

  #choicesContainer {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 0.8rem;
    margin-bottom: 1.5rem;
  }

  #choicesContainer button {
    background: var(--color-bg-light);
    color: var(--color-text-light);
    border: 1px solid var(--color-border);
    padding: 1rem 1.2rem;
    font-size: 1rem;
    font-family: 'Share Tech Mono', monospace;
    text-transform: none; /* No UPPERCASE para las opciones */
    transition: background 0.2s, border-color 0.2s, box-shadow 0.2s;
  }

  #choicesContainer button:hover:not(:disabled) {
    background: #3A3A48;
    border-color: var(--color-primary-blue);
    box-shadow: 0 0 8px var(--color-glow);
    transform: none; /* No lift up */
  }

  #choicesContainer button.correct {
    background: var(--color-accent-green);
    border-color: var(--color-accent-green);
    box-shadow: 0 0 10px rgba(40, 167, 69, 0.6);
  }
  #choicesContainer button.incorrect {
    background: var(--color-accent-red);
    border-color: var(--color-accent-red);
    box-shadow: 0 0 10px rgba(220, 53, 69, 0.6);
  }
  #choicesContainer button.correct::before,
  #choicesContainer button.incorrect::before {
    font-family: 'Share Tech Mono', monospace; /* Para los iconos del check/cross */
    margin-right: 0.5em;
  }

  #resultMessage {
    font-size: 1.1rem;
    font-weight: bold;
    color: var(--color-accent-green); /* Por defecto verde, se cambia a rojo para incorrecto */
    margin-top: 1rem;
    min-height: 1.5em;
    text-shadow: 0 0 8px rgba(40, 167, 69, 0.4);
  }
  #resultMessage.incorrect {
      color: var(--color-accent-red);
      text-shadow: 0 0 8px rgba(220, 53, 69, 0.4);
  }

  #finalScore {
    font-family: 'Orbitron', sans-serif;
    font-size: 2rem;
    color: var(--color-primary-blue);
    text-shadow: 0 0 15px var(--color-glow);
    margin-top: 1.5rem;
    font-weight: 700;
  }

  #navButtons {
    display: flex;
    justify-content: space-between;
    gap: 1rem;
    margin-top: 2rem;
  }

  #navButtons button {
    flex: 1;
    background: var(--color-bg-light);
    border: 1px solid var(--color-border);
    color: var(--color-primary-blue);
    font-size: 1rem;
    padding: 0.8rem 1.5rem;
  }

  #navButtons button:hover:not(:disabled) {
    background: var(--color-primary-blue);
    color: var(--color-text-light);
    border-color: var(--color-primary-blue);
    box-shadow: 0 0 10px var(--color-glow);
  }
  #navButtons button:disabled {
      background: var(--color-bg-light);
      color: var(--color-text-muted);
      border-color: var(--color-border);
  }


  /* --- Pantalla de Estadísticas --- */
  #statsContent {
    text-align: left;
  }
  #statsContent h3 {
    font-family: 'Orbitron', sans-serif;
    font-size: 1.4rem;
    color: var(--color-primary-blue);
    border-bottom: 1px solid var(--color-border);
    padding-bottom: 0.5rem;
    margin-top: 1.5rem;
    margin-bottom: 1rem;
    text-shadow: 0 0 5px var(--color-glow);
  }
  #statsContent ul {
    list-style: none;
    padding: 0;
  }
  #statsContent li {
    background: var(--color-bg-light);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    padding: 0.8rem 1rem;
    margin-bottom: 0.6rem;
    font-size: 0.95rem;
    line-height: 1.4;
    position: relative;
    overflow: hidden;
  }
  #statsContent li::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 4px;
    background-color: var(--color-accent-red); /* Barra roja para fallos */
  }
  #statsContent .no-data {
    color: var(--color-text-muted);
    font-style: italic;
    text-align: center;
    padding: 2rem 0;
  }

  /* --- Pantalla de Generar Test --- */
  #generateTestScreen .form-container {
    text-align: left;
  }
  #generateTestScreen label {
    display: block;
    margin-bottom: 0.6rem;
    font-size: 1rem;
    color: var(--color-text-light);
  }
  #generateTestScreen .checkbox-group {
    margin-bottom: 1.5rem;
  }
  #generateTestScreen .checkbox-group label {
    display: inline-flex;
    align-items: center;
    margin-right: 1.5rem;
    margin-bottom: 0.5rem;
    cursor: pointer;
    font-size: 0.95rem;
  }
  #generateTestScreen .checkbox-group input[type="checkbox"] {
    appearance: none; /* Ocultar checkbox nativo */
    width: 18px;
    height: 18px;
    border: 1px solid var(--color-border);
    border-radius: 3px;
    background-color: var(--color-bg-light);
    margin-right: 0.6rem;
    cursor: pointer;
    position: relative;
    transition: all 0.2s ease;
    flex-shrink: 0;
  }
  #generateTestScreen .checkbox-group input[type="checkbox"]:checked {
    background-color: var(--color-primary-blue);
    border-color: var(--color-primary-blue);
    box-shadow: 0 0 5px var(--color-glow);
  }
  #generateTestScreen .checkbox-group input[type="checkbox"]:checked::after {
    content: '✔';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 14px;
    line-height: 1;
  }
  #generateTestBtn {
    background: var(--color-accent-green);
    width: 100%;
    margin-top: 2rem;
    padding: 1rem;
    font-size: 1.2rem;
  }
  #generateTestBtn:hover {
    background: #1D7A39;
    box-shadow: 0 6px 15px rgba(40, 167, 69, 0.6);
  }

  /* --- Pantalla de Chat Login & Chat Grupal --- */
  #chatLoginScreen .form-group {
    text-align: left;
  }
  #connectChatBtn {
    background: var(--color-accent-green);
    width: 100%;
    margin-top: 2rem;
    padding: 1rem;
    font-size: 1.2rem;
  }
  #connectChatBtn:hover {
    background: #1D7A39;
    box-shadow: 0 6px 15px rgba(40, 167, 69, 0.6);
  }

  #groupChatScreen {
    width: clamp(320px, 95vw, 800px); /* Chat más ancho */
  }

  #chatMessages {
    background: #101015; /* Fondo del área de chat */
    border: 1px solid var(--color-border);
    border-radius: 6px;
    height: 400px;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.7rem;
    margin-bottom: 1rem;
    box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
  }

  .chat-message {
    background: var(--color-bg-light);
    padding: 0.8rem 1.2rem;
    border-radius: 12px;
    max-width: 85%;
    word-wrap: break-word;
    font-size: 0.95rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    border: 1px solid var(--color-border);
  }
  .chat-message.own-message {
    align-self: flex-end;
    background: var(--color-primary-blue);
    color: white;
    border-top-right-radius: 4px; /* Un poco menos redondeado */
  }
  .chat-message.other-message {
    align-self: flex-start;
    background: #3A3A48; /* Otro tono de fondo */
    color: var(--color-text-light);
    border-top-left-radius: 4px; /* Un poco menos redondeado */
  }
  .message-sender {
    font-weight: bold;
    color: var(--color-primary-blue);
    margin-bottom: 0.3rem;
    display: block;
    font-size: 0.8em;
    text-shadow: 0 0 5px var(--color-glow);
  }
  .chat-message.own-message .message-sender {
      color: var(--color-text-light); /* En mensajes propios, el sender es blanco */
      text-shadow: none;
  }
  .chat-input-area {
    display: flex;
    gap: 0.8rem;
    padding-top: 0.5rem;
  }

  #sendChatMessageBtn {
    background: var(--color-primary-blue);
    padding: 0.8rem 1.5rem;
    font-size: 1rem;
    border-radius: 6px;
    text-transform: uppercase;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    body {
      padding: 0.8rem;
      align-items: flex-start; /* Alinea arriba en móviles si hay scroll */
    }
    .screen {
      padding: 1.5rem;
      border-width: 1px;
      margin-top: 1rem;
      margin-bottom: 1rem;
      max-height: calc(100vh - 2rem); /* Ajusta altura máxima */
    }
    h1 {
      font-size: clamp(2rem, 10vw, 3.5rem);
      margin-bottom: 2rem;
    }
    .topbar {
      margin: -1.5rem -1.5rem 1.5rem -1.5rem;
      padding: 0.8rem 1rem;
    }
    .topbar .welcome-text,
    .topbar h2 {
      font-size: clamp(1rem, 5vw, 1.4rem);
    }
    .topbar button {
      padding: 0.4rem 0.8rem;
      font-size: 0.8rem;
    }
    button {
      padding: 0.7rem 1.5rem;
      font-size: 1rem;
    }
    input {
      padding: 0.8rem 1rem;
      font-size: 0.95rem;
    }
    .game-card {
      flex-direction: column;
      align-items: flex-start;
      text-align: center; /* Alinea el texto en el centro si el icono está arriba */
      padding: 1rem;
      gap: 0.8rem;
    }
    .game-card .icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    .game-card .content {
        width: 100%; /* El contenido ocupa todo el ancho restante */
        text-align: left; /* Asegura que el texto esté alineado a la izquierda */
    }
    .game-card .content .title {
      font-size: 1.1rem;
    }
    .game-card .content p {
      font-size: 0.85rem;
    }

    #questionText {
      font-size: 1.05rem;
      padding: 1rem;
      min-height: 90px;
    }
    #choicesContainer button {
      font-size: 0.9rem;
      padding: 0.8rem;
    }
    #finalScore {
      font-size: 1.6rem;
    }
    #navButtons {
      flex-direction: column;
      gap: 0.6rem;
      margin-top: 1.5rem;
    }
    #navButtons button {
      font-size: 0.9rem;
      padding: 0.7rem;
    }
    #statsContent h3 {
      font-size: 1.2rem;
    }
    #statsContent li {
      font-size: 0.85rem;
      padding: 0.6rem 0.8rem;
    }
    #generateTestBtn, #connectChatBtn {
      font-size: 1.1rem;
      padding: 0.9rem;
    }
    #chatMessages {
      height: 300px;
      padding: 0.8rem;
    }
    .chat-input-area {
      flex-direction: column;
      gap: 0.5rem;
    }
    #chatMessageInput {
      margin-bottom: 0;
    }
    #sendChatMessageBtn {
      width: 100%;
      padding: 0.7rem;
      font-size: 0.9rem;
    }
  }

  /* Keyframe animations */
  @keyframes fadeInScale {
    from {
      opacity: 0;
      transform: scale(0.9) translateY(20px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }
  .screen:not(.hidden) {
    animation: fadeInScale 0.5s cubic-bezier(0.25, 0.8, 0.25, 1) forwards;
  }

</style>
<script>
  (() => {
  'use strict';

  // --- Elementos del DOM ---
  const loginScreen = document.getElementById('loginScreen');
  const usernameInput = document.getElementById('usernameInput'); // CORREGIDO
  const passwordInput = document.getElementById('passwordInput'); // CORREGIDO
  const loginBtn = document.getElementById('loginBtn');
  const loginError = document.getElementById('loginError');

  const menuScreen = document.getElementById('menuScreen');
  const logoutBtn = document.getElementById('logoutBtn');
  const gameJefeDirectorCard = document.getElementById('gameJefeDirector');
  const gameLOEXCard = document.getElementById('gameLOEX');
  const gameLO42010Card = document.getElementById('gameLO42010');
  const gameStatsCard = document.getElementById('gameStats');
  const gameGenerateTestCard = document.getElementById('gameGenerateTest');
  const gameChatCard = document.getElementById('gameChat');

  const gameScreen = document.getElementById('gameScreen');
  const gameTitleDisplay = document.getElementById('gameTitle');
  const backToMenuBtn = document.getElementById('backToMenuBtn');
  const timerDisplay = document.getElementById('timerDisplay');
  const questionText = document.getElementById('questionText');
  const choicesContainer = document.getElementById('choicesContainer');
  const resultMessage = document.getElementById('resultMessage');
  const finalScoreDisplay = document.getElementById('finalScore');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');

  const statsScreen = document.getElementById('statsScreen');
  const backToMenuFromStatsBtn = document.getElementById('backToMenuFromStatsBtn');
  const statsContent = document.getElementById('statsContent');

  const generateTestScreen = document.getElementById('generateTestScreen');
  const backToMenuFromGenerateTestBtn = document.getElementById('backToMenuFromGenerateTestBtn');
  const jefeDirectorCheckbox = document.getElementById('jefeDirectorCheckbox');
  const loexCheckbox = document.getElementById('loexCheckbox');
  const lo42010Checkbox = document.getElementById('lo42010Checkbox');
  const numQuestionsInput = document.getElementById('numQuestions');
  const testTimeInput = document.getElementById('testTime');
  const generateTestBtn = document.getElementById('generateTestBtn');
  const generateTestError = document.getElementById('generateTestError');

  const chatLoginScreen = document.getElementById('chatLoginScreen');
  const backToMenuFromChatLoginBtn = document.getElementById('backToMenuFromChatLoginBtn');
  const chatUsernameInput = document.getElementById('chatUsernameInput');
  const connectChatBtn = document.getElementById('connectChatBtn');
  const chatLoginError = document.getElementById('chatLoginError');

  const groupChatScreen = document.getElementById('groupChatScreen');
  const backToMenuFromGroupChatBtn = document.getElementById('backToMenuFromGroupChatBtn');
  const chatMessagesContainer = document.getElementById('chatMessages');
  const chatMessageInput = document.getElementById('chatMessageInput');
  const sendChatMessageBtn = document.getElementById('sendChatMessageBtn');

  // --- Variables de Estado del Juego ---
  let loggedInUser = null;
  let currentScreen = loginScreen;
  let currentGameType = null;
  let currentQuestions = [];
  let currentQuestionIndex = 0;
  let userAnswers = {}; // {questionIndex: selectedChoiceIndex}
  let correctAnswersCount = 0;
  let quizStartTime = 0;
  let quizInterval = null;
  let incorrectQuestionsStats = JSON.parse(localStorage.getItem('incorrectQuestionsStats')) || {};
  let chatUsername = null;
  let chatMessages = []; // For simulated chat

  // --- Datos de los Juegos ---
  const gameData = {
    jefeDirector: {
      title: "Jefe y Director de Seguridad Privada",
      questions: [
        ["Supervisar la seguridad de las instalaciones y personal", "Jefe"],
        ["Tomar decisiones estratégicas a nivel organizativo", "Director"],
        ["Coordinar equipos de seguridad en situaciones de riesgo", "Jefe"],
        ["Definir políticas y normativas internas", "Director"],
        ["Gestionar conflictos internos y externos relacionados con la seguridad", "Jefe"],
        ["Representar a la empresa en reuniones de alto nivel", "Director"],
        ["Elaborar informes de seguridad y auditorías", "Jefe"],
        ["Desarrollar planes de contingencia y emergencia", "Director"],
        ["Implementar medidas de seguridad física", "Jefe"],
        ["Establecer alianzas estratégicas con otras organizaciones", "Director"],
        ["Investigar incidentes de seguridad y proponer soluciones", "Jefe"],
        ["Gestionar el presupuesto del área de seguridad", "Director"],
        ["Formar y capacitar al personal de seguridad", "Jefe"],
        ["Evaluar riesgos y vulnerabilidades de la organización", "Director"],
        ["Mantener la disciplina y el orden del personal a su cargo", "Jefe"],
        ["Diseñar la estructura del departamento de seguridad", "Director"]
      ],
      choices: ["Jefe", "Director"]
    },
    loex: {
      title: "Infracciones LOEX",
      questions: [
        // INFRACCIONES LEVES
        ["La omisión o el retraso en la comunicación a las autoridades españolas de los cambios de nacionalidad, estado civil o de domicilio, así como de otras circunstancias determinantes de su situación laboral cuando les sean exigibles por la normativa aplicable.", "Leve"],
        ["El retraso, hasta tres meses, en la solicitud de renovación de las autorizaciones una vez hayan caducado.", "Leve"],
        ["Encontrarse trabajando en España sin haber solicitado autorización administrativa para trabajar por cuenta propia, cuando se cuente con autorización de residencia temporal.", "Leve"],
        ["Encontrarse trabajando en una ocupación, sector de actividad, o ámbito geográfico no contemplado por la autorización de residencia y trabajo de la que se es titular.", "Leve"],
        ["La contratación de personas trabajadoras cuya autorización no les habilita para trabajar en esa ocupación o ámbito geográfico, incurriéndose en una infracción por cada una de las personas trabajadoras extranjeras ocupadas.", "Leve"],
        ["La ausencia de comunicación a la autoridad pública por parte de las entidades cuyo objeto se refiera total o parcialmente a la atención de personas menores de edad extranjeras no acompañadas, así como de las personas que actúen en su representación o encuadradas en su actividad de manera habitual, de la localización de personas menores de edad extranjeras no acompañadas a fin de que pueda procederse en consecuencia.", "Leve"],
        ["La no presentación injustificada, sin causa o razón válida, a los requerimientos de la Delegación o Subdelegación del Gobierno por parte de la persona extranjera interesada, y que se realice de forma reiterada, tras dos notificaciones debidamente practicadas en las que no se haya obtenido respuesta. Se entenderá que existe una razón válida para la no comparecencia cuando la persona interesada acredite de forma fehaciente una circunstancia que imposibilite su presencia o justifique que la misma no es obligatoria. En todo caso, la carga de la prueba corresponderá a la persona interesada.", "Leve"],
        ["La inobservancia de la obligación de poner en conocimiento de la autoridad competente el extravío, la destrucción, la sustracción o la inutilización del pasaporte o documento de viaje, del visado, de la Tarjeta de Identidad de Extranjero o de cualquier otro documento análogo, siempre que de ello no se derive perjuicio grave para el servicio público o para la acreditación de la identidad de la persona interesada.", "Leve"],
        ["La inobservancia de la obligación de comunicar a la autoridad competente la pérdida, extravío o inutilización del pasaporte o documento de viaje, del visado, de la Tarjeta de Identidad de Extranjero o de cualquier otro documento análogo, así como no denunciar la sustracción de los mismos. El incumplimiento de esta obligación cuando dé lugar a un perjuicio grave para la seguridad pública, podrá dar lugar a la calificación de la infracción como grave o muy grave, en función de la gravedad de los hechos.", "Leve"],
        ["La omisión o el retraso en la comunicación a la autoridad pública de los cambios de nacionalidad, estado civil o de domicilio, así como de otras circunstancias determinantes de su situación laboral cuando les sean exigibles por la normativa aplicable.", "Leve"],
        // INFRACCIONES GRAVES
        ["Encontrarse irregularmente en territorio español, por no haber obtenido la prórroga de estancia, carecer de autorización de residencia o tener caducada más de tres meses la mencionada autorización, y siempre que la persona interesada no hubiere solicitado la renovación de la misma en el plazo previsto reglamentariamente.", "Grave"],
        ["Encontrarse trabajando en España sin haber obtenido autorización de trabajo o autorización administrativa previa para trabajar, cuando no cuente con autorización de residencia válida.", "Grave"],
        ["Incurrir en ocultación dolosa o falsedad grave en el cumplimiento de la obligación de poner en conocimiento de las autoridades competentes los cambios que afecten a nacionalidad, estado civil o domicilio, así como incurrir en falsedad en la declaración de los datos obligatorios para cumplimentar el alta en el padrón municipal, siempre que tales hechos no constituyan delito. Cuando cualquier autoridad tuviera conocimiento de una posible infracción por esta causa, lo pondrá en conocimiento de las autoridades competentes con el fin de que pueda instruirse el oportuno expediente sancionador.", "Grave"],
        ["El incumplimiento de las medidas impuestas por razón de seguridad pública, de presentación periódica o de alejamiento de fronteras o núcleos de población concretados singularmente.", "Grave"],
        ["La comisión de una tercera infracción leve, siempre que la persona extranjera hubiera sido sancionada por dos infracciones leves anteriores, en el plazo de un año. Se entenderá que existe reincidencia cuando la persona extranjera hubiera sido sancionada por dos infracciones leves anteriores, siempre que no hayan transcurrido más de seis meses desde la última sanción y que la nueva infracción no hubiera prescrito.", "Grave"],
        ["El ocultamiento de información o la falsedad en la declaración de los datos relativos a la situación laboral de las personas trabajadoras extranjeras, a fin de obtener los beneficios previstos en esta ley para las personas empleadoras.", "Grave"],
        ["Simular la relación laboral para obtener una autorización de residencia o la prórroga de la misma, o para obtener una autorización de trabajo, ya sea por cuenta propia o ajena.", "Grave"],
        ["La falsedad en el padrón municipal de las personas extranjeras, con el fin de obtener algún beneficio de la Ley, o de dificultar su aplicación. Cuando cualquier autoridad tuviera conocimiento de una posible infracción por esta causa, lo pondrá en conocimiento de las autoridades competentes con el fin de que pueda instruirse el oportuno expediente sancionador.", "Grave"],
        ["No dar de alta a la persona trabajadora extranjera en el régimen correspondiente de la Seguridad Social, cuando así se establezca en la normativa de aplicación.", "Grave"],
        ["La contratación de personas trabajadoras extranjeras sin haberles solicitado la correspondiente autorización de trabajo, o cuando la autorización no les habilite para trabajar en esa ocupación o ámbito geográfico, incurriéndose en una infracción por cada una de las personas trabajadoras extranjeras ocupadas.", "Grave"],
        // INFRACCIONES MUY GRAVES
        ["Participar en actividades contrarias a la seguridad nacional o que puedan perjudicar las relaciones de España con otros países.", "Muy Grave"],
        ["Inducir, promover, favorecer o facilitar con ánimo de lucro, individualmente o formando parte de una organización, la inmigración clandestina de personas extranjeras en tránsito o con destino a España o su permanencia irregular en territorio español. No se entenderá que existe ánimo de lucro cuando el objetivo sea prestar asistencia humanitaria, para lo que se tendrá en cuenta la relación entre la persona facilitadora y la persona facilitada, el contexto en el que se desarrolla la acción, la finalidad perseguida y la situación de vulnerabilidad en la que se encuentre la persona facilitada.", "Muy Grave"],
        ["La comisión de una tercera infracción grave, siempre que la persona extranjera hubiera sido sancionada por dos infracciones graves anteriores, en el plazo de un año.", "Muy Grave"],
        ["Emplear a personas trabajadoras extranjeras sin haber obtenido la preceptiva autorización de trabajo, o sin haber dado de alta en la Seguridad Social cuando así se establezca en la normativa de aplicación, incurriéndose en una infracción por cada una de las personas trabajadoras extranjeras ocupadas.", "Muy Grave"],
        ["La simulación de la relación laboral o la presentación de contratos de trabajo o de ofertas de empleo fraudulentos, con la finalidad de obtener una autorización de residencia o la prórroga de la misma, o para obtener una autorización de trabajo, ya sea por cuenta propia o ajena.", "Muy Grave"],
        ["Alteración o falsificación de documentos utilizados para obtener visados o autorizaciones, ya sea por la persona extranjera o por su representante.", "Muy Grave"],
        ["La participación en actividades que atenten contra la seguridad pública, el orden público, la salud pública o la integridad de las personas.", "Muy Grave"],
        ["La estancia en España en condiciones que contravengan lo dispuesto en la presente Ley.", "Muy Grave"]
      ],
      choices: ["Leve", "Grave", "Muy Grave"]
    },
    // NUEVO: Objeto para el juego "Infracciones L.O 4/2010"
    lo42010: {
      title: "Infracciones L.O 4/2010",
      questions: [
        // Faltas Muy Graves
        ["El incumplimiento del deber de fidelidad a la Constitución en el ejercicio de las funciones.", "Muy Grave"],
        ["Haber sido condenado en virtud de sentencia firme por un delito doloso relacionado con el servicio o que cause grave daño a la Administración o a las personas.", "Muy Grave"],
        ["El abuso de atribuciones que cause grave daño a los ciudadanos, a los subordinados, a la Administración o a las entidades con personalidad jurídica.", "Muy Grave"],
        ["La práctica de tratos inhumanos, degradantes, discriminatorios o vejatorios a los ciudadanos que se encuentren bajo custodia policial.", "Muy Grave"],
        ["La insubordinación individual o colectiva, respecto a las Autoridades o mandos de que dependan.", "Muy Grave"],
        ["El abandono de servicio, salvo que exista causa de fuerza mayor que impida comunicar a un superior dicho abandono.", "Muy Grave"],
        ["La publicación o la utilización indebida de secretos oficiales, declarados así con arreglo a la legislación específica en la materia.", "Muy Grave"],
        ["La violación del secreto profesional cuando perjudique el desarrollo de la labor policial, a cualquier ciudadano o a las entidades con personalidad jurídica.", "Muy Grave"],
        ["El incumplimiento de las normas sobre incompatibilidades cuando ello dé lugar a una situación de incompatibilidad.", "Muy Grave"],
        ["La participación en huelgas, en acciones sustitutivas de estas o en actuaciones concertadas con el fin de alterar el normal funcionamiento de los servicios.", "Muy Grave"],
        ["La falta de colaboración manifiesta con otros miembros de las Fuerzas y Cuerpos de Seguridad, cuando resulte perjudicado gravemente el servicio o se deriven consecuencias graves para la seguridad ciudadana.", "Muy Grave"],
        ["Embriagarse o consumir drogas tóxicas, estupefacientes o sustancias psicotrópicas durante el servicio o realizarlo en estado de embriaguez o bajo los efectos manifiestos de los productos citados.", "Muy Grave"],
        ["La negativa injustificada a someterse a reconocimiento médico, prueba de alcoholemia o de detección de drogas tóxicas, estupefacientes o sustancias psicotrópicas, legítimamente ordenadas, a fin de constatar la capacidad psicofísica para prestar servicio.", "Muy Grave"],
        ["Toda actuación que suponga discriminación por razón de origen racial o étnico, religión o convicciones, discapacidad, edad u orientación sexual, sexo, lengua, opinión, lugar de nacimiento o vecindad, o cualquier otra condición o circunstancia personal o social.", "Muy Grave"],
        ["El acoso sexual y el acoso laboral, consistente este último en la realización reiterada, en el marco de una relación de servicio, de actos de acoso psicológico u hostilidad.", "Muy Grave"],
        ["La obstaculización grave al ejercicio de las libertades públicas y derechos sindicales.", "Muy Grave"],
        ["Las infracciones tipificadas como muy graves en la legislación sobre utilización de videocámaras por las Fuerzas y Cuerpos de Seguridad en lugares públicos.", "Muy Grave"],
        // Faltas Graves
        ["La grave desconsideración con los superiores, compañeros, subordinados o ciudadanos, en el ejercicio de sus funciones o cuando cause descrédito notorio a la Institución Policial.", "Grave"],
        ["La desobediencia a los superiores jerárquicos o los responsables del servicio con motivo de las órdenes o instrucciones legítimas dadas por aquéllos, salvo que constituyan infracción manifiesta del ordenamiento jurídico.", "Grave"],
        ["La omisión de la obligación de dar cuenta a la superioridad con la debida diligencia de todo asunto que por su entidad requiera su conocimiento o decisión urgente.", "Grave"],
        ["La falta de presentación o puesta a disposición inmediata de la dependencia donde estuviera destinado, o en la más próxima, en los casos de declaración de los estados de excepción o sitio o, cuando así se disponga, en caso de alteración grave de la seguridad ciudadana; o, en los casos de declaración del estado de alarma, la no presentación cuando sean emplazados para ello, de acuerdo con lo dispuesto por la autoridad competente.", "Grave"],
        ["La tercera falta injustificada de asistencia al servicio en un período de tres meses cuando las dos anteriores hubieran sido objeto de sanción firme por falta leve.", "Grave"],
        ["No prestar servicio, alegando supuesta enfermedad.", "Grave"],
        ["La falta de rendimiento reiterada que ocasione un perjuicio a los ciudadanos, a las entidades con personalidad jurídica o a la eficacia de los servicios.", "Grave"],
        ["El abuso de atribuciones cuando no constituya falta muy grave.", "Grave"],
        ["La desconsideración con los superiores, compañeros, subordinados o ciudadanos, en el ejercicio de sus funciones.", "Grave"],
        ["El incumplimiento de órdenes o instrucciones legítimas dadas por los superiores o responsables del servicio, salvo que constituyan infracción manifiesta del ordenamiento jurídico.", "Grave"],
        ["El incumplimiento de la obligación de dar cuenta a la superioridad con la debida diligencia de todo asunto que por su entidad requiera su conocimiento o decisión urgente.", "Grave"],
        ["El abandono de servicio sin causa justificada, cuando no constituya falta muy grave.", "Grave"],
        ["La utilización de emblemas, uniformes o distintivos de la Institución Policial sin autorización, o su uso indebido.", "Grave"],
        ["El consumo de bebidas alcohólicas durante el servicio o en estado de embriaguez, si no constituye falta muy grave.", "Grave"],
        ["La falta de colaboración con otros miembros de las Fuerzas y Cuerpos de Seguridad, cuando no resulte gravemente perjudicado el servicio o se deriven consecuencias graves para la seguridad ciudadana.", "Grave"],
        ["La divulgación de asuntos o informaciones de la Institución Policial que no hayan sido previamente autorizados para su publicación.", "Grave"],
        ["La participación en juegos de azar o apuestas durante el servicio, si no constituyen delito.", "Grave"],
        ["El incumplimiento de las normas sobre incompatibilidades, cuando no dé lugar a una situación de incompatibilidad.", "Grave"],
        ["La reiteración en faltas leves.", "Grave"],
        ["La inobservancia de la obligación de poner en conocimiento de la superioridad los cambios de domicilio, de situación familiar o de cualquier otra circunstancia personal que afecte al servicio.", "Grave"],
        ["El no hallarse en condiciones psicofísicas adecuadas para el desempeño del servicio, cuando ello sea imputable al funcionario y no constituya falta muy grave.", "Grave"],
        ["Las infracciones tipificadas como graves en la legislación sobre utilización de videocámaras por las Fuerzas y Cuerpos de Seguridad en lugares públicos.", "Grave"],
        // Faltas Leves
        ["La ligera desconsideración con los superiores, compañeros, subordinados o ciudadanos, en el ejercicio de sus funciones.", "Leve"],
        ["El retraso o la negligencia en el cumplimiento de los deberes, cuando no constituya falta grave o muy grave.", "Leve"],
        ["La incorrección con el público o con los compañeros o subordinados.", "Leve"],
        ["El incumplimiento injustificado del horario de trabajo, cuando no constituya falta grave.", "Leve"],
        ["La falta de aseo y compostura personal.", "Leve"],
        ["La no utilización del uniforme reglamentario o su uso incorrecto, cuando así se establezca.", "Leve"],
        ["El descuido en la conservación de los útiles, mobiliario o material de la Institución Policial.", "Leve"],
        ["Las infracciones tipificadas como leves en la legislación sobre utilización de videocámaras por las Fuerzas y Cuerpos de Seguridad en lugares públicos.", "Leve"]
      ],
      choices: ["Leve", "Grave", "Muy Grave"]
    }
  };

  // --- Funciones de Utilidad ---
  function showScreen(screenId) {
    const screens = document.querySelectorAll('.screen');
    screens.forEach(screen => {
      if (screen) { // Añadido chequeo de existencia
        screen.classList.add('hidden');
      }
    });
    const targetScreen = document.getElementById(screenId);
    if (targetScreen) { // Añadido chequeo de existencia
      targetScreen.classList.remove('hidden');
    }
    // Asegurarse de que el scroll esté arriba al cambiar de pantalla
    if (targetScreen && targetScreen.id !== 'gameScreen') { // Evitar scroll en gameScreen para mantener posición
        targetScreen.scrollTop = 0;
    }
  }

  function showMessage(element, message, type = 'error') {
    if (element) { // Añadido chequeo de existencia
      element.textContent = message;
      element.className = 'error-message ' + type;
    }
  }

  function clearMessage(element) {
    if (element) { // Añadido chequeo de existencia
      element.textContent = '';
      element.className = 'error-message'; // Restablece la clase base
    }
  }

  // --- Funciones de Navegación y Lógica Principal ---
  function login() {
    clearMessage(loginError);
    const username = usernameInput ? usernameInput.value : '';
    const password = passwordInput ? passwordInput.value : '';

    if (username === 'admin' && password === 'admin') {
      loggedInUser = username;
      showMenu('Bienvenido, ' + loggedInUser);
    } else {
      showMessage(loginError, 'Credenciales incorrectas.');
    }
  }

  function showMenu(welcomeText) {
    showScreen('menuScreen');
    const welcomeDisplay = document.querySelector('#menuScreen .topbar .welcome-text');
    if (welcomeDisplay) { // Añadido chequeo de existencia
      welcomeDisplay.textContent = welcomeText;
    }
  }

  function startGame(gameType) {
    currentGameType = gameType;
    currentQuestions = generateQuestions(gameType, numQuestionsInput ? parseInt(numQuestionsInput.value) : 10);
    if (currentQuestions.length === 0) {
      showMessage(generateTestError, 'No se pudieron generar preguntas con los criterios seleccionados.');
      return;
    }
    currentQuestionIndex = 0;
    userAnswers = {};
    correctAnswersCount = 0;
    showScreen('gameScreen');
    if (gameTitleDisplay) { // Añadido chequeo de existencia
        gameTitleDisplay.textContent = gameData[gameType].title;
    }
    startQuizTimer(testTimeInput ? parseInt(testTimeInput.value) : 10);
    displayQuestion();
  }

  function displayQuestion() {
    clearMessage(resultMessage);
    if (currentQuestions.length === 0) {
      questionText.textContent = 'No hay preguntas disponibles.';
      choicesContainer.innerHTML = '';
      return;
    }

    const question = currentQuestions[currentQuestionIndex];
    if (questionText) { // Añadido chequeo de existencia
        questionText.textContent = `${currentQuestionIndex + 1}. ${question[0]}`;
    }

    if (choicesContainer) { // Añadido chequeo de existencia
        choicesContainer.innerHTML = '';
        gameData[currentGameType].choices.forEach((choice, index) => {
            const button = document.createElement('button');
            button.textContent = choice;
            button.onclick = () => selectAnswer(index);
            choicesContainer.appendChild(button);
        });
    }

    // Resaltar respuesta seleccionada previamente
    if (userAnswers[currentQuestionIndex] !== undefined) {
      const buttons = choicesContainer ? choicesContainer.querySelectorAll('button') : [];
      if (buttons[userAnswers[currentQuestionIndex]]) {
        buttons[userAnswers[currentQuestionIndex]].classList.add('selected');
      }
    }

    updateNavButtons();
  }

  function selectAnswer(selectedIndex) {
    const question = currentQuestions[currentQuestionIndex];
    const correctIndex = gameData[currentGameType].choices.indexOf(question[1]);

    userAnswers[currentQuestionIndex] = selectedIndex;

    const buttons = choicesContainer ? choicesContainer.querySelectorAll('button') : [];
    buttons.forEach((button, index) => {
      button.disabled = true; // Deshabilita todos los botones una vez que se selecciona una respuesta
      if (index === correctIndex) {
        button.classList.add('correct');
      } else if (index === selectedIndex) {
        button.classList.add('incorrect');
      }
    });

    if (selectedIndex === correctIndex) {
      showMessage(resultMessage, '¡Correcto!', 'success');
    } else {
      showMessage(resultMessage, 'Incorrecto. La respuesta correcta era: ' + question[1], 'error');
      // Registrar pregunta incorrecta
      const qKey = `${currentGameType}-${question[0]}`;
      incorrectQuestionsStats[qKey] = (incorrectQuestionsStats[qKey] || 0) + 1;
      localStorage.setItem('incorrectQuestionsStats', JSON.stringify(incorrectQuestionsStats));
    }
    updateNavButtons(); // Permite navegación inmediata si se selecciona respuesta
  }

  function updateNavButtons() {
    if (prevBtn) { // Añadido chequeo de existencia
      prevBtn.disabled = currentQuestionIndex === 0;
    }
    if (nextBtn) { // Añadido chequeo de existencia
      nextBtn.disabled = currentQuestionIndex === currentQuestions.length - 1 && userAnswers[currentQuestionIndex] !== undefined;
      // El botón "Siguiente" se deshabilita solo en la última pregunta si ya se respondió
    }
    // Si la última pregunta está respondida, el botón "Siguiente" debería ser "Finalizar"
    if (nextBtn && currentQuestionIndex === currentQuestions.length - 1) {
        if (userAnswers[currentQuestionIndex] !== undefined) {
            nextBtn.textContent = 'FINALIZAR';
            nextBtn.onclick = finishQuiz;
        } else {
            nextBtn.textContent = 'Siguiente';
            nextBtn.onclick = showNextQuestion;
        }
    } else if (nextBtn) {
        nextBtn.textContent = 'Siguiente';
        nextBtn.onclick = showNextQuestion;
    }
  }

  function showNextQuestion() {
    if (currentQuestionIndex < currentQuestions.length - 1) {
      currentQuestionIndex++;
      displayQuestion();
    } else {
        // Si ya está en la última pregunta y el botón es "Siguiente", significa que no se ha respondido
        // Si ya está en la última pregunta y el botón es "Finalizar", ya se manejó con finishQuiz
    }
  }

  function showPreviousQuestion() {
    if (currentQuestionIndex > 0) {
      currentQuestionIndex--;
      displayQuestion();
    }
  }

  function finishQuiz() {
    clearInterval(quizInterval);
    correctAnswersCount = 0;
    currentQuestions.forEach((question, index) => {
      const selectedAnswerIndex = userAnswers[index];
      if (selectedAnswerIndex !== undefined) {
        const correctAnswer = question[1];
        const selectedChoice = gameData[currentGameType].choices[selectedAnswerIndex];
        if (selectedChoice === correctAnswer) {
          correctAnswersCount++;
        }
      }
    });

    showScreen('gameResultsScreen'); // Asegúrate de que tienes una pantalla con este ID
    if (finalScoreDisplay) { // Añadido chequeo de existencia
        finalScoreDisplay.textContent = `Puntuación Final: ${correctAnswersCount} / ${currentQuestions.length}`;
    }
    // Puedes añadir más lógica aquí para guardar resultados o mostrar detalles
  }

  function startQuizTimer(minutes) {
    if (quizInterval) {
      clearInterval(quizInterval);
    }
    quizStartTime = Date.now();
    const endTime = quizStartTime + minutes * 60 * 1000;

    quizInterval = setInterval(() => {
      const timeLeft = endTime - Date.now();
      if (timeLeft <= 0) {
        clearInterval(quizInterval);
        if (timerDisplay) { // Añadido chequeo de existencia
            timerDisplay.textContent = '00:00';
        }
        finishQuiz();
        return;
      }
      const totalSeconds = Math.floor(timeLeft / 1000);
      const minutesLeft = Math.floor(totalSeconds / 60);
      const secondsLeft = totalSeconds % 60;
      const formattedTime = `${String(minutesLeft).padStart(2, '0')}:${String(secondsLeft).padStart(2, '0')}`;
      if (timerDisplay) { // Añadido chequeo de existencia
          timerDisplay.textContent = formattedTime;
      }
    }, 1000);
  }

  function showStats() {
    showScreen('statsScreen');
    if (statsContent) { // Añadido chequeo de existencia
        statsContent.innerHTML = '<h3>Preguntas Falladas Frecuentemente</h3>';
        const statsList = document.createElement('ul');
        const sortedStats = Object.entries(incorrectQuestionsStats).sort(([, a], [, b]) => b - a);

        if (sortedStats.length === 0) {
            statsList.innerHTML = '<li class="no-data">No hay datos de preguntas falladas.</li>';
        } else {
            sortedStats.forEach(([question, count]) => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>${question.split('-')[0]}:</strong> ${question.split('-')[1]} <br> <small>Fallada ${count} veces</small>`;
                statsList.appendChild(li);
            });
        }
        statsContent.appendChild(statsList);
    }
  }

  function showGenerateTest() {
    showScreen('generateTestScreen');
    clearMessage(generateTestError);
    // Reiniciar checkboxes a un estado por defecto si es necesario
    if (jefeDirectorCheckbox) jefeDirectorCheckbox.checked = true;
    if (loexCheckbox) loexCheckbox.checked = true;
    if (lo42010Checkbox) lo42010Checkbox.checked = true;
    if (numQuestionsInput) numQuestionsInput.value = 10;
    if (testTimeInput) testTimeInput.value = 10;
  }

  function generateCustomTest() {
    clearMessage(generateTestError);
    const selectedTypes = [];
    if (jefeDirectorCheckbox && jefeDirectorCheckbox.checked) selectedTypes.push('jefeDirector');
    if (loexCheckbox && loexCheckbox.checked) selectedTypes.push('loex');
    if (lo42010Checkbox && lo42010Checkbox.checked) selectedTypes.push('lo42010');

    if (selectedTypes.length === 0) {
      showMessage(generateTestError, 'Selecciona al menos un tipo de juego.', 'error');
      return;
    }

    const numQuestions = numQuestionsInput ? parseInt(numQuestionsInput.value) : 0;
    const testTime = testTimeInput ? parseInt(testTimeInput.value) : 0;

    if (isNaN(numQuestions) || numQuestions <= 0) {
      showMessage(generateTestError, 'Número de preguntas inválido.', 'error');
      return;
    }
    if (isNaN(testTime) || testTime <= 0) {
      showMessage(generateTestError, 'Tiempo límite inválido.', 'error');
      return;
    }

    // Generar preguntas de los tipos seleccionados
    let allPossibleQuestions = [];
    selectedTypes.forEach(type => {
      if (gameData[type] && gameData[type].questions) {
        allPossibleQuestions = allPossibleQuestions.concat(gameData[type].questions.map(q => [q[0], q[1], type])); // Añadir tipo para seguimiento
      }
    });

    if (allPossibleQuestions.length < numQuestions) {
      showMessage(generateTestError, `No hay suficientes preguntas (${allPossibleQuestions.length}) para generar un test de ${numQuestions} preguntas.`, 'error');
      return;
    }

    // Mezclar y seleccionar un subconjunto de preguntas
    const shuffledQuestions = allPossibleQuestions.sort(() => 0.5 - Math.random());
    const finalQuestions = shuffledQuestions.slice(0, numQuestions);

    // Iniciar el juego con las preguntas generadas
    currentGameType = 'custom'; // Tipo de juego personalizado
    gameData.custom = { // Definir un tipo de juego 'custom' temporalmente
        title: "Evaluación Personalizada",
        questions: finalQuestions,
        choices: ["Leve", "Grave", "Muy Grave", "Jefe", "Director"] // Asegurarse de tener todas las opciones posibles
    };

    startGame('custom');
  }

  function generateQuestions(type, count) {
    if (!gameData[type] || !gameData[type].questions) {
      console.error('Tipo de juego no encontrado:', type);
      return [];
    }
    const allQuestions = gameData[type].questions;
    const shuffled = allQuestions.sort(() => 0.5 - Math.random());
    return shuffled.slice(0, count);
  }

  // --- Funciones de Chat ---
  function showChatLogin() {
    showScreen('chatLoginScreen');
    clearMessage(chatLoginError);
    if (chatUsernameInput) { // Añadido chequeo de existencia
        chatUsernameInput.value = '';
    }
  }

  function connectChat() {
    clearMessage(chatLoginError);
    const username = chatUsernameInput ? chatUsernameInput.value.trim() : '';
    if (username.length < 3) {
      showMessage(chatLoginError, 'El identificador de agente debe tener al menos 3 caracteres.', 'error');
      return;
    }
    chatUsername = username;
    showScreen('groupChatScreen');
    if (chatMessagesContainer) { // Añadido chequeo de existencia
        chatMessagesContainer.innerHTML = ''; // Limpiar mensajes anteriores
    }
    chatMessages = []; // Resetear el historial de chat
    appendChatMessage('Sistema', `Bienvenido al chat de operaciones, ${chatUsername}.`, 'system');
  }

  function appendChatMessage(sender, message, type = 'other-message') {
    if (!chatMessagesContainer) return; // Salir si el contenedor no existe

    const messageElement = document.createElement('div');
    messageElement.classList.add('chat-message', type);

    const senderElement = document.createElement('span');
    senderElement.classList.add('message-sender');
    senderElement.textContent = sender;
    messageElement.appendChild(senderElement);

    const textElement = document.createElement('p');
    textElement.textContent = message;
    messageElement.appendChild(textElement);

    chatMessagesContainer.appendChild(messageElement);
    chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight; // Scroll automático
    chatMessages.push({ sender, message, type }); // Guardar para historial simulado
  }

  function sendChatMessage() {
    const message = chatMessageInput ? chatMessageInput.value.trim() : '';
    if (message.length === 0) return;

    appendChatMessage(chatUsername, message, 'own-message');
    if (chatMessageInput) { // Añadido chequeo de existencia
        chatMessageInput.value = '';
    }

    // Simular respuesta del sistema o de otro agente
    setTimeout(() => {
      const responses = [
        "Mensaje recibido. Procesando solicitud...",
        "Entendido, Agente. Reconfigurando parámetros.",
        "Confirmado. El equipo está en ello.",
        "Negativo, Agente. Se requiere más información.",
        "Afirmativo. Operación en curso."
      ];
      const randomResponse = responses[Math.floor(Math.random() * responses.length)];
      appendChatMessage('Sistema', randomResponse, 'other-message');
    }, 1500);
  }


  // --- Inicialización y Event Listeners ---
  document.addEventListener('DOMContentLoaded', () => {
    // Inicializar el sistema mostrando la pantalla de login
    showLogin();

    if (loginBtn) { // Añadido chequeo de existencia
      loginBtn.addEventListener('click', login);
    }
    if (usernameInput) { // Añadido chequeo de existencia
      usernameInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
              login();
          }
      });
    }
    if (passwordInput) { // Añadido chequeo de existencia
      passwordInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
              login();
          }
      });
    }

    if (logoutBtn) { logoutBtn.addEventListener('click', showLogin); }
    if (backToMenuBtn) { backToMenuBtn.addEventListener('click', () => showMenu('Bienvenido, ' + (loggedInUser || 'Agente'))); }
    if (backToMenuFromStatsBtn) { backToMenuFromStatsBtn.addEventListener('click', () => showMenu('Bienvenido, ' + (loggedInUser || 'Agente'))); }
    if (backToMenuFromGenerateTestBtn) { backToMenuFromGenerateTestBtn.addEventListener('click', () => showMenu('Bienvenido, ' + (loggedInUser || 'Agente'))); }
    if (backToMenuFromChatLoginBtn) { backToMenuFromChatLoginBtn.addEventListener('click', () => showMenu('Bienvenido, ' + (loggedInUser || 'Agente'))); }
    if (backToMenuFromGroupChatBtn) { backToMenuFromGroupChatBtn.addEventListener('click', () => showMenu('Bienvenido, ' + (loggedInUser || 'Agente'))); }

    if (gameJefeDirectorCard) { gameJefeDirectorCard.addEventListener('click', () => startGame('jefeDirector')); }
    if (gameLOEXCard) { gameLOEXCard.addEventListener('click', () => startGame('loex')); }
    if (gameLO42010Card) { gameLO42010Card.addEventListener('click', () => startGame('lo42010')); }
    if (gameStatsCard) { gameStatsCard.addEventListener('click', showStats); }
    if (gameGenerateTestCard) { gameGenerateTestCard.addEventListener('click', showGenerateTest); }
    if (gameChatCard) { gameChatCard.addEventListener('click', showChatLogin); }

    if (prevBtn) { prevBtn.addEventListener('click', showPreviousQuestion); }
    if (nextBtn) { nextBtn.addEventListener('click', showNextQuestion); }
    if (generateTestBtn) { generateTestBtn.addEventListener('click', generateCustomTest); }
    if (connectChatBtn) { connectChatBtn.addEventListener('click', connectChat); }
    if (sendChatMessageBtn) { sendChatMessageBtn.addEventListener('click', sendChatMessage); }
    if (chatMessageInput) { // Añadido chequeo de existencia
      chatMessageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendChatMessage();
        }
      });
    }
  });

})(); // Fin de la IIFE (Immediately Invoked Function Expression)
</script>
</body>
</html>
