<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PULIPOL - Sistema de Capacitaci√≥n Policial</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&amp;family=Share+Tech+Mono&amp;display=swap" rel="stylesheet">
<style>
  /* Variables CSS para una paleta policial oscura y tecnol√≥gica */
  :root {
    --color-bg-dark: #0A0A0E; /* Fondo muy oscuro, casi negro */
    --color-bg-medium: #1A1A22; /* Fondo de contenedores principales */
    --color-bg-light: #2A2A38; /* Fondo de elementos secundarios, inputs */
    --color-primary-blue: #007BFF; /* Azul distintivo para interacci√≥n/resaltado */
    --color-accent-red: #DC3545; /* Rojo para alertas/errores */
    --color-accent-green: #28A745; /* Verde para √©xito */
    --color-text-light: #E0E6EB; /* Texto claro general */
    --color-text-muted: #8F9BB3; /* Texto secundario, descripciones */
    --color-border: #3A3A48; /* Bordes sutiles */
    --color-border-active: #007BFF; /* Borde activo/foco */
    --color-glow: rgba(0, 123, 255, 0.4); /* Resplandor azul */
    --color-shadow: rgba(0, 0, 0, 0.6); /* Sombra de elementos */
    --color-overlay: rgba(0, 0, 0, 0.8); /* Overlay oscuro */
  }

  /* Reset y estilos base */
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  html, body {
    height: 100%;
    overflow: hidden; /* Controlar el desbordamiento principal */
  }

  body {
    font-family: 'Share Tech Mono', monospace; /* Fuente monospace para un toque tech */
    background: radial-gradient(circle at top left, var(--color-bg-medium) 0%, var(--color-bg-dark) 70%);
    color: var(--color-text-light);
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 1rem;
    position: relative;
    overflow-y: auto; /* Permitir scroll solo si el contenido excede la altura */
  }

  /* Efecto de ruido de fondo sutil */
  body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: url('data:image/svg+xml;base64,PHN2ZyB2aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZmlsdGVyIGlkPSJuIj48ZmVUdXJibHVuY2UgdHlwZT0iZnJhY3RhbE5vaXNlIiBiYXNlRnJlcXVlbmN5PSIuNSIgbnVtT2N0YXZlcz0iMyIgc2VhbT0idHJ1ZSIgbGltaXRpbmc9IjEiLz48d2VzRGlmZnVzZSB4PSIxMDAiIHk9IjEwMCIgcmVzdWx0PSJpIi8+PHBhdGggZD0iTTAgMGgyMDB2LTIwMGgyMDB2LTIwMCIvPjwvZmlsdGVyPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9IiMwMDAiIGZpbHRlcj0idXJsKCNuKSIgb3BhY2l0eT0iLjEiLz48L3N2Zz4=') repeat;
    opacity: 0.1;
    pointer-events: none;
    z-index: -1;
  }

  /* Contenedor principal de pantallas */
  .screen {
    background: var(--color-bg-medium);
    border: 2px solid var(--color-border);
    border-radius: 8px;
    box-shadow: 0 0 20px var(--color-shadow), inset 0 0 15px rgba(0, 123, 255, 0.05);
    padding: 2.5rem;
    width: clamp(320px, 95vw, 700px); /* Ancho adaptable */
    max-height: 95vh;
    overflow-y: auto; /* Scrollable if content overflows */
    text-align: center;
    position: relative;
    transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
    transform-origin: center center;
  }

  .hidden {
    opacity: 0;
    transform: scale(0.9) translateY(20px);
    pointer-events: none;
    position: absolute; /* Para que no ocupe espacio cuando est√° oculto */
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%) scale(0.9);
  }

  /* T√≠tulo de la aplicaci√≥n */
  h1 {
    font-family: 'Orbitron', sans-serif;
    font-size: clamp(2.5rem, 8vw, 4.5rem); /* T√≠tulo responsive */
    color: var(--color-primary-blue);
    text-shadow: 0 0 15px var(--color-glow);
    margin-bottom: 2.5rem;
    letter-spacing: 3px;
    line-height: 1.1;
  }

  /* Estilos de botones generales */
  button {
    background: var(--color-primary-blue);
    color: var(--color-text-light);
    border: none;
    padding: 0.8rem 1.8rem;
    border-radius: 6px;
    font-family: 'Orbitron', sans-serif;
    font-size: 1.1rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 1px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
  }

  button:hover:not(:disabled) {
    background: #0056B3;
    box-shadow: 0 6px 15px var(--color-glow);
    transform: translateY(-2px);
  }

  button:active:not(:disabled) {
    transform: translateY(0);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
  }

  button:disabled {
    background: var(--color-bg-light);
    color: var(--color-text-muted);
    cursor: not-allowed;
    box-shadow: none;
    transform: none;
    opacity: 0.7;
  }

  /* Input fields */
  input[type="text"],
  input[type="password"],
  input[type="number"],
  #chatMessageInput {
    width: 100%;
    padding: 0.9rem 1.2rem;
    margin-bottom: 1.2rem;
    border-radius: 6px;
    border: 1px solid var(--color-border);
    background: var(--color-bg-light);
    color: var(--color-text-light);
    font-family: 'Share Tech Mono', monospace;
    font-size: 1rem;
    outline: none;
    transition: border-color 0.3s, box-shadow 0.3s;
    box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.4);
  }

  input[type="text"]:focus,
  input[type="password"]:focus,
  input[type="number"]:focus,
  #chatMessageInput:focus {
    border-color: var(--color-border-active);
    box-shadow: 0 0 0 3px var(--color-glow), inset 0 2px 5px rgba(0, 0, 0, 0.6);
  }

  /* Mensajes de error */
  .error-message {
    color: var(--color-accent-red);
    font-weight: bold;
    margin-top: -0.8rem;
    margin-bottom: 1.2rem;
    min-height: 1.5em; /* Previene saltos de dise√±o */
  }

  /* --- Topbar de Pantallas Secundarias (Men√∫, Juego, Estad√≠sticas, etc.) --- */
  .topbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(90deg, #004D99, var(--color-primary-blue));
    padding: 1rem 1.5rem;
    border-bottom: 2px solid #003366;
    border-radius: 6px 6px 0 0;
    margin: -2.5rem -2.5rem 2rem -2.5rem; /* Ajuste para que se extienda a los bordes del .screen */
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
    flex-wrap: wrap;
    gap: 0.8rem;
  }

  .topbar .welcome-text,
  .topbar h2 {
    font-family: 'Orbitron', sans-serif;
    font-size: clamp(1.2rem, 4vw, 1.8rem);
    color: var(--color-text-light);
    text-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
    margin: 0;
  }
  .topbar h2 {
      flex-grow: 1; /* Permite que el t√≠tulo crezca */
      text-align: left;
  }


  .topbar button {
    background: var(--color-accent-red);
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
  }
  .topbar button:hover {
    background: #A0202E;
  }

  /* --- Pantalla de Men√∫ --- */
  #menuScreen .game-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Columnas responsivas */
    gap: 1.5rem;
    padding-top: 1rem; /* Espacio debajo del topbar */
  }

  .game-card {
    background: var(--color-bg-light);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    padding: 1.5rem;
    text-align: left;
    display: flex;
    align-items: center;
    gap: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
    position: relative;
    overflow: hidden;
  }

  .game-card::before { /* Efecto de borde animado */
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border-radius: 8px;
    border: 2px solid transparent;
    transition: border-color 0.3s ease;
    pointer-events: none;
  }

  .game-card:hover::before {
    border-color: var(--color-primary-blue);
  }

  .game-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px var(--color-shadow), 0 0 15px var(--color-glow);
  }

  .game-card .icon {
    font-size: 2.5rem;
    line-height: 1;
    color: var(--color-primary-blue);
    text-shadow: 0 0 8px var(--color-glow);
  }

  .game-card .content .title {
    font-family: 'Orbitron', sans-serif;
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: 0.3rem;
    color: var(--color-text-light);
  }

  .game-card .content p {
    font-size: 0.9rem;
    color: var(--color-text-muted);
  }

  /* --- Pantalla de Juego/Test --- */
  #gameScreen .topbar {
    justify-content: space-between;
  }
  #gameScreen .timer {
    font-family: 'Orbitron', sans-serif;
    font-size: 1.8rem;
    color: var(--color-accent-red);
    text-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
    margin-left: 1rem;
  }

  #gameContent {
    padding-top: 1rem;
  }

  #questionText {
    background: var(--color-bg-light);
    border: 1px solid var(--color-border);
    border-left: 5px solid var(--color-primary-blue); /* Barra de √©nfasis */
    border-radius: 6px;
    padding: 1.5rem 1rem;
    margin-bottom: 2rem;
    font-size: 1.15rem;
    line-height: 1.6;
    text-align: left;
    min-height: 120px;
    display: flex;
    align-items: center;
  }

  #choicesContainer {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 0.8rem;
    margin-bottom: 1.5rem;
  }

  #choicesContainer button {
    background: var(--color-bg-light);
    color: var(--color-text-light);
    border: 1px solid var(--color-border);
    padding: 1rem 1.2rem;
    font-size: 1rem;
    font-family: 'Share Tech Mono', monospace;
    text-transform: none; /* No UPPERCASE para las opciones */
    transition: background 0.2s, border-color 0.2s, box-shadow 0.2s;
  }

  #choicesContainer button:hover:not(:disabled) {
    background: #3A3A48;
    border-color: var(--color-primary-blue);
    box-shadow: 0 0 8px var(--color-glow);
    transform: none; /* No lift up */
  }

  #choicesContainer button.correct {
    background: var(--color-accent-green);
    border-color: var(--color-accent-green);
    box-shadow: 0 0 10px rgba(40, 167, 69, 0.6);
  }
  #choicesContainer button.incorrect {
    background: var(--color-accent-red);
    border-color: var(--color-accent-red);
    box-shadow: 0 0 10px rgba(220, 53, 69, 0.6);
  }
  #choicesContainer button.correct::before,
  #choicesContainer button.incorrect::before {
    font-family: 'Share Tech Mono', monospace; /* Para los iconos del check/cross */
    margin-right: 0.5em;
  }

  #resultMessage {
    font-size: 1.1rem;
    font-weight: bold;
    color: var(--color-accent-green); /* Por defecto verde, se cambia a rojo para incorrecto */
    margin-top: 1rem;
    min-height: 1.5em;
    text-shadow: 0 0 8px rgba(40, 167, 69, 0.4);
  }
  #resultMessage.incorrect {
      color: var(--color-accent-red);
      text-shadow: 0 0 8px rgba(220, 53, 69, 0.4);
  }

  #finalScore {
    font-family: 'Orbitron', sans-serif;
    font-size: 2rem;
    color: var(--color-primary-blue);
    text-shadow: 0 0 15px var(--color-glow);
    margin-top: 1.5rem;
    font-weight: 700;
  }

  #navButtons {
    display: flex;
    justify-content: space-between;
    gap: 1rem;
    margin-top: 2rem;
  }

  #navButtons button {
    flex: 1;
    background: var(--color-bg-light);
    border: 1px solid var(--color-border);
    color: var(--color-primary-blue);
    font-size: 1rem;
    padding: 0.8rem 1.5rem;
  }

  #navButtons button:hover:not(:disabled) {
    background: var(--color-primary-blue);
    color: var(--color-text-light);
    border-color: var(--color-primary-blue);
    box-shadow: 0 0 10px var(--color-glow);
  }
  #navButtons button:disabled {
      background: var(--color-bg-light);
      color: var(--color-text-muted);
      border-color: var(--color-border);
  }


  /* --- Pantalla de Estad√≠sticas --- */
  #statsContent {
    text-align: left;
  }
  #statsContent h3 {
    font-family: 'Orbitron', sans-serif;
    font-size: 1.4rem;
    color: var(--color-primary-blue);
    border-bottom: 1px solid var(--color-border);
    padding-bottom: 0.5rem;
    margin-top: 1.5rem;
    margin-bottom: 1rem;
    text-shadow: 0 0 5px var(--color-glow);
  }
  #statsContent ul {
    list-style: none;
    padding: 0;
  }
  #statsContent li {
    background: var(--color-bg-light);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    padding: 0.8rem 1rem;
    margin-bottom: 0.6rem;
    font-size: 0.95rem;
    line-height: 1.4;
    position: relative;
    overflow: hidden;
  }
  #statsContent li::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 4px;
    background-color: var(--color-accent-red); /* Barra roja para fallos */
  }
  #statsContent .no-data {
    color: var(--color-text-muted);
    font-style: italic;
    text-align: center;
    padding: 2rem 0;
  }

  /* --- Pantalla de Generar Test --- */
  #generateTestScreen .form-container {
    text-align: left;
  }
  #generateTestScreen label {
    display: block;
    margin-bottom: 0.6rem;
    font-size: 1rem;
    color: var(--color-text-light);
  }
  #generateTestScreen .checkbox-group {
    margin-bottom: 1.5rem;
  }
  #generateTestScreen .checkbox-group label {
    display: inline-flex;
    align-items: center;
    margin-right: 1.5rem;
    margin-bottom: 0.5rem;
    cursor: pointer;
    font-size: 0.95rem;
  }
  #generateTestScreen .checkbox-group input[type="checkbox"] {
    appearance: none; /* Ocultar checkbox nativo */
    width: 18px;
    height: 18px;
    border: 1px solid var(--color-border);
    border-radius: 3px;
    background-color: var(--color-bg-light);
    margin-right: 0.6rem;
    cursor: pointer;
    position: relative;
    transition: all 0.2s ease;
    flex-shrink: 0;
  }
  #generateTestScreen .checkbox-group input[type="checkbox"]:checked {
    background-color: var(--color-primary-blue);
    border-color: var(--color-primary-blue);
    box-shadow: 0 0 5px var(--color-glow);
  }
  #generateTestScreen .checkbox-group input[type="checkbox"]:checked::after {
    content: '‚úî';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 14px;
    line-height: 1;
  }
  #generateTestBtn {
    background: var(--color-accent-green);
    width: 100%;
    margin-top: 2rem;
    padding: 1rem;
    font-size: 1.2rem;
  }
  #generateTestBtn:hover {
    background: #1D7A39;
    box-shadow: 0 6px 15px rgba(40, 167, 69, 0.6);
  }

  /* --- Pantalla de Chat Login & Chat Grupal --- */
  #chatLoginScreen .form-group {
    text-align: left;
  }
  #connectChatBtn {
    background: var(--color-accent-green);
    width: 100%;
    margin-top: 2rem;
    padding: 1rem;
    font-size: 1.2rem;
  }
  #connectChatBtn:hover {
    background: #1D7A39;
    box-shadow: 0 6px 15px rgba(40, 167, 69, 0.6);
  }

  #groupChatScreen {
    width: clamp(320px, 95vw, 800px); /* Chat m√°s ancho */
  }

  #chatMessages {
    background: #101015; /* Fondo del √°rea de chat */
    border: 1px solid var(--color-border);
    border-radius: 6px;
    height: 400px;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.7rem;
    margin-bottom: 1rem;
    box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
  }

  .chat-message {
    background: var(--color-bg-light);
    padding: 0.8rem 1.2rem;
    border-radius: 12px;
    max-width: 85%;
    word-wrap: break-word;
    font-size: 0.95rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    border: 1px solid var(--color-border);
  }
  .chat-message.own-message {
    align-self: flex-end;
    background: var(--color-primary-blue);
    color: white;
    border-top-right-radius: 4px; /* Un poco menos redondeado */
  }
  .chat-message.other-message {
    align-self: flex-start;
    background: #3A3A48; /* Otro tono de fondo */
    color: var(--color-text-light);
    border-top-left-radius: 4px; /* Un poco menos redondeado */
  }
  .message-sender {
    font-weight: bold;
    color: var(--color-primary-blue);
    margin-bottom: 0.3rem;
    display: block;
    font-size: 0.8em;
    text-shadow: 0 0 5px var(--color-glow);
  }
  .chat-message.own-message .message-sender {
      color: var(--color-text-light); /* En mensajes propios, el sender es blanco */
      text-shadow: none;
  }
  .chat-input-area {
    display: flex;
    gap: 0.8rem;
    padding-top: 0.5rem;
  }

  #sendChatMessageBtn {
    background: var(--color-primary-blue);
    padding: 0.8rem 1.5rem;
    font-size: 1rem;
    border-radius: 6px;
    text-transform: uppercase;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    body {
      padding: 0.8rem;
      align-items: flex-start; /* Alinea arriba en m√≥viles si hay scroll */
    }
    .screen {
      padding: 1.5rem;
      border-width: 1px;
      margin-top: 1rem;
      margin-bottom: 1rem;
      max-height: calc(100vh - 2rem); /* Ajusta altura m√°xima */
    }
    h1 {
      font-size: clamp(2rem, 10vw, 3.5rem);
      margin-bottom: 2rem;
    }
    .topbar {
      margin: -1.5rem -1.5rem 1.5rem -1.5rem;
      padding: 0.8rem 1rem;
    }
    .topbar .welcome-text,
    .topbar h2 {
      font-size: clamp(1rem, 5vw, 1.4rem);
    }
    .topbar button {
      padding: 0.4rem 0.8rem;
      font-size: 0.8rem;
    }
    button {
      padding: 0.7rem 1.5rem;
      font-size: 1rem;
    }
    input {
      padding: 0.8rem 1rem;
      font-size: 0.95rem;
    }
    .game-card {
      flex-direction: column;
      align-items: flex-start;
      text-align: center; /* Alinea el texto en el centro si el icono est√° arriba */
      padding: 1rem;
      gap: 0.8rem;
    }
    .game-card .icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    .game-card .content {
        width: 100%; /* El contenido ocupa todo el ancho restante */
        text-align: left; /* Asegura que el texto est√© alineado a la izquierda */
    }
    .game-card .content .title {
      font-size: 1.1rem;
    }
    .game-card .content p {
      font-size: 0.85rem;
    }

    #questionText {
      font-size: 1.05rem;
      padding: 1rem;
      min-height: 90px;
    }
    #choicesContainer button {
      font-size: 0.9rem;
      padding: 0.8rem;
    }
    #finalScore {
      font-size: 1.6rem;
    }
    #navButtons {
      flex-direction: column;
      gap: 0.6rem;
      margin-top: 1.5rem;
    }
    #navButtons button {
      font-size: 0.9rem;
      padding: 0.7rem;
    }
    #statsContent h3 {
      font-size: 1.2rem;
    }
    #statsContent li {
      font-size: 0.85rem;
      padding: 0.6rem 0.8rem;
    }
    #generateTestBtn, #connectChatBtn {
      font-size: 1.1rem;
      padding: 0.9rem;
    }
    #chatMessages {
      height: 300px;
      padding: 0.8rem;
    }
    .chat-input-area {
      flex-direction: column;
      gap: 0.5rem;
    }
    #chatMessageInput {
      margin-bottom: 0;
    }
    #sendChatMessageBtn {
      width: 100%;
      padding: 0.7rem;
      font-size: 0.9rem;
    }
  }

  /* Keyframe animations */
  @keyframes fadeInScale {
    from {
      opacity: 0;
      transform: scale(0.9) translateY(20px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }
  .screen:not(.hidden) {
    animation: fadeInScale 0.5s cubic-bezier(0.25, 0.8, 0.25, 1) forwards;
  }

</style>
</head>
<body>
  <div id="loginScreen" class="screen">
    <h1>PULIPOL</h1>
    <input type="text" id="usernameInput" placeholder="Usuario">
    <input type="password" id="passwordInput" placeholder="Contrase√±a">
    <p id="loginError" class="error-message"></p>
    <button id="loginBtn">ACCEDER AL SISTEMA</button>
  </div>

  <div id="menuScreen" class="screen hidden">
    <div class="topbar">
      <span class="welcome-text">Bienvenido a Pulipol</span>
      <button id="logoutBtn">Cerrar Sesi√≥n</button>
    </div>
    <div class="game-list">
      <div class="game-card" id="gameJefeDirector" tabindex="0">
        <span class="icon">üëÆ‚Äç‚ôÇÔ∏è</span>
        <div class="content">
          <span class="title">Jefe y Director de Seguridad Privada</span>
          <p>Pon a prueba tus conocimientos sobre roles de seguridad.</p>
        </div>
      </div>
      <div class="game-card" id="gameLOEX" tabindex="0">
        <span class="icon">‚öñÔ∏è</span>
        <div class="content">
          <span class="title">Infracciones LOEX</span>
          <p>Identifica el tipo de infracci√≥n seg√∫n la LOEX.</p>
        </div>
      </div>
      <div class="game-card" id="gameLO42010" tabindex="0">
        <span class="icon">üìú</span>
        <div class="content">
          <span class="title">Infracciones L.O 4/2010</span>
          <p>Identifica las infracciones seg√∫n la Ley Org√°nica 4/2010.</p>
        </div>
      </div>
      <div class="game-card" id="gameStats" tabindex="0">
        <span class="icon">üìà</span>
        <div class="content">
          <span class="title">Estad√≠sticas de Fallos</span>
          <p>Revisa las preguntas que has fallado para mejorar.</p>
        </div>
      </div>
      <div class="game-card" id="gameGenerateTest" tabindex="0">
        <span class="icon">üìù</span>
        <div class="content">
          <span class="title">Generar Test Personalizado</span>
          <p>Crea ex√°menes a medida con tus propios ajustes.</p>
        </div>
      </div>
      <div class="game-card" id="gameChat" tabindex="0">
        <span class="icon">üí¨</span>
        <div class="content">
          <span class="title">Chat de Operaciones (Simulado)</span>
          <p>Con√©ctate a una sala de chat segura para coordinar.</p>
        </div>
      </div>
    </div>
  </div>

  <div id="gameScreen" class="screen hidden">
    <div class="topbar">
      <h2 id="gameTitle"></h2>
      <span id="timerDisplay" class="timer hidden">00:00</span>
      <button id="backToMenuBtn">Men√∫</button>
    </div>
    <div id="gameContent">
      <p id="questionText"></p>
      <div id="choicesContainer">
        </div>
      <p id="resultMessage"></p>
      <p id="finalScore" class="hidden"></p>
      <div id="navButtons">
        <button id="prevBtn">‚Üê ANTERIOR</button>
        <button id="nextBtn">SIGUIENTE ‚Üí</button>
      </div>
    </div>
  </div>

  <div id="statsScreen" class="screen hidden">
    <div class="topbar">
      <h2>Registro de Errores</h2>
      <button id="backToMenuFromStatsBtn">Men√∫</button>
    </div>
    <div id="statsContent">
      </div>
  </div>

  <div id="generateTestScreen" class="screen hidden">
    <div class="topbar">
      <h2>Configuraci√≥n de Prueba</h2>
      <button id="backToMenuFromGenerateTestBtn">Men√∫</button>
    </div>
    <div class="form-container">
      <div class="form-group">
        <label>Selecciona m√≥dulos de evaluaci√≥n:</label>
        <div class="checkbox-group">
          <label><input type="checkbox" id="jefeDirectorCheckbox"> Jefe y Director de Seguridad</label>
          <label><input type="checkbox" id="loexCheckbox"> Infracciones LOEX</label>
          <label><input type="checkbox" id="lo42010Checkbox"> Infracciones L.O 4/2010</label>
        </div>
      </div>
      <div class="form-group">
        <label for="numQuestions">N√∫mero de preguntas:</label>
        <input type="number" id="numQuestions" value="10" min="1">
      </div>
      <div class="form-group">
        <label for="testTime">Tiempo l√≠mite (minutos):</label>
        <input type="number" id="testTime" value="10" min="1">
      </div>
      <p id="generateTestError" class="error-message"></p>
      <div class="button-container">
        <button id="generateTestBtn">INICIAR EVALUACI√ìN</button>
      </div>
    </div>
  </div>

  <div id="chatLoginScreen" class="screen hidden">
    <div class="topbar">
      <h2>Acceso al Chat de Operaciones</h2>
      <button id="backToMenuFromChatLoginBtn">Men√∫</button>
    </div>
    <div class="form-group">
      <label for="chatUsernameInput">Identificador de Agente:</label>
      <input type="text" id="chatUsernameInput" placeholder="Ej: Agente_007">
    </div>
    <p id="chatLoginError" class="error-message"></p>
    <button id="connectChatBtn">CONECTAR</button>
  </div>

  <div id="groupChatScreen" class="screen hidden">
    <div class="topbar">
      <h2>Comunicaci√≥n Segura <span class="badge">ACTIVO</span></h2>
      <button id="backToMenuFromGroupChatBtn">Men√∫</button>
    </div>
    <div id="chatMessages">
      </div>
    <div class="chat-input-area">
      <input type="text" id="chatMessageInput" placeholder="Escriba aqu√≠ su informe...">
      <button id="sendChatMessageBtn">ENVIAR</button>
    </div>
  </div>

<script>
  (() => {
  'use strict';

  // --- Elementos del DOM ---
  const loginScreen = document.getElementById('loginScreen');
  const usernameInput = document.getElementById('usernameInput');
  const passwordInput = document.getElementById('passwordInput');
  const loginBtn = document.getElementById('loginBtn');
  const loginError = document.getElementById('loginError');

  // Logs para depuraci√≥n inicial de elementos
  console.log('DEBUG: loginScreen:', loginScreen);
  console.log('DEBUG: usernameInput:', usernameInput);
  console.log('DEBUG: passwordInput:', passwordInput);
  console.log('DEBUG: loginBtn:', loginBtn);
  console.log('DEBUG: loginError:', loginError);

  const menuScreen = document.getElementById('menuScreen');
  const logoutBtn = document.getElementById('logoutBtn');
  const gameJefeDirectorCard = document.getElementById('gameJefeDirector');
  const gameLOEXCard = document.getElementById('gameLOEX'); // CORREGIDO: Eliminado el 'document =' extra
  const gameLO42010Card = document.getElementById('gameLO42010');
  const gameStatsCard = document.getElementById('gameStats');
  const gameGenerateTestCard = document.getElementById('gameGenerateTest');
  const gameChatCard = document.getElementById('gameChat');

  const gameScreen = document.getElementById('gameScreen');
  const gameTitleDisplay = document.getElementById('gameTitle');
  const backToMenuBtn = document.getElementById('backToMenuBtn');
  const timerDisplay = document.getElementById('timerDisplay');
  const questionText = document.getElementById('questionText');
  const choicesContainer = document.getElementById('choicesContainer');
  const resultMessage = document.getElementById('resultMessage');
  const finalScoreDisplay = document.getElementById('finalScore');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');

  const statsScreen = document.getElementById('statsScreen');
  const backToMenuFromStatsBtn = document.getElementById('backToMenuFromStatsBtn');
  const statsContent = document.getElementById('statsContent');

  const generateTestScreen = document.getElementById('generateTestScreen');
  const backToMenuFromGenerateTestBtn = document.getElementById('backToMenuFromGenerateTestBtn');
  const jefeDirectorCheckbox = document.getElementById('jefeDirectorCheckbox');
  const loexCheckbox = document.getElementById('loexCheckbox');
  const lo42010Checkbox = document.getElementById('lo42010Checkbox');
  const numQuestionsInput = document.getElementById('numQuestions');
  const testTimeInput = document.getElementById('testTime');
  const generateTestBtn = document.getElementById('generateTestBtn');
  const generateTestError = document.getElementById('generateTestError');

  const chatLoginScreen = document.getElementById('chatLoginScreen');
  const backToMenuFromChatLoginBtn = document.getElementById('backToMenuFromChatLoginBtn');
  const chatUsernameInput = document.getElementById('chatUsernameInput');
  const connectChatBtn = document.getElementById('connectChatBtn');
  const chatLoginError = document.getElementById('chatLoginError');

  const groupChatScreen = document.getElementById('groupChatScreen');
  const backToMenuFromGroupChatBtn = document.getElementById('backToMenuFromGroupChatBtn');
  const chatMessagesContainer = document.getElementById('chatMessages');
  const chatMessageInput = document.getElementById('chatMessageInput');
  const sendChatMessageBtn = document.getElementById('sendChatMessageBtn');

  // --- Variables de Estado del Juego ---
  let loggedInUser = null;
  let currentScreen = null; // Se inicializar√° en showLogin
  let currentGameType = null;
  let currentQuestions = [];
  let currentQuestionIndex = 0;
  let userAnswers = {}; // {questionIndex: selectedChoiceIndex}
  let correctAnswersCount = 0;
  let quizStartTime = 0;
  let quizInterval = null;
  let incorrectQuestionsStats = JSON.parse(localStorage.getItem('incorrectQuestionsStats')) || {};
  let chatUsername = null;
  let chatMessages = []; // For simulated chat

  // --- Datos de los Juegos ---
  const gameData = {
    jefeDirector: {
      title: "Jefe y Director de Seguridad Privada",
      questions: [
        ["Supervisar la seguridad de las instalaciones y personal", "Jefe"],
        ["Tomar decisiones estrat√©gicas a nivel organizativo", "Director"],
        ["Coordinar equipos de seguridad en situaciones de riesgo", "Jefe"],
        ["Definir pol√≠ticas y normativas internas", "Director"],
        ["Gestionar conflictos internos y externos relacionados con la seguridad", "Jefe"],
        ["Representar a la empresa en reuniones de alto nivel", "Director"],
        ["Elaborar informes de seguridad y auditor√≠as", "Jefe"],
        ["Desarrollar planes de contingencia y emergencia", "Director"],
        ["Implementar medidas de seguridad f√≠sica", "Jefe"],
        ["Establecer alianzas estrat√©gicas con otras organizaciones", "Director"],
        ["Investigar incidentes de seguridad y proponer soluciones", "Jefe"],
        ["Gestionar el presupuesto del √°rea de seguridad", "Director"],
        ["Formar y capacitar al personal de seguridad", "Jefe"],
        ["Evaluar riesgos y vulnerabilidades de la organizaci√≥n", "Director"],
        ["Mantener la disciplina y el orden del personal a su cargo", "Jefe"],
        ["Dise√±ar la estructura del departamento de seguridad", "Director"]
      ],
      choices: ["Jefe", "Director"]
    },
    loex: {
      title: "Infracciones LOEX",
      questions: [
        // INFRACCIONES LEVES
        ["La omisi√≥n o el retraso en la comunicaci√≥n a las autoridades espa√±olas de los cambios de nacionalidad, estado civil o de domicilio, as√≠ como de otras circunstancias determinantes de su situaci√≥n laboral cuando les sean exigibles por la normativa aplicable.", "Leve"],
        ["El retraso, hasta tres meses, en la solicitud de renovaci√≥n de las autorizaciones una vez hayan caducado.", "Leve"],
        ["Encontrarse trabajando en Espa√±a sin haber solicitado autorizaci√≥n administrativa para trabajar por cuenta propia, cuando se cuente con autorizaci√≥n de residencia temporal.", "Leve"],
        ["Encontrarse trabajando en una ocupaci√≥n, sector de actividad, o √°mbito geogr√°fico no contemplado por la autorizaci√≥n de residencia y trabajo de la que se es titular.", "Leve"],
        ["La contrataci√≥n de personas trabajadoras cuya autorizaci√≥n no les habilita para trabajar en esa ocupaci√≥n o √°mbito geogr√°fico, incurri√©ndose en una infracci√≥n por cada una de las personas trabajadoras extranjeras ocupadas.", "Leve"],
        ["La ausencia de comunicaci√≥n a la autoridad p√∫blica por parte de las entidades cuyo objeto se refiera total o parcialmente a la atenci√≥n de personas menores de edad extranjeras no acompa√±adas, as√≠ como de las personas que act√∫en en su representaci√≥n o encuadradas en su actividad de manera habitual, de la localizaci√≥n de personas menores de edad extranjeras no acompa√±adas a fin de que pueda procederse en consecuencia.", "Leve"],
        ["La no presentaci√≥n injustificada, sin causa o raz√≥n v√°lida, a los requerimientos de la Delegaci√≥n o Subdelegaci√≥n del Gobierno por parte de la persona extranjera interesada, y que se realice de forma reiterada, tras dos notificaciones debidamente practicadas en las que no se haya obtenido respuesta. Se entender√° que existe una raz√≥n v√°lida para la no comparecencia cuando la persona interesada acredite de forma fehaciente una circunstancia que imposibilite su presencia o justifique que la misma no es obligatoria. En todo caso, la carga de la prueba corresponder√° a la persona interesada.", "Leve"],
        ["La inobservancia de la obligaci√≥n de poner en conocimiento de la autoridad competente el extrav√≠o, la destrucci√≥n, la sustracci√≥n o la inutilizaci√≥n del pasaporte o documento de viaje, del visado, de la Tarjeta de Identidad de Extranjero o de cualquier otro documento an√°logo, siempre que de ello no se derive perjuicio grave para el servicio p√∫blico o para la acreditaci√≥n de la identidad de la persona interesada.", "Leve"],
        ["La inobservancia de la obligaci√≥n de comunicar a la autoridad competente la p√©rdida, extrav√≠o o inutilizaci√≥n del pasaporte o documento de viaje, del visado, de la Tarjeta de Identidad de Extranjero o de cualquier otro documento an√°logo, as√≠ como no denunciar la sustracci√≥n de los mismos. El incumplimiento de esta obligaci√≥n cuando d√© lugar a un perjuicio grave para la seguridad p√∫blica, podr√° dar lugar a la calificaci√≥n de la infracci√≥n como grave o muy grave, en funci√≥n de la gravedad de los hechos.", "Leve"],
        ["La omisi√≥n o el retraso en la comunicaci√≥n a la autoridad p√∫blica de los cambios de nacionalidad, estado civil o de domicilio, as√≠ como de otras circunstancias determinantes de su situaci√≥n laboral cuando les sean exigibles por la normativa aplicable.", "Leve"],
        // INFRACCIONES GRAVES
        ["Encontrarse irregularmente en territorio espa√±ol, por no haber obtenido la pr√≥rroga de estancia, carecer de autorizaci√≥n de residencia o tener caducada m√°s de tres meses la mencionada autorizaci√≥n, y siempre que la persona interesada no hubiere solicitado la renovaci√≥n de la misma en el plazo previsto reglamentariamente.", "Grave"],
        ["Encontrarse trabajando en Espa√±a sin haber obtenido autorizaci√≥n de trabajo o autorizaci√≥n administrativa previa para trabajar, cuando no cuente con autorizaci√≥n de residencia v√°lida.", "Grave"],
        ["Incurrir en ocultaci√≥n dolosa o falsedad grave en el cumplimiento de la obligaci√≥n de poner en conocimiento de las autoridades competentes los cambios que afecten a nacionalidad, estado civil o domicilio, as√≠ como incurrir en falsedad en la declaraci√≥n de los datos obligatorios para cumplimentar el alta en el padr√≥n municipal, siempre que tales hechos no constituyan delito. Cuando cualquier autoridad tuviera conocimiento de una posible infracci√≥n por esta causa, lo pondr√° en conocimiento de las autoridades competentes con el fin de que pueda instruirse el oportuno expediente sancionador.", "Grave"],
        ["El incumplimiento de las medidas impuestas por raz√≥n de seguridad p√∫blica, de presentaci√≥n peri√≥dica o de alejamiento de fronteras o n√∫cleos de poblaci√≥n concretados singularmente.", "Grave"],
        ["La comisi√≥n de una tercera infracci√≥n leve, siempre que la persona extranjera hubiera sido sancionada por dos infracciones leves anteriores, en el plazo de un a√±o. Se entender√° que existe reincidencia cuando la persona extranjera hubiera sido sancionada por dos infracciones leves anteriores, siempre que no hayan transcurrido m√°s de seis meses desde la √∫ltima sanci√≥n y que la nueva infracci√≥n no hubiera prescrito.", "Grave"],
        ["El ocultamiento de informaci√≥n o la falsedad en la declaraci√≥n de los datos relativos a la situaci√≥n laboral de las personas trabajadoras extranjeras, a fin de obtener los beneficios previstos en esta ley para las personas empleadoras.", "Grave"],
        ["Simular la relaci√≥n laboral para obtener una autorizaci√≥n de residencia o la pr√≥rroga de la misma, o para obtener una autorizaci√≥n de trabajo, ya sea por cuenta propia o ajena.", "Grave"],
        ["La falsedad en el padr√≥n municipal de las personas extranjeras, con el fin de obtener alg√∫n beneficio de la Ley, o de dificultar su aplicaci√≥n. Cuando cualquier autoridad tuviera conocimiento de una posible infracci√≥n por esta causa, lo pondr√° en conocimiento de las autoridades competentes con el fin de que pueda instruirse el oportuno expediente sancionador.", "Grave"],
        ["No dar de alta a la persona trabajadora extranjera en el r√©gimen correspondiente de la Seguridad Social, cuando as√≠ se establezca en la normativa de aplicaci√≥n.", "Grave"],
        ["La contrataci√≥n de personas trabajadoras extranjeras sin haberles solicitado la correspondiente autorizaci√≥n de trabajo, o cuando la autorizaci√≥n no les habilite para trabajar en esa ocupaci√≥n o √°mbito geogr√°fico, incurri√©ndose en una infracci√≥n por cada una de las personas trabajadoras extranjeras ocupadas.", "Grave"],
        // INFRACCIONES MUY GRAVES
        ["Participar en actividades contrarias a la seguridad nacional o que puedan perjudicar las relaciones de Espa√±a con otros pa√≠ses.", "Muy Grave"],
        ["Inducir, promover, favorecer o facilitar con √°nimo de lucro, individualmente o formando parte de una organizaci√≥n, la inmigraci√≥n clandestina de personas extranjeras en tr√°nsito o con destino a Espa√±a o su permanencia irregular en territorio espa√±ol. No se entender√° que existe √°nimo de lucro cuando el objetivo sea prestar asistencia humanitaria, para lo que se tendr√° en cuenta la relaci√≥n entre la persona facilitadora y la persona facilitada, el contexto en el que se desarrolla la acci√≥n, la finalidad perseguida y la situaci√≥n de vulnerabilidad en la que se encuentre la persona facilitada.", "Muy Grave"],
        ["La comisi√≥n de una tercera infracci√≥n grave, siempre que la persona extranjera hubiera sido sancionada por dos infracciones graves anteriores, en el plazo de un a√±o.", "Muy Grave"],
        ["Emplear a personas trabajadoras extranjeras sin haber obtenido la preceptiva autorizaci√≥n de trabajo, o sin haber dado de alta en la Seguridad Social cuando as√≠ se establezca en la normativa de aplicaci√≥n, incurri√©ndose en una infracci√≥n por cada una de las personas trabajadoras extranjeras ocupadas.", "Muy Grave"],
        ["La simulaci√≥n de la relaci√≥n laboral o la presentaci√≥n de contratos de trabajo o de ofertas de empleo fraudulentos, con la finalidad de obtener una autorizaci√≥n de residencia o la pr√≥rroga de la misma, o para obtener una autorizaci√≥n de trabajo, ya sea por cuenta propia o ajena.", "Muy Grave"],
        ["Alteraci√≥n o falsificaci√≥n de documentos utilizados para obtener visados o autorizaciones, ya sea por la persona extranjera o por su representante.", "Muy Grave"],
        ["La participaci√≥n en actividades que atenten contra la seguridad p√∫blica, el orden p√∫blico, la salud p√∫blica o la integridad de las personas.", "Muy Grave"],
        ["La estancia en Espa√±a en condiciones que contravengan lo dispuesto en la presente Ley.", "Muy Grave"]
      ],
      choices: ["Leve", "Grave", "Muy Grave"]
    },
    // NUEVO: Objeto para el juego "Infracciones L.O 4/2010"
    lo42010: {
      title: "Infracciones L.O 4/2010",
      questions: [
        // Faltas Muy Graves
        ["El incumplimiento del deber de fidelidad a la Constituci√≥n en el ejercicio de las funciones.", "Muy Grave"],
        ["Haber sido condenado en virtud de sentencia firme por un delito doloso relacionado con el servicio o que cause grave da√±o a la Administraci√≥n o a las personas.", "Muy Grave"],
        ["El abuso de atribuciones que cause grave da√±o a los ciudadanos, a los subordinados, a la Administraci√≥n o a las entidades con personalidad jur√≠dica.", "Muy Grave"],
        ["La pr√°ctica de tratos inhumanos, degradantes, discriminatorios o vejatorios a los ciudadanos que se encuentren bajo custodia policial.", "Muy Grave"],
        ["La insubordinaci√≥n individual o colectiva, respecto a las Autoridades o mandos de que dependan.", "Muy Grave"],
        ["El abandono de servicio, salvo que exista causa de fuerza mayor que impida comunicar a un superior dicho abandono.", "Muy Grave"],
        ["La publicaci√≥n o la utilizaci√≥n indebida de secretos oficiales, declarados as√≠ con arreglo a la legislaci√≥n espec√≠fica en la materia.", "Muy Grave"],
        ["La violaci√≥n del secreto profesional cuando perjudique el desarrollo de la labor policial, a cualquier ciudadano o a las entidades con personalidad jur√≠dica.", "Muy Grave"],
        ["El incumplimiento de las normas sobre incompatibilidades cuando ello d√© lugar a una situaci√≥n de incompatibilidad.", "Muy Grave"],
        ["La participaci√≥n en huelgas, en acciones sustitutivas de estas o en actuaciones concertadas con el fin de alterar el normal funcionamiento de los servicios.", "Muy Grave"],
        ["La falta de colaboraci√≥n manifiesta con otros miembros de las Fuerzas y Cuerpos de Seguridad, cuando resulte perjudicado gravemente el servicio o se deriven consecuencias graves para la seguridad ciudadana.", "Muy Grave"],
        ["Embriagarse o consumir drogas t√≥xicas, estupefacientes o sustancias psicotr√≥picas durante el servicio o realizarlo en estado de embriaguez o bajo los efectos manifiestos de los productos citados.", "Muy Grave"],
        ["La negativa injustificada a someterse a reconocimiento m√©dico, prueba de alcoholemia o de detecci√≥n de drogas t√≥xicas, estupefacientes o sustancias psicotr√≥picas, leg√≠timamente ordenadas, a fin de constatar la capacidad psicof√≠sica para prestar servicio.", "Muy Grave"],
        ["Toda actuaci√≥n que suponga discriminaci√≥n por raz√≥n de origen racial o √©tnico, religi√≥n o convicciones, discapacidad, edad u orientaci√≥n sexual, sexo, lengua, opini√≥n, lugar de nacimiento o vecindad, o cualquier otra condici√≥n o circunstancia personal o social.", "Muy Grave"],
        ["El acoso sexual y el acoso laboral, consistente este √∫ltimo en la realizaci√≥n reiterada, en el marco de una relaci√≥n de servicio, de actos de acoso psicol√≥gico u hostilidad.", "Muy Grave"],
        ["La obstaculizaci√≥n grave al ejercicio de las libertades p√∫blicas y derechos sindicales.", "Muy Grave"],
        ["Las infracciones tipificadas como muy graves en la legislaci√≥n sobre utilizaci√≥n de videoc√°maras por las Fuerzas y Cuerpos de Seguridad en lugares p√∫blicos.", "Muy Grave"],

        // Faltas Graves
        ["La grave desconsideraci√≥n con los superiores, compa√±eros, subordinados o ciudadanos, en el ejercicio de sus funciones o cuando cause descr√©dito notorio a la Instituci√≥n Policial.", "Grave"],
        ["La desobediencia a los superiores jer√°rquicos o los responsables del servicio con motivo de las √≥rdenes o instrucciones leg√≠timas dadas por aqu√©llos, salvo que constituyan infracci√≥n manifiesta del ordenamiento jur√≠dico.", "Grave"],
        ["La omisi√≥n de la obligaci√≥n de dar cuenta a la superioridad con la debida diligencia de todo asunto que por su entidad requiera su conocimiento o decisi√≥n urgente.", "Grave"],
        ["La falta de presentaci√≥n o puesta a disposici√≥n inmediata de la dependencia donde estuviera destinado, o en la m√°s pr√≥xima, en los casos de declaraci√≥n de los estados de excepci√≥n o sitio o, cuando as√≠ se disponga, en caso de alteraci√≥n grave de la seguridad ciudadana; o, en los casos de declaraci√≥n del estado de alarma, la no presentaci√≥n cuando sean emplazados para ello, de acuerdo con lo dispuesto por la autoridad competente.", "Grave"],
        ["La tercera falta injustificada de asistencia al servicio en un per√≠odo de tres meses cuando las dos anteriores hubieran sido objeto de sanci√≥n firme por falta leve.", "Grave"],
        ["No prestar servicio, alegando supuesta enfermedad.", "Grave"],
        ["La falta de rendimiento reiterada que ocasione un perjuicio a los ciudadanos, a las entidades con personalidad jur√≠dica o a la eficacia de los servicios.", "Grave"],
        ["El abuso de atribuciones cuando no constituya infracci√≥n muy grave.", "Grave"],
        ["La emisi√≥n de informes sobre asuntos de servicio que, sin faltar abiertamente a la verdad, la desnaturalicen, vali√©ndose de t√©rminos ambiguos, confusos o tendenciosos, o la alteren mediante inexactitudes, cuando se cause perjuicio a la Administraci√≥n o a los ciudadanos, siempre que el hecho no constituya delito o falta muy grave.", "Grave"],
        ["La intervenci√≥n en un procedimiento administrativo cuando concurra alguna de las causas legales de abstenci√≥n.", "Grave"],
        ["No ir provisto en los actos de servicio del uniforme reglamentario, cuando su uso sea preceptivo, de los distintivos de la categor√≠a o cargo, del arma reglamentaria o de los medios de protecci√≥n o acci√≥n que se determinen, siempre que no medie autorizaci√≥n en contrario.", "Grave"],
        ["Exhibir armas sin causa justificada, as√≠ como utilizarlas en acto de servicio o fuera de √©l infringiendo las normas que regulan su empleo.", "Grave"],
        ["Dar lugar al extrav√≠o, p√©rdida o sustracci√≥n por negligencia inexcusable de los distintivos de identificaci√≥n o del arma reglamentaria.", "Grave"],
        ["Asistir de uniforme a cualquier manifestaci√≥n o reuni√≥n p√∫blica, salvo que se trate de actos de servicio, o actos oficiales en los que la asistencia de uniforme est√© indicada o haya sido autorizada.", "Grave"],
        ["Causar, por negligencia inexcusable, da√±os graves en la conservaci√≥n de los locales, del material o de los dem√°s elementos relacionados con el servicio o dar lugar al extrav√≠o, la p√©rdida o la sustracci√≥n de estos.", "Grave"],
        ["Impedir, limitar u obstaculizar a los subordinados el ejercicio de los derechos que tengan reconocidos, siempre que no constituya falta muy grave.", "Grave"],
        ["Embriagarse o consumir drogas t√≥xicas, estupefacientes o sustancias psicotr√≥picas fuera del servicio, cuando tales circunstancias tengan car√°cter habitual o afecten a la imagen del Cuerpo Nacional de Polic√≠a. Se entender√° que existe habitualidad cuando estuvieren acreditados tres o m√°s episodios de embriaguez o consumo de las sustancias referidas en un periodo de un a√±o.", "Grave"],
        ["La tenencia de drogas t√≥xicas, estupefacientes o sustancias psicotr√≥picas, excepto que esa tenencia se derive de actuaciones propias del servicio.", "Grave"],
        ["Solicitar y obtener cambios de destino mediando cualquier recompensa, √°nimo de lucro o falseando las condiciones que los regulan.", "Grave"],
        ["Emplear, o autorizar la utilizaci√≥n para usos no relacionados con el servicio o con ocasi√≥n de este, o sin que medie causa justificada, de medios o recursos inherentes a la funci√≥n policial.", "Grave"],
        ["Las infracciones a lo dispuesto en la legislaci√≥n sobre utilizaci√≥n de videoc√°maras por las Fuerzas y Cuerpos de Seguridad en lugares p√∫blicos, no constitutivas de falta muy grave.", "Grave"],
        ["El incumplimiento de los plazos u otras disposiciones de procedimiento en materia de incompatibilidades, cuando no supongan mantenimiento de una situaci√≥n de incompatibilidad.", "Grave"],
        ["La violaci√≥n del secreto profesional cuando no perjudique el desarrollo de la labor policial, a las entidades con personalidad jur√≠dica o a cualquier ciudadano.", "Grave"],
        ["La falta de colaboraci√≥n manifiesta con otros miembros de los Cuerpos y Fuerzas de Seguridad, siempre que no merezca la calificaci√≥n de falta muy grave.", "Grave"],
        ["La infracci√≥n de deberes u obligaciones legales inherentes al cargo o a la funci√≥n policial, cuando se produzcan de forma grave y manifiesta.", "Grave"],
        ["Haber sido condenado en virtud de sentencia firme por un delito doloso, siempre que no constituya infracci√≥n muy grave, o por una falta dolosa cuando la infracci√≥n penal cometida est√© relacionada con el servicio.", "Grave"],
        ["La no prestaci√≥n de auxilio con urgencia en aquellos hechos o circunstancias graves en que sea obligada su actuaci√≥n, salvo que constituya delito.", "Grave"],
        ["La infracci√≥n de las normas de prevenci√≥n de riesgos laborales que pongan en grave riesgo la vida, salud, o integridad f√≠sica, propia o de sus compa√±eros o subordinados.", "Grave"],
        ["La negativa reiterada a tramitar cualquier solicitud, reclamaci√≥n o queja relacionada con el servicio, siempre que no constituya falta leve.", "Grave"],
        ["Aquellas acciones u omisiones tipificadas como faltas muy graves que, de acuerdo con los criterios que se establecen en el art√≠culo 12, merezcan la calificaci√≥n de graves, y sin que estas a su vez puedan ser calificadas como faltas leves.", "Grave"],

        // Faltas Leves (retomadas de la versi√≥n anterior)
        ["El retraso o la negligencia en el cumplimiento de las funciones y √≥rdenes recibidas.", "Leve"],
        ["La incorrecci√≥n con los ciudadanos, o con otros miembros de los Cuerpos y Fuerzas de Seguridad, siempre que no merezcan una calificaci√≥n m√°s grave.", "Leve"],
        ["La inasistencia al servicio que no constituya falta de mayor gravedad y el incumplimiento de la jornada de trabajo, as√≠ como las faltas repetidas de puntualidad, en los 30 d√≠as precedentes.", "Leve"],
        ["El mal uso o el descuido en la conservaci√≥n de los locales, del material o de los dem√°s elementos de los servicios, as√≠ como el incumplimiento de las normas dadas en esta materia, cuando no constituya falta m√°s grave.", "Leve"],
        ["Dar lugar al extrav√≠o, p√©rdida o sustracci√≥n por simple negligencia, de los distintivos de identificaci√≥n, del arma reglamentaria u otros medios o recursos destinados a la funci√≥n policial.", "Leve"],
        ["La exhibici√≥n de los distintivos de identificaci√≥n sin causa justificada.", "Leve"],
        ["Prescindir del conducto reglamentario para formular cualquier solicitud, reclamaci√≥n o queja relacionada con el servicio, as√≠ como no tramitar las mismas. Quedan exceptuadas del conducto reglamentario aquellas que se formulen por los representantes de las organizaciones sindicales en el ejercicio de la actividad sindical.", "Leve"],
        ["El descuido en el aseo personal y el incumplimiento de las normas sobre la uniformidad, siempre que no constituya falta grave.", "Leve"],
        ["La ausencia injustificada de cualquier servicio, cuando no merezca calificaci√≥n m√°s grave.", "Leve"],
        ["La omisi√≥n intencionada de saludo a un superior, que √©ste no lo devuelva o infringir de otro modo las normas que lo regulan.", "Leve"],
        ["Cualquier clase de juego que se lleve a cabo en las dependencias policiales, siempre que perjudique la prestaci√≥n del servicio o menoscabe la imagen policial.", "Leve"],
        ["Ostentar insignias, condecoraciones u otros distintivos, sin estar autorizado para ello, siempre que no merezca una calificaci√≥n m√°s grave.", "Leve"],
        ["Haber sido condenado en virtud de sentencia firme por una falta dolosa cuando la infracci√≥n penal cometida cause da√±o a la Administraci√≥n o a los Administrados.", "Leve"],
        ["Aquellas acciones u omisiones tipificadas como faltas graves que, de acuerdo con los criterios que se establecen en el art√≠culo 12, merezcan la calificaci√≥n de leves.", "Leve"]
      ],
      choices: ["Leve", "Grave", "Muy Grave"]
    }
  };

  // --- Funciones de Utilidad ---
  function showScreen(screenId) {
    console.log('DEBUG: showScreen called for:', screenId);
    const screens = document.querySelectorAll('.screen');
    screens.forEach(screen => {
      if (screen) {
        screen.classList.add('hidden');
      }
    });
    const targetScreen = document.getElementById(screenId);
    if (targetScreen) {
      targetScreen.classList.remove('hidden');
      currentScreen = targetScreen; // Actualizar la pantalla actual
      console.log('DEBUG: Screen shown:', screenId);
    } else {
      console.error('ERROR: Target screen not found:', screenId);
    }
    // Asegurarse de que el scroll est√© arriba al cambiar de pantalla
    if (targetScreen && targetScreen.id !== 'gameScreen') {
        targetScreen.scrollTop = 0;
    }
  }

  function showMessage(element, message, type = 'error') {
    if (element) {
      element.textContent = message;
      element.className = 'error-message ' + type;
      console.log(`DEBUG: Message displayed on ${element.id}: ${message} (Type: ${type})`);
    } else {
      console.error('ERROR: Element for showMessage not found.');
    }
  }

  function clearMessage(element) {
    if (element) {
      element.textContent = '';
      element.className = 'error-message'; // Restablece la clase base
      console.log(`DEBUG: Message cleared on ${element.id}.`);
    } else {
      console.error('ERROR: Element for clearMessage not found.');
    }
  }

  // --- Funciones de Navegaci√≥n y L√≥gica Principal ---
  function login() {
    console.log('DEBUG: Login function called.');
    clearMessage(loginError);
    const username = usernameInput ? usernameInput.value.trim() : '';
    const password = passwordInput ? passwordInput.value.trim() : '';

    console.log('DEBUG: Username entered:', username);
    console.log('DEBUG: Password entered:', password ? '********' : ''); // No logear la contrase√±a real

    if (username === 'admin' && password === 'admin') {
      console.log('DEBUG: Admin login successful.');
      loggedInUser = username;
      showMenu('Bienvenido, ' + loggedInUser);
      // Mostrar tarjetas de admin si es necesario
      if (gameStatsCard) gameStatsCard.style.display = 'flex';
      if (gameGenerateTestCard) gameGenerateTestCard.style.display = 'flex';
      if (gameChatCard) gameChatCard.style.display = 'flex';
    } else if (username === 'user' && password === 'user') {
      console.log('DEBUG: User login successful.');
      loggedInUser = username;
      showMenu('Bienvenido, ' + loggedInUser);
      // Ocultar tarjetas de admin para usuarios normales
      if (gameStatsCard) gameStatsCard.style.display = 'none';
      if (gameGenerateTestCard) gameGenerateTestCard.style.display = 'none';
      if (gameChatCard) gameChatCard.style.display = 'none';
    } else {
      console.log('DEBUG: Login failed: Incorrect credentials.');
      showMessage(loginError, 'Usuario o contrase√±a incorrectos. Intenta con "admin/admin" o "user/user".');
      if (passwordInput) passwordInput.value = ''; // Limpiar contrase√±a al fallar
    }
  }

  function showMenu(welcomeText) {
    console.log('DEBUG: showMenu called with:', welcomeText);
    showScreen('menuScreen');
    const welcomeDisplay = document.querySelector('#menuScreen .topbar .welcome-text');
    if (welcomeDisplay) {
      welcomeDisplay.textContent = welcomeText;
    } else {
      console.error('ERROR: Welcome text element not found in menu screen.');
    }
  }

  function startGame(gameType) {
    console.log('DEBUG: startGame called for type:', gameType);
    currentGameType = gameType;
    currentQuestions = generateQuestions(gameType, numQuestionsInput ? parseInt(numQuestionsInput.value) : 10);
    if (currentQuestions.length === 0) {
      showMessage(generateTestError, 'No se pudieron generar preguntas con los criterios seleccionados.');
      console.error('ERROR: No questions generated for game type:', gameType);
      return;
    }
    currentQuestionIndex = 0;
    userAnswers = {};
    correctAnswersCount = 0;
    showScreen('gameScreen');
    if (gameTitleDisplay) {
        gameTitleDisplay.textContent = gameData[gameType].title;
    } else {
        console.error('ERROR: gameTitleDisplay element not found.');
    }
    startQuizTimer(testTimeInput ? parseInt(testTimeInput.value) : 10);
    displayQuestion();
  }

  function displayQuestion() {
    console.log('DEBUG: displayQuestion called. Current index:', currentQuestionIndex);
    clearMessage(resultMessage);
    if (currentQuestions.length === 0) {
      if (questionText) questionText.textContent = 'No hay preguntas disponibles.';
      if (choicesContainer) choicesContainer.innerHTML = '';
      return;
    }

    const question = currentQuestions[currentQuestionIndex];
    if (questionText) {
        questionText.textContent = `${currentQuestionIndex + 1}. ${question[0]}`;
    } else {
        console.error('ERROR: questionText element not found.');
    }

    if (choicesContainer) {
        choicesContainer.innerHTML = '';
        // Mezclar las opciones para cada pregunta
        const shuffledChoices = shuffleArray([...gameData[currentGameType].choices]);
        
        shuffledChoices.forEach((choice, index) => {
            const button = document.createElement('button');
            button.textContent = choice;
            button.dataset.choice = choice; // Guardar la opci√≥n en un dataset
            button.onclick = () => selectAnswer(choice); // Pasar la opci√≥n seleccionada
            choicesContainer.appendChild(button);
        });
    } else {
        console.error('ERROR: choicesContainer element not found.');
    }

    // Resaltar respuesta seleccionada previamente y deshabilitar botones si ya se respondi√≥
    if (userAnswers[currentQuestionIndex] !== undefined) {
      const buttons = choicesContainer ? choicesContainer.querySelectorAll('button') : [];
      const selectedChoice = userAnswers[currentQuestionIndex];
      const correctAnswer = currentQuestions[currentQuestionIndex][1];

      buttons.forEach(button => {
        button.disabled = true;
        if (button.dataset.choice === correctAnswer) {
          button.classList.add('correct');
        } else if (button.dataset.choice === selectedChoice) {
          button.classList.add('incorrect');
        }
      });
    }

    updateNavButtons();
  }

  function selectAnswer(selectedChoice) { // Recibe la opci√≥n directamente
    console.log('DEBUG: selectAnswer called with:', selectedChoice);
    const question = currentQuestions[currentQuestionIndex];
    const correctAnswer = question[1];
    
    userAnswers[currentQuestionIndex] = selectedChoice;

    const buttons = choicesContainer ? choicesContainer.querySelectorAll('button') : [];
    buttons.forEach(button => {
      button.disabled = true; // Deshabilita todos los botones una vez que se selecciona una respuesta
      if (button.dataset.choice === correctAnswer) {
        button.classList.add('correct');
      } else if (button.dataset.choice === selectedChoice) {
        button.classList.add('incorrect');
      }
    });

    if (selectedChoice === correctAnswer) {
      showMessage(resultMessage, '¬°Respuesta Correcta! ‚úÖ', 'success');
    } else {
      showMessage(resultMessage, `Incorrecto. La respuesta correcta era: "${correctAnswer}" ‚ùå`, 'error');
      // Registrar pregunta incorrecta
      const qKey = `${currentGameType}-${question[0]}`;
      // Almacenar la pregunta, la respuesta correcta y la respuesta del usuario
      if (!incorrectQuestionsStats[qKey]) {
          incorrectQuestionsStats[qKey] = {
              questionText: question[0],
              correctAnswer: correctAnswer,
              timesFailed: 0
          };
      }
      incorrectQuestionsStats[qKey].timesFailed++;
      localStorage.setItem('incorrectQuestionsStats', JSON.stringify(incorrectQuestionsStats));
    }
    updateNavButtons(); // Permite navegaci√≥n inmediata si se selecciona respuesta
  }

  function updateNavButtons() {
    console.log('DEBUG: updateNavButtons called.');
    if (prevBtn) {
      prevBtn.disabled = currentQuestionIndex === 0;
    } else { console.error('ERROR: prevBtn not found.'); }

    if (nextBtn) {
      if (currentQuestionIndex === currentQuestions.length - 1) {
        nextBtn.textContent = 'Finalizar Test';
        nextBtn.onclick = finishQuiz;
        nextBtn.disabled = userAnswers[currentQuestionIndex] === undefined; // Deshabilitar si no ha respondido la √∫ltima
      } else {
        nextBtn.textContent = 'Siguiente ‚Üí';
        nextBtn.onclick = showNextQuestion;
        nextBtn.disabled = userAnswers[currentQuestionIndex] === undefined; // Deshabilitar si no ha respondido la actual
      }
    } else { console.error('ERROR: nextBtn not found.'); }
  }

  function showNextQuestion() {
    console.log('DEBUG: showNextQuestion called.');
    if (currentQuestionIndex < currentQuestions.length - 1) {
      currentQuestionIndex++;
      displayQuestion();
    } else {
        finishQuiz(); // Si es la √∫ltima pregunta, finalizar
    }
  }

  function showPreviousQuestion() {
    console.log('DEBUG: showPreviousQuestion called.');
    if (currentQuestionIndex > 0) {
      currentQuestionIndex--;
      displayQuestion();
    }
  }

  function finishQuiz() {
    console.log('DEBUG: finishQuiz called.');
    stopTimer(); // Asegurarse de detener el temporizador
    correctAnswersCount = 0;
    for (let i = 0; i < currentQuestions.length; i++) {
      const selectedAnswer = userAnswers[i];
      if (selectedAnswer !== undefined && selectedAnswer === currentQuestions[i][1]) {
        correctAnswersCount++;
      }
    }

    if (finalScoreDisplay) {
        finalScoreDisplay.textContent = `Test Finalizado. Puntuaci√≥n: ${correctAnswersCount} / ${currentQuestions.length}`;
        finalScoreDisplay.classList.remove('hidden');
    } else { console.error('ERROR: finalScoreDisplay not found.'); }
    
    if (prevBtn) prevBtn.disabled = true;
    if (nextBtn) {
        nextBtn.disabled = true;
        nextBtn.textContent = 'Finalizado';
    }
  }

  function stopTimer() {
    console.log('DEBUG: stopTimer called.');
    if (quizInterval) {
      clearInterval(quizInterval);
      quizInterval = null;
    }
    if (timerDisplay) {
        timerDisplay.classList.add('hidden');
    } else { console.error('ERROR: timerDisplay not found.'); }
  }

  function startQuizTimer(durationInMinutes) {
    console.log('DEBUG: startQuizTimer called with duration:', durationInMinutes);
    stopTimer(); // Asegurarse de que no haya un temporador anterior
    quizStartTime = Date.now();
    const endTime = quizStartTime + durationInMinutes * 60 * 1000;

    if (timerDisplay) {
        timerDisplay.classList.remove('hidden');
    } else { console.error('ERROR: timerDisplay not found for starting timer.'); }

    quizInterval = setInterval(() => {
      const timeLeft = endTime - Date.now();
      if (timeLeft <= 0) {
        clearInterval(quizInterval);
        if (timerDisplay) {
            timerDisplay.textContent = '00:00';
        }
        finishQuiz();
        return;
      }
      const totalSeconds = Math.floor(timeLeft / 1000);
      const minutesLeft = Math.floor(totalSeconds / 60);
      const secondsLeft = totalSeconds % 60;
      const formattedTime = `${String(minutesLeft).padStart(2, '0')}:${String(secondsLeft).padStart(2, '0')}`;
      if (timerDisplay) {
          timerDisplay.textContent = formattedTime;
      }
    }, 1000);
  }

  function showStats() {
    console.log('DEBUG: showStats called.');
    showScreen('statsScreen');
    if (statsContent) {
        statsContent.innerHTML = ''; // Limpiar contenido anterior
        let hasData = false;
        for (const qKey in incorrectQuestionsStats) {
            if (incorrectQuestionsStats.hasOwnProperty(qKey)) {
                hasData = true;
                const data = incorrectQuestionsStats[qKey];
                const gameType = qKey.split('-')[0]; // Extraer el tipo de juego
                const questionText = data.questionText;
                const correctAnswer = data.correctAnswer;
                const timesFailed = data.timesFailed;

                const gameTitle = gameData[gameType] ? gameData[gameType].title : 'Desconocido';

                let gameSection = document.getElementById(`stats-section-${gameType}`);
                if (!gameSection) {
                    gameSection = document.createElement('div');
                    gameSection.id = `stats-section-${gameType}`;
                    gameSection.innerHTML = `<h3>${gameTitle}</h3><ul></ul>`;
                    statsContent.appendChild(gameSection);
                }
                const ul = gameSection.querySelector('ul');
                const li = document.createElement('li');
                li.innerHTML = `<strong>Pregunta:</strong> ${questionText}<br>
                                <strong>Respuesta Correcta:</strong> ${correctAnswer}<br>
                                <strong>Veces Fallada:</strong> ${timesFailed} veces`;
                ul.appendChild(li);
            }
        }

        if (!hasData) {
            statsContent.innerHTML = '<p class="no-data">A√∫n no hay preguntas falladas registradas.</p>';
        }
    } else { console.error('ERROR: statsContent not found.'); }
  }

  function showGenerateTest() {
    console.log('DEBUG: showGenerateTest called.');
    showScreen('generateTestScreen');
    clearMessage(generateTestError);
    // Reiniciar checkboxes a un estado por defecto si es necesario
    if (jefeDirectorCheckbox) jefeDirectorCheckbox.checked = false;
    if (loexCheckbox) loexCheckbox.checked = false;
    if (lo42010Checkbox) lo42010Checkbox.checked = false;
    if (numQuestionsInput) numQuestionsInput.value = 10;
    if (testTimeInput) testTimeInput.value = 10;
  }

  function generateCustomTest() {
    console.log('DEBUG: generateCustomTest called.');
    clearMessage(generateTestError);
    const selectedTypes = [];
    if (jefeDirectorCheckbox && jefeDirectorCheckbox.checked) selectedTypes.push('jefeDirector');
    if (loexCheckbox && loexCheckbox.checked) selectedTypes.push('loex');
    if (lo42010Checkbox && lo42010Checkbox.checked) selectedTypes.push('lo42010');

    if (selectedTypes.length === 0) {
      showMessage(generateTestError, 'Selecciona al menos un tipo de juego.', 'error');
      console.error('ERROR: No game types selected for custom test.');
      return;
    }

    const numQuestions = numQuestionsInput ? parseInt(numQuestionsInput.value) : 0;
    const testTime = testTimeInput ? parseInt(testTimeInput.value) : 0;

    if (isNaN(numQuestions) || numQuestions <= 0) {
      showMessage(generateTestError, 'N√∫mero de preguntas inv√°lido.', 'error');
      console.error('ERROR: Invalid number of questions:', numQuestions);
      return;
    }
    if (isNaN(testTime) || testTime <= 0) {
      showMessage(generateTestError, 'Tiempo l√≠mite inv√°lido.', 'error');
      console.error('ERROR: Invalid test time:', testTime);
      return;
    }

    // Generar preguntas de los tipos seleccionados
    let allPossibleQuestions = [];
    selectedTypes.forEach(type => {
      if (gameData[type] && gameData[type].questions) {
        allPossibleQuestions = allPossibleQuestions.concat(gameData[type].questions);
      } else {
          console.warn('WARNING: Game data not found for type:', type);
      }
    });

    if (allPossibleQuestions.length < numQuestions) {
      showMessage(generateTestError, `No hay suficientes preguntas (${allPossibleQuestions.length}) para generar un test de ${numQuestions} preguntas.`, 'error');
      console.error('ERROR: Not enough questions available for custom test.');
      return;
    }

    // Mezclar y seleccionar un subconjunto de preguntas
    const shuffledQuestions = shuffleArray(allPossibleQuestions);
    const finalQuestions = shuffledQuestions.slice(0, numQuestions);

    // Iniciar el juego con las preguntas generadas
    currentGameType = 'test'; // Usar 'test' para el modo de prueba personalizada
    gameData.test = { // Definir un tipo de juego 'test' temporalmente
        title: "Evaluaci√≥n Personalizada",
        questions: finalQuestions,
        // Las opciones deben ser una combinaci√≥n de todas las opciones posibles de los juegos seleccionados
        choices: Array.from(new Set(selectedTypes.flatMap(type => gameData[type].choices)))
    };

    startGame('test');
  }

  function generateQuestions(type, count) {
    if (!gameData[type] || !gameData[type].questions) {
      console.error('ERROR: Tipo de juego no encontrado en generateQuestions:', type);
      return [];
    }
    const allQuestions = gameData[type].questions;
    const shuffled = allQuestions.sort(() => 0.5 - Math.random());
    return shuffled.slice(0, count);
  }

  function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  // --- Funciones de Chat ---
  function showChatLogin() {
    console.log('DEBUG: showChatLogin called.');
    showScreen('chatLoginScreen');
    clearMessage(chatLoginError);
    if (chatUsernameInput) {
        chatUsernameInput.value = '';
    }
  }

  function connectChat() {
    console.log('DEBUG: connectChat called.');
    clearMessage(chatLoginError);
    const username = chatUsernameInput ? chatUsernameInput.value.trim() : '';
    if (username.length < 3) {
      showMessage(chatLoginError, 'El identificador de agente debe tener al menos 3 caracteres.', 'error');
      console.error('ERROR: Chat username too short.');
      return;
    }
    chatUsername = username;
    showScreen('groupChatScreen');
    if (chatMessagesContainer) {
        chatMessagesContainer.innerHTML = ''; // Limpiar mensajes anteriores
    }
    chatMessages = []; // Resetear el historial de chat
    appendChatMessage('Sistema', `Bienvenido al chat de operaciones, ${chatUsername}.`, 'system-message');
  }

  function appendChatMessage(sender, message, type = 'other-message') {
    if (!chatMessagesContainer) {
        console.error('ERROR: chatMessagesContainer not found for appending message.');
        return;
    }

    const messageElement = document.createElement('div');
    messageElement.classList.add('chat-message');
    if (type === 'own-message') {
        messageElement.classList.add('own-message');
    } else if (type === 'system-message') {
        messageElement.classList.add('system-message');
        messageElement.style.cssText = `
            background: #202028;
            color: var(--color-text-muted);
            font-size: 0.85em;
            text-align: center;
            border: 1px dashed var(--color-border);
            border-radius: 4px;
            padding: 0.5rem;
            margin: 0.5rem auto;
            max-width: 90%;
        `;
        messageElement.innerHTML = `<em>${message}</em>`;
    } else {
        messageElement.classList.add('other-message');
    }

    if (type !== 'system-message') {
        const senderElement = document.createElement('span');
        senderElement.classList.add('message-sender');
        senderElement.textContent = sender;
        
        const textElement = document.createElement('span');
        textElement.textContent = message;

        messageElement.appendChild(senderElement);
        messageElement.appendChild(textElement);
    }

    chatMessagesContainer.appendChild(messageElement);
    chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight; // Scroll autom√°tico
    chatMessages.push({ sender, message, type }); // Guardar para historial simulado
    console.log('DEBUG: Chat message appended:', {sender, message, type});
  }

  function sendChatMessage() {
    console.log('DEBUG: sendChatMessage called.');
    const message = chatMessageInput ? chatMessageInput.value.trim() : '';
    if (message.length === 0) {
        console.warn('WARNING: Attempted to send empty chat message.');
        return;
    }

    appendChatMessage(chatUsername, message, 'own-message');
    if (chatMessageInput) {
        chatMessageInput.value = '';
    }

    // Simular respuesta del sistema o de otro agente
    setTimeout(() => {
      const responses = [
        "Mensaje recibido. Procesando solicitud...",
        "Entendido, Agente. Reconfigurando par√°metros.",
        "Confirmado. El equipo est√° en ello.",
        "Negativo, Agente. Se requiere m√°s informaci√≥n.",
        "Afirmativo. Operaci√≥n en curso."
      ];
      const randomResponse = responses[Math.floor(Math.random() * responses.length)];
      appendChatMessage('Sistema', randomResponse, 'other-message');
    }, 1500);
  }


  // --- Inicializaci√≥n y Event Listeners ---
  document.addEventListener('DOMContentLoaded', () => {
    console.log('DEBUG: DOM Content Loaded. Initializing app.');
    // Inicializar el sistema mostrando la pantalla de login
    showScreen('loginScreen'); // Usar showScreen para la primera visualizaci√≥n

    if (loginBtn) {
      console.log('DEBUG: Attaching click listener to loginBtn.');
      loginBtn.addEventListener('click', login);
    } else {
      console.error('ERROR: Login button (loginBtn) not found!');
    }
    if (usernameInput) {
      usernameInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
              console.log('DEBUG: Enter pressed on username input. Calling login().');
              login();
          }
      });
    }
    if (passwordInput) {
      passwordInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
              console.log('DEBUG: Enter pressed on password input. Calling login().');
              login();
          }
      });
    }

    // Adjuntar listeners a los botones de navegaci√≥n y tarjetas de juego
    if (logoutBtn) { logoutBtn.addEventListener('click', () => { loggedInUser = null; localStorage.removeItem('incorrectQuestionsStats'); incorrectQuestionsStats = {}; showScreen('loginScreen'); console.log('DEBUG: Logged out.'); }); }
    if (backToMenuBtn) { backToMenuBtn.addEventListener('click', () => showMenu('Bienvenido, ' + (loggedInUser || 'Agente'))); }
    if (backToMenuFromStatsBtn) { backToMenuFromStatsBtn.addEventListener('click', () => showMenu('Bienvenido, ' + (loggedInUser || 'Agente'))); }
    if (backToMenuFromGenerateTestBtn) { backToMenuFromGenerateTestBtn.addEventListener('click', () => showMenu('Bienvenido, ' + (loggedInUser || 'Agente'))); }
    if (backToMenuFromChatLoginBtn) { backToMenuFromChatLoginBtn.addEventListener('click', () => showMenu('Bienvenido, ' + (loggedInUser || 'Agente'))); }
    if (backToMenuFromGroupChatBtn) { backToMenuFromGroupChatBtn.addEventListener('click', () => showMenu('Bienvenido, ' + (loggedInUser || 'Agente'))); }

    if (gameJefeDirectorCard) { gameJefeDirectorCard.addEventListener('click', () => startGame('jefeDirector')); } else { console.error('ERROR: gameJefeDirectorCard not found.'); }
    if (gameLOEXCard) { gameLOEXCard.addEventListener('click', () => startGame('loex')); } else { console.error('ERROR: gameLOEXCard not found.'); }
    if (gameLO42010Card) { gameLO42010Card.addEventListener('click', () => startGame('lo42010')); } else { console.error('ERROR: gameLO42010Card not found.'); }
    if (gameStatsCard) { gameStatsCard.addEventListener('click', showStats); } else { console.error('ERROR: gameStatsCard not found.'); }
    if (gameGenerateTestCard) { gameGenerateTestCard.addEventListener('click', showGenerateTest); } else { console.error('ERROR: gameGenerateTestCard not found.'); }
    if (gameChatCard) { gameChatCard.addEventListener('click', showChatLogin); } else { console.error('ERROR: gameChatCard not found.'); }

    if (prevBtn) { prevBtn.addEventListener('click', showPreviousQuestion); } else { console.error('ERROR: prevBtn not found.'); }
    if (nextBtn) { nextBtn.addEventListener('click', showNextQuestion); } else { console.error('ERROR: nextBtn not found.'); } // La l√≥gica de click se actualiza din√°micamente en updateNavButtons
    if (generateTestBtn) { generateTestBtn.addEventListener('click', generateCustomTest); } else { console.error('ERROR: generateTestBtn not found.'); }
    if (connectChatBtn) { connectChatBtn.addEventListener('click', connectChat); } else { console.error('ERROR: connectChatBtn not found.'); }
    if (sendChatMessageBtn) { sendChatMessageBtn.addEventListener('click', sendChatMessage); } else { console.error('ERROR: sendChatMessageBtn not found.'); }
    if (chatMessageInput) {
      chatMessageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendChatMessage();
        }
      });
    } else { console.error('ERROR: chatMessageInput not found.'); }
  });

})(); // Fin de la IIFE (Immediately Invoked Function Expression)
</script>
</body>
</html>
